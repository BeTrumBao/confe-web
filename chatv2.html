<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Confe Messenger</title>
    <link rel="icon" type="image/png" href="Res/favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        :root {
            --accent-1: #0084ff;
            --accent-2: #2563eb;
            --bg-page: linear-gradient(135deg, #0f172a, #1e293b);
            --glass: rgba(255, 255, 255, 0.06);
            --glass-2: rgba(255, 255, 255, 0.08);
            --glass-3: rgba(30, 41, 59, 0.75);
            --text: #e5e7eb;

            --text-2: #cbd5e1;

            --border: rgba(255, 255, 255, 0.12);
            --bubble-me: linear-gradient(135deg, #3b82f6, #2563eb);
            --bubble-you: rgba(255, 255, 255, 0.15);
            --input: #0b1220;
            --shadow: 0 18px 60px rgba(0, 0, 0, .35);
            --recalled-bg: rgba(255, 255, 255, 0.1);
            --skeleton-bg: rgba(255, 255, 255, 0.08);
            --background-1: #1e293b;

            --text-1: #f1f5f9;

            --primary: #2563eb;
            --primary-hover: #3b82f6;
            --white: #ffffff;
            --hover-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-nav: #111827;
            --bg-light: #1e293b;

            --bg-dark: #0f172a;
            --text-secondary: #94a3b8;
            --text-primary: #e5e7eb;
            --input-bg: #0b1220;
            --bg-card: rgba(255, 255, 255, 0.05);
        }

        .light {
            --accent-1: #0084ff;
            --bg-page: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            --glass: rgba(255, 255, 255, 0.5);
            --glass-2: rgba(255, 255, 255, 0.6);
            --glass-3: rgb(249, 250, 251);
            --text: #0f172a;

            --text-2: #334155;

            --border: rgba(0, 0, 0, 0.1);
            --bubble-me: linear-gradient(135deg, #007aff, #0056b3);
            --bubble-you: rgba(229, 229, 234, 0.92);
            --input: rgba(255, 255, 255, 0.85);
            --shadow: 0 18px 60px rgba(0, 0, 0, .2);
            --recalled-bg: rgba(0, 0, 0, 0.05);
            --skeleton-bg: rgba(0, 0, 0, 0.08);
            --background-1: #f9fafb;

            --text-1: #1f2937;

            --hover-bg: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
            --bg-nav: #ffffff;
            --bg-light: #f9fafb;
            --bg-dark: #f3f4f6;
            --text-secondary: #6b7280;
            --text-primary: #1f2937;
            --input-bg: #ffffff;
            --bg-card: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: 'Outfit', system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: var(--bg-page);
            color: var(--text);
            overflow: hidden;
            display: flex;
        }

        button {
            font-family: inherit;
        }

        input,
        textarea {
            font-family: inherit;
        }

        svg {
            vertical-align: middle;
        }

        .app-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .app-nav {
            width: 70px;
            background-color: var(--bg-nav);
            border-right: 1px solid var(--glass-border);
            padding: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            position: relative;
        }

        .nav-button {
            background-color: transparent;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 15px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .nav-button svg {
            width: 24px;
            height: 24px;
        }

        .nav-button:hover {
            background-color: var(--accent-1);
            color: #fff;
            border-radius: 12px;
        }

        .nav-button.active {
            background-color: var(--accent-2);
            color: #fff;
            border-radius: 12px;
        }

        .nav-button.active::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 5px;
            bottom: 5px;
            width: 4px;
            background-color: #fff;
            border-radius: 0 4px 4px 0;
        }

        .light .nav-button {
            background-color: #e5e7eb;
            color: var(--text-secondary);
        }

        .light .nav-button:hover {
            background-color: var(--accent-1);
            color: #fff;
        }

        .light .nav-button.active {
            background-color: var(--accent-2);
            color: #fff;
        }

        .light .nav-button.active::before {
            background-color: var(--accent-2);
        }

        .nav-spacer {
            flex-grow: 1;
        }

        .nav-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--glass-border);
            cursor: pointer;
            margin-bottom: 10px;
        }

        #nav-settings-menu {
            position: absolute;
            bottom: 75px;
            left: 80px;
            width: 220px;
            display: none;
            background: var(--glass-3);
            backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 101;
        }

        .light #nav-settings-menu .settings-row {
            color: var(--text-primary);
        }

        .app-main {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-light);
        }

        .app-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            height: 100%;
            width: 100%;
        }

        .app-view.active {
            display: block;
        }

        .chat-view .container {
            width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
            box-shadow: none;
            margin-top: 0;
            background: none;
            backdrop-filter: none;
            display: flex;
        }

        .chat-view #sidebar {
            height: 100%;
            width: 36%;
            max-width: 420px;
            background: var(--bg-light);
            border-right: 1px solid var(--glass-border);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
        }

        .chat-view #chat-window {
            height: 100%;
            flex: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
        }

        .chat-view .sidebar-footer {
            display: none !important;
        }

        .sidebar-head {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 10px;
            position: relative
        }

        .sidebar-title {
            font-size: 22px;
            font-weight: 700
        }

        #add-btn {
            background: var(--glass-border);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
            position: relative;
            z-index: 30;
        }

        #add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        #add-menu {
            position: absolute;
            left: auto;
            right: 16px;
            top: 60px;
            width: 180px;
            height: auto !important;
            display: none;
            background: var(--glass-3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 20;
            backdrop-filter: blur(18px);
        }

        #sidebar-search-container {
            position: relative;
            padding-bottom: 10px;
        }

        #global-search {
            width: 100%;
            padding: 12px 16px;
            border: none;
            outline: none;
            border-radius: 12px;
            background: var(--input);
            color: var(--text);
            font-size: 14px;
        }

        #search-dropdown {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            width: auto;
            margin: 0;
            background: var(--glass-3);
            border: 1px solid var(--border);
            border-radius: 16px;
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow);
            max-height: 52vh;
            overflow: auto;
            display: none;
            padding: 6px 6px 10px;
            z-index: 100;
        }

        .section-title {
            font-size: 12px;
            opacity: .8;
            margin: 8px 6px
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
        }

        .result-item:hover {
            background: var(--glass)
        }

        .result-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0
        }

        .result-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border)
        }

        .result-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .result-sub {
            font-size: 12px;
            color: var(--text-2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .result-actions {
            display: flex;
            gap: 8px
        }

        .result-action {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .add-friend-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }

        .add-friend-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .add-friend-btn:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: default;
            opacity: 0.7;
            transform: none;
        }

        .friend-label {
            font-size: 13px;
            opacity: 0.7;
        }

        .list-title {
            font-size: 13px;
            color: var(--text-2);
            margin: 4px 0
        }

        ul {
            list-style: none
        }

        #chat-list {
            overflow: auto;
            max-height: calc(100vh - 200px);
            padding-right: 6px
        }

        .item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
        }

        .item:hover {
            background: var(--glass)
        }

        .item-left {
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .item-name {
            white-space: normal;
            word-break: break-word;
        }

        .item-last-msg {
            font-size: 13px;
            color: var(--text-2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .beta-tag {
            font-size: 10px;
            background-color: #f59e0b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sidebar-loader .skeleton-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
        }

        .skeleton {
            background: var(--skeleton-bg);
            position: relative;
            overflow: hidden;
        }

        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-line {
            height: 16px;
            border-radius: 6px;
            flex: 1;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        #sidebar-lists {
            display: none;
        }

        #sidebar.loaded #sidebar-lists {
            display: block;
        }

        #sidebar.loaded #sidebar-loader {
            display: none;
        }

        .settings-menu {
            display: none;
            background: var(--glass-3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 20;
            backdrop-filter: blur(18px);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
        }

        .settings-row:hover {
            background: var(--glass)
        }

        .switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 999px
        }

        .switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            top: 2px;
            left: 3px;
            transition: .2s;
        }

        .switch.on::after {
            left: 23px
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--accent-1), #a855f7, #ec4899);

            -webkit-background-clip: text;

            background-clip: text;

            -webkit-text-fill-color: transparent;

            color: transparent;

            display: inline-block;

        }

        .light .gradient-text {
            background: linear-gradient(90deg, #007aff, #5856d6, #ff2d55);

            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }
        #chat-window {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            box-sizing: border-box;
        }

        #chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        #current-chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        #chat-header-info {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #current-chat-friend-name {
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #peer-info-extra {
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }

        .stranger-label {
            font-size: 12px;
            color: var(--text-2);
        }

        #add-friend-header-btn {
            padding: 3px 8px;
            font-size: 11px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        #add-friend-header-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        #add-friend-header-btn:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: default;
            opacity: 0.7;
            transform: none;
        }

        #chat-header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        #open-info-btn,
        #group-info-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            line-height: 1;
        }

        #open-info-btn:hover,
        #group-info-btn:hover {
            background-color: var(--glass);
        }


        #messages-container {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 14px 15px;
            scrollbar-width: thin;
        }

        #messages-container::-webkit-scrollbar {
            width: 8px
        }

        #messages-container::-webkit-scrollbar-thumb {
            background: var(--glass-3);
            border-radius: 10px
        }

        #messages-container::-webkit-scrollbar-track {
            background: transparent
        }

        .msg-wrapper {
            position: relative;
            margin: 6px 0;
            align-self: flex-start;
            max-width: 70%;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .msg-wrapper:hover .reaction-picker {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .msg-wrapper.sent {
            align-self: flex-end;
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .msg-wrapper.sent .msg-avatar {
            display: none;
        }

        .msg-sender-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-2);
            margin-bottom: 4px;
        }

        .msg {
            background: var(--bubble-you);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 18px;
            display: inline-block;
            word-break: break-word;
            line-height: 1.4em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: background 0.3s ease;
            position: relative;
        }

        .msg.sent {
            background: var(--bubble-me);
            color: #fff;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
        }

        .msg img {
            max-width: 100%;
            border-radius: 14px;
            margin-top: 5px;
            cursor: pointer;
        }

        .msg-meta,
        .msg-status {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            margin-top: 4px;
        }

        .sent .msg-status {
            color: rgba(255, 255, 255, 0.7);
        }

        .recalled-message {
            font-style: italic;
            color: var(--text-2);
            background-color: var(--recalled-bg);
            border: 1px dashed var(--border);
            padding: 8px 12px;
            border-radius: 12px;
        }

        .reply-quote {
            background: var(--glass);
            padding: 6px 10px;
            border-left: 3px solid var(--accent-1);
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .reply-quote .sender {
            font-weight: 600;
            font-size: 13px;
        }

        .reply-quote .text {
            font-size: 13px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .edited-label {
            margin-left: 6px;
            font-style: italic;
            opacity: 0.8;
            font-size: 10px;
        }

        .message-date-separator {
            text-align: center;
            margin: 18px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
            width: 100%;
        }

        .message-date-separator::before,
        .message-date-separator::after {
            content: "";
            position: relative;
            display: inline-block;
            width: 30%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            top: -3px;
            margin: 0 8px;
        }

        .msg-wrapper.mentioned-me .msg {
            background-color: rgba(96, 165, 250, 0.25);
            border: 1px solid var(--accent-1);
        }

        .light .msg-wrapper.mentioned-me .msg {
            background-color: rgba(0, 122, 255, 0.15);
            border: 1px solid var(--accent-2);
        }

        .mention {
            font-weight: 600;
            color: var(--accent-1);
            background-color: rgba(96, 165, 250, 0.15);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .chat-input {
            display: flex;
            gap: 0;
            align-items: flex-end;
            padding: 15px;
            margin-top: auto;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        #message-input {
            transition: width 0.3s ease;
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 14px;
            background: var(--input);
            color: var(--text);
            margin: 0 10px;
        }

        .image-upload-label {
            background: transparent;
            color: var(--accent-1);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        #send-btn {
            width: 0;
            padding: 12px 0;
            margin: 0;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: #fff;
            transform: scale(0.8);
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input.has-text #send-btn {
            width: 48px;
            padding: 12px;
            transform: scale(1);
            opacity: 1;
        }

        #send-btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        #send-btn .spinner-icon {
            display: none;
        }

        #send-btn.loading {
            cursor: wait;
        }

        #send-btn.loading .send-icon {
            display: none;
        }

        #send-btn.loading .spinner-icon {
            display: block;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #typing-indicator {
            height: 22px;
            font-size: 13px;
            font-style: italic;
            color: var(--text-2);
            padding: 0 15px;
        }

        #image-preview-container,
        #reply-preview-container,
        #edit-preview-container {
            display: none;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            margin: 0 15px 8px 15px;
            position: relative;
        }

        #image-preview {
            max-height: 130px;
            border-radius: 8px
        }

        #cancel-preview-btn {
            position: absolute;
            right: -6px;
            top: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: none;
            background: #111;
            color: #fff;
            cursor: pointer
        }

        #reply-preview-container {
            border-left: 3px solid var(--accent-1);
        }

        #edit-preview-container {
            border-left: 3px solid #f59e0b;
        }

        #reply-preview-sender,
        #edit-preview-title {
            font-weight: 600;
            font-size: 13px;
        }

        #edit-preview-title {
            color: #f59e0b;
        }

        #reply-preview-text,
        #edit-preview-text {
            font-size: 13px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #edit-preview-text {
            font-style: italic;
        }

        #cancel-reply-btn,
        #cancel-edit-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-2);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        #inactive-chat-indicator {
            text-align: center;
            padding: 12px;
            margin: 15px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.15);
            color: var(--text-2);
            font-style: italic;
            font-size: 14px;
            border: 1px solid var(--border);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            display: none;

            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .modal-close-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
            z-index: 10;
        }

        .modal-close-icon:hover {
            background: var(--hover-bg);
            color: var(--text-1);
        }

        .modal-content {
            position: relative;
            background: rgba(22, 25, 35, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px 35px;
            width: min(90vw, 520px);
            color: #fff;
            text-align: left;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeIn .3s ease;
        }

        .light .modal-content {
            background: var(--glass-3);
            border-color: var(--glass-border);
            color: var(--text-1);
        }

        .light .modal-content input,
        .light .modal-content textarea,
        .light .modal-content select {
            background: var(--input-bg) !important;
            border-color: var(--glass-border) !important;
            color: var(--text-1) !important;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 22px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            background: -webkit-linear-gradient(45deg, var(--accent-1), #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #friend-request-modal .modal-content h2::before {
            content: '';
            font-size: 24px;
            display: inline-block;
            filter: grayscale(100%) contrast(200%);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: #fff;
            cursor: pointer;
        }

        .btn-ghost,
        .cancel-btn {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
        }

        .danger-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .form-label {
            font-size: 14px;
            color: var(--text-2);
            margin-bottom: 6px;
            display: block;
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input);
            color: var(--text);
            outline: none;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .clickable {
            cursor: pointer
        }

        .hidden {
            display: none
        }

        .verified-tick {
            display: inline-block;
            width: 1.1em;
            height: 1.1em;
            margin-left: 5px;
            vertical-align: -0.2em;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2360a5fa'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.06 0l4-5.5z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .suggestion-popup {
            position: absolute;
            bottom: 75px;
            left: 15px;
            right: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--glass-3);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            padding: 6px;
            scrollbar-width: thin;
        }

        .suggestion-popup::-webkit-scrollbar {
            width: 6px;
        }

        .suggestion-popup::-webkit-scrollbar-thumb {
            background: var(--glass);
            border-radius: 6px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: var(--glass);
        }

        .suggestion-item img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .suggestion-item .name {
            font-weight: 500;
        }

        .suggestion-item .all {
            font-weight: 600;
            color: var(--accent-1);
        }

        .lightbox-overlay {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;

            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox-close-btn {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .lightbox-close-btn:hover {
            color: #bbb;
        }

        #friend-request-list {
            max-height: 350px;
            min-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friend-req-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: .2s;
        }

        .friend-req-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: background .2s;
        }

        .friend-req-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .friend-req-name {
            font-weight: 500;
            text-align: left;
        }

        .friend-req-buttons {
            display: flex;
            gap: 6px;
        }

        .accept-btn {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: #fff;
        }

        .reject-btn {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
        }

        .msg-content-wrapper {
            position: relative;
        }

        #group-members-checklist {
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0 20px;
            background: var(--input);
        }

        #group-members-checklist label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }

        #group-members-checklist label:hover {
            background-color: var(--glass);
        }

        #group-members-checklist input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        #message-context-menu {
            position: fixed;
            display: none;
            background: var(--glass-3);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--shadow);
            z-index: 9999;
        }

        .context-menu-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
        }

        .context-menu-btn:hover {
            background: var(--glass);
        }

        .context-menu-btn.danger {
            color: #f43f5e;
        }

        .reaction-picker {
            position: absolute;
            top: -45px;
            background: var(--glass-3);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 6px;
            display: flex;
            gap: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
            z-index: 100;
        }

        .msg-wrapper.sent .reaction-picker {
            right: 10px;
        }

        .msg-wrapper.received .reaction-picker {
            left: 10px;
        }

        .msg-wrapper:hover .reaction-picker {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }

        .reaction-btn {
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .reaction-btn:hover {
            transform: scale(1.2);
        }

        .reactions-display {
            position: absolute;
            bottom: -10px;
            background: var(--glass-2);
            border-radius: 10px;
            padding: 2px 5px;
            display: flex;
            gap: 3px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .msg-wrapper.sent .reactions-display {
            right: 10px;
        }

        .msg-wrapper.received .reactions-display {
            left: 0px;
        }

        #reactions-modal .modal-content {
            text-align: center;
            width: 380px;
        }

        #reactions-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .reaction-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
        }

        .reaction-user-item:hover {
            background: var(--glass);
        }

        .reaction-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reaction-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .reaction-user-name {
            font-weight: 500;
        }

        .reaction-emoji {
            font-size: 20px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10000;
        }

        .toast {
            background: white;
            color: #1A1C1E;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid var(--primary);
        }

        .toast.show {
            transform: translateX(0);
        }

        .report-form .form-label {
            text-align: left;
            margin-bottom: 10px;
        }

        .report-reason-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .report-reason-row:hover {
            background-color: var(--glass);
        }

        .report-reason-row input[type="radio"] {
            display: none;
        }

        .report-reason-row .custom-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            margin-right: 12px;
            display: inline-block;
            position: relative;
            transition: border-color 0.2s;
        }

        .report-reason-row input[type="radio"]:checked+.custom-radio {
            border-color: var(--accent-1);
        }

        .report-reason-row input[type="radio"]:checked+.custom-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-1);
        }

        .report-reason-row.selected {
            background-color: var(--glass);
            border-color: var(--accent-1);
        }

        #messages-container.selection-mode .msg-wrapper {
            cursor: pointer;
            padding: 4px;
            border-radius: 14px;
            border: 2px solid transparent;
            transition: border-color 0.2s, background-color 0.2s;
        }

        #messages-container.selection-mode .msg-wrapper:hover {
            background-color: var(--glass);
        }

        #messages-container.selection-mode .msg-wrapper.selected {
            border-color: var(--accent-1);
            background-color: rgba(96, 165, 250, 0.2);
        }

        #open-info-btn,
        #group-info-btn {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
        }

        #chat-info-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 320px;
            height: 100%;
            background: rgba(22, 25, 35, 0.85);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: -8px 0 25px rgba(0, 0, 0, 0.4);
            color: #f3f4f6;
            transform: translateX(340px);
            transition: transform .3s ease;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        #chat-info-panel.open {
            transform: translateX(0);
        }

        #chat-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        #chat-info-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        #close-info-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            width: 30px;
            height: 30px;
            color: #fff;
            cursor: pointer;
            transition: .2s;
        }

        #close-info-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .chat-info-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-info-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .chat-info-avatar {
            width: 95px;
            height: 95px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
            object-fit: cover;
        }

        .chat-info-name {
            font-size: 18px;
            font-weight: 600;
            margin: 10px 0;
        }

        .chat-info-body h5 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: rgba(255, 255, 255, 0.75);
            margin-bottom: 10px;
            text-align: left;
        }

        .sent-images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 25px;
        }

        .sent-images-grid img {
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .sent-images-grid img:hover {
            transform: scale(1.06);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.5);
        }

        .chat-actions button {
            width: 100%;
            padding: 11px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            color: #fff;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.25s;
        }

        #block-user-btn,
        #unblock-user-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        #unblock-user-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: none;
        }

        #block-user-btn:hover,
        #unblock-user-btn:hover {
            filter: brightness(1.1);
        }

        #remove-friend-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            opacity: 0.9;
        }

        #remove-friend-btn:hover {
            opacity: 1;
            filter: brightness(1.1);
        }

        #leave-group-btn {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        #group-members-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .member-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .member-name {
            font-weight: 500;
        }

        .member-role {
            font-size: 12px;
            opacity: 0.7;
            padding: 2px 6px;
            border-radius: 6px;
            color: white;
        }

        .role-admin {
            background-color: #a855f7;
        }

        .role-moderator {
            background-color: #2563eb;
        }

        .role-member {
            background-color: #4b5563;
        }

        .member-actions button {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-2);
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 4px;
        }

        .member-actions button:hover {
            background: var(--glass-3);
        }

        #group-avatar.editable-group-info,
        #group-name-display.editable-group-info {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #group-avatar.editable-group-info:hover,
        #group-name-display.editable-group-info:hover {
            opacity: 0.7;
        }

        #edit-group-modal .modal-content {
            width: min(90vw, 520px) !important;
            box-sizing: border-box !important;
            padding: 30px 35px !important;
        }

        #edit-group-modal .modal-content>div:first-of-type {
            display: flex !important;
            align-items: flex-start !important;
            gap: 20px !important;
            margin-bottom: 20px !important;
            box-sizing: border-box !important;
        }

        #edit-group-modal .modal-content>div:first-of-type>div:first-child {
            flex-shrink: 0 !important;
            text-align: center !important;
            box-sizing: border-box !important;
        }

        #edit-group-modal #edit-group-avatar-preview {
            width: 95px !important;
            height: 95px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 2px solid var(--border) !important;
            cursor: pointer !important;
            transition: opacity 0.2s !important;
            display: block !important;
            margin: 0 auto !important;
        }

        #edit-group-modal #edit-group-avatar-loading {
            font-size: 13px !important;
            color: var(--accent-1) !important;
            display: none;
            margin-top: 5px !important;
        }

        #edit-group-modal .modal-content>div:first-of-type>div:last-child {
            flex-grow: 1 !important;
            min-width: 0 !important;
            box-sizing: border-box !important;
        }

        #edit-group-modal .modal-content label.form-label {
            display: block !important;
            text-align: left !important;
            margin-bottom: 6px !important;
            font-size: 14px !important;
            color: var(--text-2) !important;
            box-sizing: border-box !important;
        }

        #edit-group-modal .modal-content input[type="text"] {
            width: 100% !important;
            padding: 10px !important;
            border-radius: 8px !important;
            border: 1px solid var(--border) !important;
            background: var(--input) !important;
            color: var(--text) !important;
            outline: none !important;
            font-size: 14px !important;
            margin-bottom: 15px !important;
            box-sizing: border-box !important;
        }

        #edit-group-modal .modal-content label[for="edit-group-avatar-input"] {
            margin-top: 15px !important;
        }

        #edit-group-modal .modal-actions {
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
            margin-top: 20px !important;
            box-sizing: border-box !important;
        }

        .friends-view {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .friends-container h1 {
            font-size: 24px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        #friends-search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--input-bg);
            color: var(--text-primary);
            outline: none;
            font-size: 15px;
            margin-bottom: 20px;
        }

        #friends-tab-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            background-color: var(--bg-nav);
            transition: background-color 0.2s ease;
        }

        .friend-item:hover {
            background-color: var(--hover-bg);
        }

        .friend-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .friend-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        .friend-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
            flex-shrink: 0;
            margin-left: auto;
        }

        .friend-status.online {
            background: #22c55e;
        }

        .friend-item-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
        }

        .light .friend-item {
            background-color: var(--bg-card);
        }

        .light .friend-item:hover {
            background-color: var(--hover-bg);
        }

        .light #friends-search-input {
            background: var(--input-bg);
            border-color: var(--glass-border);
        }

        .wall-view {
            background-color: var(--bg-dark);
        }

        #wall-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #wall-loader {
            position: absolute;
            inset: 0;
            background: var(--bg-dark);
            display: none;

            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        #changelog-content {
            scrollbar-width: thin;
        }

        #changelog-content::-webkit-scrollbar {
            width: 6px;
        }

        #changelog-content::-webkit-scrollbar-thumb {
            background: var(--glass);
            border-radius: 3px;
        }

        .changelog-entry {
            margin-bottom: 20px;
        }

        .changelog-meta {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 8px;
        }

        .changelog-meta h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--accent-1);
            margin: 0;
        }

        .changelog-meta span {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .changelog-desc p {
            margin-bottom: 8px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .changelog-desc p::before {
            content: "- ";
            margin-right: 4px;
        }

        .changelog-image {
            display: block;
            max-width: 80%;
            height: auto;
            border-radius: 8px;
            margin: 15px auto 10px auto;
            border: 1px solid var(--glass-border);
        }

        hr.changelog-divider {
            border: none;
            height: 1px;
            background-color: var(--glass-border);
            margin: 25px 0;
        }

        #changelog-content .changelog-entry:last-child+hr.changelog-divider {
            display: none;
        }

        #announcement-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;

            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #announcement-overlay.show {
            opacity: 1;
            visibility: visible;
            display: flex;
        }

        #announcement-popup {
            background: var(--glass-3, rgba(30, 41, 59, 0.9));
            padding: 25px 30px;
            border-radius: 16px;
            border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1));
            box-shadow: var(--shadow, 0 10px 30px rgba(0, 0, 0, 0.3));
            width: min(90vw, 450px);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #announcement-overlay.show #announcement-popup {
            transform: scale(1);
        }

        #announcement-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        #announcement-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 15px;
            object-fit: contain;
        }

        #announcement-text {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        #close-announcement-btn {
            display: inline-block;
            width: auto;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 0;
        }

        .light #announcement-popup {
            background: var(--glass-3, rgba(255, 255, 255, 0.95));
            border-color: var(--glass-border, rgba(0, 0, 0, 0.1));
        }

        .light #announcement-title {
            color: var(--text-primary);
        }

        .light #announcement-text {
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
            }

            .app-main {
                padding-bottom: 60px !important;
            }

            .app-nav {
                display: flex !important;
                flex-direction: row !important;
                align-items: center;
                width: 100%;
                height: 60px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                padding: 0 15px;
                background: rgba(30, 41, 59, 0.85);
                backdrop-filter: blur(18px);
                border-top: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
            }

            .app-nav .nav-avatar {
                display: block;
                width: 40px !important;
                height: 40px !important;
                margin: 0;
                padding: 0;
                border-radius: 50%;
                overflow: hidden;
                border: 2px solid transparent;
                transition: border-color 0.2s ease;
                flex-shrink: 0;
                cursor: pointer;
            }

            .app-nav .nav-avatar img {
                display: block;
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
            }

            .app-nav .nav-avatar:hover {
                border-color: var(--glass);
            }

            .app-nav .nav-button {
                flex: 1;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                border-radius: 12px;
                transition: background-color 0.2s ease, color 0.2s ease;
                background-color: transparent;
                border: none;
                cursor: pointer;
            }

            .app-nav .nav-button:hover {
                background-color: var(--glass);
                color: var(--text);
            }

            .app-nav .nav-button.active {
                background-color: var(--accent-1);
                color: #fff;
            }

            .app-nav .nav-button.active::before {
                display: none;
            }

            .app-nav .nav-button svg {
                width: 24px;
                height: 24px;
            }

            .app-nav .nav-spacer {
                display: none !important;
            }

            #nav-settings-menu {
                position: fixed !important;
                bottom: 70px !important;
                left: 15px !important;
                right: auto !important;
                width: 200px !important;
                z-index: 1010 !important;
                display: none;
                background: var(--glass-3);
                backdrop-filter: blur(18px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 10px;
                box-shadow: var(--shadow);
                top: auto !important;
            }

            .chat-view .container#app {
                width: 100% !important;
                display: flex !important;
            }

            .chat-view #sidebar,
            .chat-view #chat-window {
                width: 100% !important;
                max-width: none !important;
                height: 100%;
                padding: 10px;
                box-sizing: border-box;
                border-right: none;
                flex-shrink: 0;
            }

            #chat-placeholder {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                color: var(--text-secondary);
                font-size: 16px;
                padding: 20px;
            }

            body:not(.mobile-chat-active) .chat-view #chat-window {
                display: none !important;
            }

            body:not(.mobile-chat-active) .chat-view #chat-placeholder {
                display: none !important;
            }

            body:not(.mobile-chat-active) .chat-view #sidebar {
                display: flex !important;
            }

            body.mobile-chat-active .chat-view #sidebar {
                display: none !important;
            }

            body.mobile-chat-active .chat-view #chat-window {
                display: flex !important;
            }

            body.mobile-chat-active .chat-view #chat-placeholder {
                display: none !important;
            }

            #chat-header {
                padding: 8px 10px;
                gap: 8px;
            }

            #current-chat-friend-name {
                font-size: 16px;
            }

            #current-chat-avatar {
                width: 36px;
                height: 36px;
            }

            #open-info-btn,
            #group-info-btn {
                font-size: 22px;
                padding: 3px;
            }

            .chat-input {
                gap: 8px;
                align-items: flex-end;
                padding: 10px;
            }

            #message-input {
                padding: 10px 12px;
                margin: 0;
                flex: 1;
                transition: none;
            }

            .image-upload-label {
                padding: 10px 14px;
            }

            #send-btn {
                display: none;
                width: 44px;
                height: 44px;
                padding: 0;
                margin: 0;
                border-radius: 50%;
                flex-shrink: 0;
                align-items: center;
                justify-content: center;
            }

            .chat-input.has-text #send-btn {
                display: flex !important;
            }

            .chat-input.has-text #send-btn:not(.loading) .send-icon {
                display: block !important;
                margin: auto;
            }

            .chat-input.has-text #send-btn:not(.loading) .spinner-icon {
                display: none !important;
            }

            #send-btn.loading .send-icon {
                display: none !important;
            }

            #send-btn.loading .spinner-icon {
                display: block !important;
                margin: auto;
                animation: spin 1.2s linear infinite;
            }

            #chat-info-panel {
                display: none !important;
            }

            #open-friend-req-btn {
                display: none;
            }

            .modal-content {
                width: min(90vw, 420px);
                padding: 20px 25px;
            }

            .modal-content h2 {
                font-size: 20px;
            }

            .modal-actions button {
                font-size: 15px;
                padding: 10px 18px;
            }

            .friends-view {
                padding: 15px;
            }

            .friends-container h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }

            #friends-search-input {
                padding: 10px 14px;
                font-size: 14px;
                margin-bottom: 15px;
            }

            .friend-item {
                padding: 10px;
                gap: 10px;
            }

            .friend-avatar {
                width: 40px;
                height: 40px;
            }

            .friend-name {
                font-size: 15px;
            }
        }

        #nav-settings-menu {
            position: absolute;
            bottom: 75px;
            left: 80px;
            width: 220px;
            display: none;
            background: var(--glass-3);
            backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 1010;

        }

        @media (max-width: 768px) {
            #nav-settings-menu {
                position: fixed !important;
                bottom: 70px !important;
                left: 15px !important;
                right: auto !important;
                width: 200px !important;
                z-index: 1010 !important;

            }
        }

        .message-link {
            color: var(--accent-1);

            text-decoration: underline;
            cursor: pointer;
        }

        .message-link:hover {
            color: var(--accent-2);

        }

        .light .message-link {
            color: #007aff;

        }

        .light .message-link:hover {
            color: #0056b3;
        }

        #app-info {
            padding: 10px 8px;

            font-size: 10px;

            color: var(--text-secondary);

            text-align: center;

            line-height: 1.4;

            word-break: break-all;

            margin-bottom: 5px;

        }

        .app-nav .nav-avatar {
            margin-bottom: 5px;

        }

        #nav-settings-menu {
            bottom: 65px;


        }

        @media (max-width: 768px) {
            #app-info {
                display: none;

            }

            .app-nav .nav-avatar {
                margin-bottom: 0;

                margin-right: 10px;

            }

            #nav-settings-menu {
                bottom: 70px !important;

                left: 15px !important;

            }
        }

        #app-info {
            padding: 10px 8px;
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.4;


            overflow-wrap: break-word;

            margin-bottom: 5px;
        }

        #user-uid-display {
            cursor: pointer;


            transition: color 0.2s;
        }

        #user-uid-display:hover {
            color: var(--text-primary);

        }

        #app-info {
            padding: 10px 8px;
            font-size: 10px;
            color: var(--text-secondary);


            text-align: left;

            line-height: 1.4;



            margin-bottom: 5px;
            overflow: hidden;

        }

        #user-uid-display {
            cursor: pointer;
            transition: color 0.2s;

            white-space: nowrap;

            overflow: hidden;

            text-overflow: ellipsis;

            display: inline-block;

            max-width: 100%;

            vertical-align: bottom;


        }

        #user-uid-display:hover {
            color: var(--text-primary);
        }


        #open-friend-req-btn {
            position: absolute;


            bottom: 55px;

            left: 16px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));

        }

        #app-info {
            position: fixed;

            bottom: 10px;

            left: 10px;

            z-index: 1001;

            background-color: rgba(0, 0, 0, 0.5);

            border-radius: 8px;

            padding: 4px 10px;

            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            text-align: left;

            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;

        }

        #app-info span {

            color: var(--text);
            font-weight: 500;
            vertical-align: middle;
        }

        #user-uid-display {
            cursor: pointer;
            transition: color 0.2s;

        }

        #user-uid-display:hover {
            color: var(--accent-1);
        }


        .app-nav .nav-avatar {
            margin-bottom: 40px;

        }

        #nav-settings-menu {
            bottom: 60px;

        }


        #app-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;


            padding: 4px 10px;

            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;

            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;


            max-width: 400px;

        }

        .lightbox-overlay {
            position: fixed;
            inset: 0;

            background-color: rgba(0, 0, 0, 0.85);

            backdrop-filter: blur(8px);

            display: none;

            justify-content: center;
            align-items: center;
            z-index: 9999;

            animation: fadeIn 0.3s ease;

            user-select: none;

            -webkit-user-select: none;
        }

        .lightbox-overlay.show {
            display: flex;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;

            display: block;

            margin: auto;

            border-radius: 5px;

            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
        }

        .lightbox-close-btn {
            position: absolute;
            top: 15px;

            right: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 45px;

            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            line-height: 1;

            z-index: 10001;

        }

        .lightbox-close-btn:hover {
            color: #fff;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 40px;

            font-weight: bold;
            padding: 10px 18px;

            border-radius: 50%;

            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            z-index: 10000;

            line-height: 1;
            display: none;

        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .lightbox-nav.prev {
            left: 20px;

        }

        .lightbox-nav.next {
            right: 20px;

        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .lightbox-close-btn {
                font-size: 35px;
                top: 10px;
                right: 15px;
            }

            .lightbox-nav {
                font-size: 30px;
                padding: 8px 14px;
            }

            .lightbox-nav.prev {
                left: 10px;
            }

            .lightbox-nav.next {
                right: 10px;
            }
        }

        .lightbox-overlay.show {
            display: flex;
            opacity: 1;

            visibility: visible;

        }

        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;

            justify-content: center;
            align-items: center;
            z-index: 9999;

            opacity: 0;

            visibility: hidden;

            transition: opacity 0.3s ease, visibility 0.3s ease;

        }

        .lightbox-overlay.show {
            display: flex;

            opacity: 1;
            visibility: visible;
        }

        .lightbox-content {

            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            display: block;
            margin: auto;
            border-radius: 5px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
        }

        .lightbox-close-btn {

            position: absolute;
            top: 15px;
            right: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 45px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            line-height: 1;
            z-index: 10001;

        }

        .lightbox-close-btn:hover {
            color: #fff;
        }

        .lightbox-nav {

            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 40px;
            font-weight: bold;
            padding: 10px 18px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            z-index: 10000;
            line-height: 1;
            display: none;

        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-action-btn {

            position: absolute;
            top: 15px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 10001;

        }

        .lightbox-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .lightbox-action-btn svg {
            color: rgba(255, 255, 255, 0.8);
            width: 22px;
            height: 22px;
        }

        .lightbox-action-btn:hover svg {
            color: #fff;
        }

        #lightbox-download-btn {

            right: 80px;

        }

        #lightbox-thumbnails-container {
            position: absolute;
            bottom: 0;

            left: 0;
            width: 100%;
            padding: 10px 0;

            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0));

            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;

            height: 100px;

            pointer-events: none;

            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .lightbox-overlay.show #lightbox-thumbnails-container {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;

        }


        #lightbox-thumbnails-list {
            display: flex;
            overflow-x: auto;

            gap: 8px;

            padding: 0 20px;

            -ms-overflow-style: none;

            scrollbar-width: none;

            max-width: 90%;

            margin: 0 auto;

            align-items: center;

        }

        #lightbox-thumbnails-list::-webkit-scrollbar {
            display: none;

        }

        .lightbox-thumbnail-item {
            width: 60px;

            height: 60px;
            border-radius: 5px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;

            transition: border-color 0.2s ease, transform 0.2s ease;
            flex-shrink: 0;

            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .lightbox-thumbnail-item:hover {
            transform: scale(1.05);

        }

        .lightbox-thumbnail-item.active {
            border-color: var(--accent-1);

            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            #lightbox-download-btn {
                right: 65px;

                width: 38px;
                height: 38px;
            }

            #lightbox-download-btn svg {
                width: 18px;
                height: 18px;
            }

            #lightbox-thumbnails-container {
                height: 80px;
                padding: 8px 0;
            }

            #lightbox-thumbnails-list {
                gap: 6px;
                padding: 0 10px;
                max-width: 95%;
            }

            .lightbox-thumbnail-item {
                width: 50px;
                height: 50px;
            }
        }

        .last-seen-status {
            font-size: 12px;

            color: var(--text-secondary);

            margin-top: 2px;

            height: 15px;

            line-height: 15px;

            white-space: nowrap;

            overflow: hidden;
            text-overflow: ellipsis;
        }

        .light .last-seen-status {
            color: #6b7280;

        }

        #nav-settings-menu {
            position: absolute;


            bottom: 65px;

            left: 80px;
            width: 240px;

            display: none;
            background: var(--glass-3);
            backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px;

            box-shadow: var(--shadow);
            z-index: 1010;

        }

        .settings-row {
            display: flex;

            align-items: center;

            gap: 12px;

            justify-content: flex-start;

            padding: 10px 14px;

            border-radius: 10px;
            cursor: pointer;
            color: var(--text-primary);

            font-size: 15px;

            font-weight: 500;
            transition: background-color 0.2s;

        }

        .settings-row:hover {
            background: var(--glass);
            color: var(--text-primary);
        }

        #nav-settings-menu .settings-row svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);

            flex-shrink: 0;

            transition: stroke 0.2s;
        }

        .settings-row:hover svg {
            stroke: var(--text-primary);

        }

        #nav-settings-menu .settings-row span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #nav-settings-menu #go-login {
            color: #f87171;

        }

        #nav-settings-menu #go-login svg {
            stroke: #f87171;
        }

        #nav-settings-menu #go-login:hover {
            background: rgba(239, 68, 68, 0.1);

            color: #ef4444;

        }

        #nav-settings-menu #go-login:hover svg {
            stroke: #ef4444;
        }

        @media (max-width: 768px) {
            #nav-settings-menu {
                bottom: 70px !important;

                left: 15px !important;
                width: 220px;

            }
        }

        friends-view {

            width: 100%;
            height: 100%;
            padding: 0;
            background-color: var(--bg-dark);

        }

        .friends-layout-container {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 20px;
        }

        .friends-nav-sidebar {
            width: 320px;
            height: fit-content;
            background-color: var(--bg-nav);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }

        .friends-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;

        }

        .friends-nav-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .friends-nav-add-btn {
            background: var(--hover-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .friends-nav-add-btn:hover {
            background: var(--glass);
            color: var(--text-primary);
            border-color: var(--accent-1);
        }

        .friends-nav-search-bar {
            position: relative;
        }

        .friends-nav-search-bar svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .friends-nav-search-bar input {
            width: 100%;
            padding: 10px 12px 10px 38px;

            border-radius: 8px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            outline: none;
            font-size: 15px;
        }

        .friends-nav-search-bar input:focus {
            border-color: var(--accent-1);
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.2);
        }

        .friends-nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-top: 1px solid var(--glass-border);

            padding-top: 15px;

        }

        .friends-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .friends-nav-item svg {
            flex-shrink: 0;
        }

        .friends-nav-item:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .friends-nav-item.active {
            background-color: var(--active-bg);
            color: var(--text-primary);

            font-weight: 600;
        }

        .nav-badge {
            margin-left: auto;
            background-color: var(--red-accent);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friends-content-area {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-nav);
            border: 1px solid var(--border);
            border-radius: 12px;

        }

        .friends-content-page {
            width: 100%;
            height: 100%;
            display: none;

            flex-direction: column;
            overflow: hidden;

        }

        .friends-content-page.active {
            display: flex;

        }

        .friends-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        .friends-content-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .friends-content-filters {
            display: flex;
            gap: 10px;
        }

        .friends-list-search-input {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            outline: none;
            font-size: 14px;
            width: 200px;
        }

        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .filter-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .filter-btn svg {
            width: 16px;
            height: 16px;
        }

        .friends-list-container {
            flex: 1;

            overflow-y: auto;

            padding: 20px 30px;
        }

        .friends-list-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
            font-size: 15px;
        }

        .letter-divider {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 10px 0;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--glass-border);
        }

        .friend-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .friend-list-item:hover {
            background-color: var(--hover-bg);
        }

        .friend-list-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .friend-list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .friend-list-name {
            font-weight: 500;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-flex;

            align-items: center;
        }

        .friend-list-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .friend-list-actions button:hover {
            background-color: var(--glass);
            color: var(--text-primary);
        }

        #friends-requests-list-page .friend-req-item {

        }

        #friends-requests-list-page .friend-req-name {

        }

        @media (max-width: 768px) {
            .friends-view {
                padding: 0;
            }

            .friends-layout-container {
                flex-direction: column;
                gap: 0;
            }

            .friends-nav-sidebar {
                width: 100%;
                height: auto;
                border: none;
                border-radius: 0;
                border-bottom: 1px solid var(--glass-border);
                padding: 15px;
                gap: 10px;
            }

            .friends-content-area {
                border: none;
                border-radius: 0;
                padding: 15px;
            }

            .friends-nav-header h2 {
                font-size: 18px;
            }

            .friends-nav-search-bar input {
                padding: 9px 10px 9px 34px;
                font-size: 14px;
            }

            .friends-nav-list {
                flex-direction: row;

                overflow-x: auto;

                padding-bottom: 5px;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .friends-nav-list::-webkit-scrollbar {
                display: none;
            }

            .friends-nav-item {
                padding: 9px 14px;
                font-size: 14px;
                white-space: nowrap;

                margin-bottom: 0;
            }

            .friends-nav-item span {


            }

            .nav-badge {
                font-size: 10px;
                padding: 2px 6px;
            }

            .friends-content-area {
                flex: 1;
                overflow: hidden;

            }

            .friends-content-header {
                padding: 15px;
                flex-direction: column;

                align-items: flex-start;

                gap: 10px;
            }

            .friends-content-header h2 {
                font-size: 18px;
            }

            .friends-content-filters {
                width: 100%;
                gap: 8px;
            }

            .friends-list-search-input {
                flex-grow: 1;

                width: auto;
            }

            .filter-btn {
                padding: 8px 10px;
                font-size: 13px;
            }

            .filter-btn span {
                display: none;
            }

            .friends-list-container {
                padding: 10px 15px;
            }

            .friend-list-item {
                padding: 10px 5px;
            }

            .friend-list-avatar {
                width: 36px;
                height: 36px;
            }

            .friend-list-name {
                font-size: 15px;
            }
        }

        .friends-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;

            width: 100%;
        }

        .friends-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            width: 100%;
        }

        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-3);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 10000;
            backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            display: none;
            min-width: 250px;
            max-width: 400px;
            overflow: hidden;
        }

        #toast::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.3;
            pointer-events: none;
            transform: rotate(15deg);

        }

        #toast.toast-success {
            background: rgba(30, 41, 59, 0.85);
            border-color: #22c55e;
            color: #e5e7eb;
            backdrop-filter: blur(10px);
        }

        #toast.toast-success::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2322c55e'/%3E%3Cpath d='M55 65 l5 5 l10 -10' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2322c55e' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2322c55e' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        #toast.toast-error {
            background: rgba(30, 41, 59, 0.85);
            border-color: #ef4444;
            color: #e5e7eb;
            backdrop-filter: blur(10px);
        }

        #toast.toast-error::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%23ef4444'/%3E%3Cpath d='M57 57 l16 16 M73 57 l-16 16' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%23ef4444' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        #toast.toast-info {
            background: var(--glass-3);
            border-color: #60a5fa;
            color: var(--text-primary);
            backdrop-filter: blur(18px);
        }

        #toast.toast-info::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.7'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2360a5fa'/%3E%3Cline x1='65' y1='60' x2='65' y2='80' stroke='%23ffffff' stroke-width='5' stroke-linecap='round'/%3E%3Ccircle cx='65' cy='50' r='3' fill='%23ffffff'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2360a5fa' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2360a5fa' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        .light #toast.toast-success {
            background: var(--glass-3);
            border-color: #22c55e;
            color: var(--text-primary);
        }

        .light #toast.toast-success::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.2'%3E%3Ccircle cx='65' cy='65' r='25' fill='%2322c55e'/%3E%3Cpath d='M55 65 l5 5 l10 -10' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%2322c55e' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%2322c55e' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        .light #toast.toast-error {
            background: var(--glass-3);
            border-color: #ef4444;
            color: var(--text-primary);
        }

        .light #toast.toast-error::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg opacity='0.2'%3E%3Ccircle cx='65' cy='65' r='25' fill='%23ef4444'/%3E%3Cpath d='M57 57 l16 16 M73 57 l-16 16' stroke='%23ffffff' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='85' cy='85' r='8' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='90' cy='50' r='5' fill='%23ef4444' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        .light #toast.toast-info {
            background: var(--glass-3);
            border-color: var(--glass-border);
            color: var(--text-primary);
        }

        #toast-message {
            margin: 0;
            font-weight: 500;
            font-size: 15px;
            line-height: 1.4;
            text-align: center;
        }

        #toast-close-btn {
            display: none;
        }

        #chat-window-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            display: none;
        }

        #chat-window-placeholder .placeholder-icon {
            width: 80px;
            height: 80px;
            color: var(--glass-border);
            stroke-width: 1.5px;
            margin-bottom: 20px;
        }

        #chat-window-placeholder h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        #chat-window-placeholder p {
            font-size: 15px;
            max-width: 300px;
            line-height: 1.5;
        }

        #changelog-modal .modal-content h2::before {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 8px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23c084fc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='16' y1='13' x2='8' y2='13'%3E%3C/line%3E%3Cline x1='16' y1='17' x2='8' y2='17'%3E%3C/line%3E%3Cpolyline points='10 9 9 9 8 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.8;
        }

        .changelog-desc p::before {
            content: '';
            margin-right: 10px;
            color: var(--accent-1);
            font-weight: 700;
            font-size: 1.1em;
        }

        #close-changelog-modal {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: #fff;
            border: none;
        }

        #close-changelog-modal:hover {
            filter: brightness(1.15);
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        }

        #news-banner-image {
            width: 100%;
            height: 280px;
            object-fit: cover;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid var(--glass-border);
        }

        #changelog-modal .modal-content h2 {
            padding-bottom: 10px;
            margin-bottom: 0;
        }

        .modal-close-x {
            position: absolute;
            top: 20px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 24px;
            font-weight: bold;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 10;
        }

        .modal-close-x:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .light .modal-close-x {
            background: rgba(255, 255, 255, 0.7);
            color: #000;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .light .modal-close-x:hover {
            background: rgba(255, 255, 255, 1);
        }

        .changelog-entry {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
            transition: background-color 0.2s ease;
        }

        .light .changelog-entry {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .changelog-meta h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .changelog-desc p::before {
            content: '-';
            margin-right: 10px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        hr.changelog-divider {
            display: none;
        }

        #changelog-content {
            padding-right: 10px;
            margin-top: 15px;
        }

        .changelog-entry-box {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
            transition: background-color 0.2s ease;
        }

        .light .changelog-entry-box {
            background-color: rgba(0, 0, 0, 0.02);
        }


        .changelog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 15px;
            cursor: pointer;
        }

        .changelog-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .light .changelog-header:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }

        .changelog-header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .changelog-header-left h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .changelog-header-left span {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .changelog-chevron {
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .changelog-header.open .changelog-chevron {
            transform: rotate(90deg);
        }

        .changelog-details-content {
            padding: 0px 15px 20px 15px;
            border-top: 1px solid var(--glass-border);
            margin: 0;
            padding-top: 15px;
            display: none;
        }

        .changelog-details-content p {
            margin-bottom: 8px;
            line-height: 1.6;
            color: var(--text-primary);
            padding-left: 15px;
            position: relative;
        }

        .changelog-details-content p::before {
            content: '-';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .changelog-details-content p:last-child {
            margin-bottom: 0;
        }

        hr.changelog-divider {
            display: none;
        }

        #changelog-content {
            padding-right: 10px;
            margin-top: 20px;
        }

        .changelog-desc p::before {
            content: none;
        }

        .changelog-entry {
            padding: 0;
            border: none;
            background: none;
        }

        #page-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);

            z-index: 99999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease-out, visibility 0.4s ease-out;
        }

        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;

            width: 90%;

            max-width: 400px;

            color: var(--text-secondary);
            text-align: center;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--glass-border);
            border-top-color: var(--accent-1);

            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            font-size: 1.25em;

            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: -5px;

        }

        .loader-eta {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .loader-progress-bar {
            width: 100%;

            height: 8px;

            background: var(--glass-border);

            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;

        }

        .loader-progress {
            width: 0%;

            height: 100%;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));

            border-radius: 5px;
            animation: loadingProgress 3s forwards cubic-bezier(0.25, 0.1, 0.25, 1);

        }


        .loader-tip {
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        body.loaded #page-loader {
            opacity: 0;
            visibility: hidden;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes loadingProgress {
            0% {
                width: 0%;
            }

            100% {
                width: 100%;
            }
        }

        #page-loader {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            z-index: 99999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease-out 0.2s, visibility 0.4s ease-out 0.2s;
            padding: 30px;
        }

        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 90%;
            max-width: 400px;
            color: var(--text-secondary);
            text-align: center;
            margin: auto 0;
        }

        .loader-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
            transform: rotate(-10deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .loader-text {
            font-size: 1.25em;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: -5px;
        }

        .loader-eta {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .loader-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--glass-border);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .loader-progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            border-radius: 5px;
            animation: loadingProgress 3s forwards cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .loader-footer {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 600px;
            text-align: center;
            color: var(--text-secondary);
            padding: 0 30px;
            margin: 0 auto;
        }

        .loader-tip {
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .loader-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;


            padding: 4px 10px;

            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;

            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;


            max-width: 400px;

        }

        .loader-info span {
            white-space: nowrap;
        }

        body.loaded #page-loader {
            opacity: 0;
            visibility: hidden;
        }

        @keyframes loadingProgress {
            0% {
                width: 0%;
            }

            100% {
                width: 100%;
            }
        }

        .loading-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background-color: #0078ff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto 20px;
        }

        .loading-container h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .loading-container p {
            font-size: 14px;
            color: #a0a0a0;
        }

        .progress-bar-bottom-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;

            background-color: #3a3f5a;

            z-index: 100;
        }

        .progress-bar-bottom {
            width: 60%;

            height: 100%;
            background-color: #0078ff;
            border-radius: 0 3px 3px 0;

        }

        .user-agent-footer {
            position: absolute;
            bottom: 6px;

            left: 0;
            width: 100%;
            padding: 6px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            font-size: 11px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            z-index: 99;
        }

        .tip-footer {
            position: absolute;
            bottom: 35px;

            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            text-align: center;
            font-size: 14px;
            color: #a0a0a0;
            z-index: 99;
        }


    </style>
</head>

<body class="light">

    <nav class="app-nav" style="display: none !important;">
        <button class="nav-button active" data-view="chat" title="Tr chuyn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        </button>
        <button class="nav-button" data-view="friends" title="Bn b">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
        </button>
        <button class="nav-button" data-view="wall" title="Tng nh">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
        </button>
        <div class="nav-spacer"></div>
        <img id="nav-avatar" class="nav-avatar" src="https://placehold.co/48x48" alt="avatar" title="Ci t & H s">
        <div class="settings-menu" id="nav-settings-menu">
            <div class="settings-row clickable" id="go-to-profile">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                <span>C nhn</span>
            </div>
            <div class="settings-row clickable" id="show-changelog-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6" />
                    <line x1="8" y1="12" x2="21" y2="12" />
                    <line x1="8" y1="18" x2="21" y2="18" />
                    <line x1="3" y1="6" x2="3.01" y2="6" />
                    <line x1="3" y1="12" x2="3.01" y2="12" />
                    <line x1="3" y1="18" x2="3.01" y2="18" />
                </svg>
                <span>Tin Tc</span>
            </div>
            <div class="settings-row clickable" id="open-report-bug-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13a6 6 0 0 0-6 6h-4a6 6 0 0 0-6-6v-4a6 6 0 0 0 6-6h4a6 6 0 0 0 6 6v4Z" />
                    <path d="m14 4 3 3" />
                    <path d="m10 20 3-3" />
                    <line x1="12" y1="12" x2="12" y2="12.01" />
                </svg>
                <span>Bo li</span>
            </div>
            <div class="settings-row clickable" id="open-about-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="16" x2="12" y2="12" />
                    <line x1="12" y1="8" x2="12.01" y2="8" />
                </svg>
                <span>Thng tin tc gi</span>
            </div>
            <div class="settings-row clickable" id="go-to-settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
                <span>Ci t</span>
            </div>
            <div class="settings-row clickable" id="go-login">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                <span>ng xut</span>
            </div>
        </div>
    </nav>

    <div class="app-layout">
        <main class="app-main">

            <div class="app-view chat-view active" data-view="chat">
                <div id="toast" style="display:none;">
                    <div id="toast-message"></div>
                </div>
                <div id="message-context-menu" style="display:none;"></div>
                <div id="image-lightbox" class="lightbox-overlay">
                    <span class="lightbox-close-btn" title="ng">&times;</span>
                    <button class="lightbox-nav prev" id="lightbox-prev-btn" title="nh trc"></button>
                    <img class="lightbox-content" id="lightbox-img" src="" alt="Xem nh ln">
                    <button class="lightbox-nav next" id="lightbox-next-btn" title="nh tip theo"></button>

                    <a id="lightbox-download-btn" class="lightbox-action-btn download-btn" href="#" download
                        target="_blank" title="Ti nh">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-download">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg>
                    </a>

                    <div id="lightbox-thumbnails-container">
                        <div id="lightbox-thumbnails-list">
                        </div>
                    </div>
                </div>
                <div id="friend-request-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Li Mi Kt Bn</h2>
                        <div id="friend-request-list"></div><button id="close-friend-req-modal"
                            class="cancel-btn">ng</button>
                    </div>
                </div>
                <div id="create-group-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>To nhm mi</h2><input type="text" id="group-name-input" placeholder="Nhp tn nhm...">
                        <h4>Mi bn b</h4>
                        <div id="group-members-checklist"></div>
                        <div class="modal-actions"><button id="close-group-modal-btn"
                                class="btn-ghost">Hy</button><button id="confirm-create-group-btn" class="btn">To
                                Nhm</button></div>
                    </div>
                </div>
                <div id="reactions-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Lt by t cm xc</h2>
                        <div id="reactions-list"></div><button id="close-reactions-modal" class="btn-ghost"
                            style="margin-top: 15px;">ng</button>
                    </div>
                </div>
                <div id="edit-profile-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Chnh sa h s</h2><label class="form-label" for="profile-display-name">Tn hin
                            th</label><input type="text" id="profile-display-name" placeholder="Tn ca bn..."><label
                            class="form-label" for="profile-bio">Gii thiu (Bio)</label><textarea id="profile-bio"
                            rows="3" placeholder="Vit g  v bn..."></textarea><label class="form-label"
                            for="profile-avatar-url">URL nh i din</label><input type="text" id="profile-avatar-url"
                            placeholder="https://example.com/avatar.png">
                        <div class="modal-actions"><button id="cancel-profile-edit-btn"
                                class="btn-ghost">Hy</button><button id="save-profile-edit-btn" class="btn">Lu thay
                                i</button></div>
                    </div>
                </div>
                <div id="custom-confirm-modal" class="modal-overlay">
                    <div class="modal-content" style="width: 400px; text-align: center;">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2 id="confirm-title">Xc nhn hnh ng</h2>
                        <p id="confirm-message" style="margin: 15px 0; color: var(--text-2); font-size: 15px;"></p>
                        <div class="modal-actions" style="justify-content: center;"><button id="confirm-cancel-btn"
                                class="btn-ghost">Hy</button><button id="confirm-ok-btn"
                                class="btn danger-btn">OK</button></div>
                    </div>
                </div>
                <div id="report-user-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Bo co ngi dng</h2>
                        <p id="reporting-user-name" style="color: var(--text-2); margin-bottom: 20px;"></p>
                        <div id="report-form" class="form report-form"><label class="form-label">L do bo
                                co:</label><label class="report-reason-row"><input type="radio" name="reportReason"
                                    value="spam" checked><span class="custom-radio"></span>Gi tin nhn rc
                                (Spam)</label><label class="report-reason-row"><input type="radio" name="reportReason"
                                    value="harassment"><span class="custom-radio"></span>Quy ri, bt nt</label><label
                                class="report-reason-row"><input type="radio" name="reportReason"
                                    value="inappropriate"><span class="custom-radio"></span>Ni dung khng ph
                                hp</label><label class="report-reason-row"><input type="radio" name="reportReason"
                                    value="impersonation"><span class="custom-radio"></span>Mo danh</label><label
                                for="report-details" class="form-label" style="margin-top: 15px;">M t thm (nu
                                c):</label><textarea id="report-details" rows="3"
                                placeholder="Cung cp thm chi tit v hnh vi..."></textarea><button
                                id="attach-evidence-btn" class="btn-ghost" style="margin-top: 15px;"> nh km bng
                                chng (tin nhn)</button>
                            <div id="evidence-preview"
                                style="font-size: 13px; color: var(--text-2); margin-top: 8px; display: none;"></div>
                        </div>
                        <div class="modal-actions"><button id="cancel-report-btn" class="btn-ghost">Hy</button><button
                                id="submit-report-btn" class="btn danger-btn">Gi bo co</button></div>
                    </div>
                </div>
                <div id="force-update-profile-modal" class="modal-overlay" style="z-index: 9998;">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2 style="text-align: center;">Hon tt h s ca bn</h2>
                        <p style="color: var(--text-2); text-align: center; margin-bottom: 20px; font-size: 15px;">Vui
                            lng cp nht thng tin  bt u tr chuyn.</p><label class="form-label"
                            for="force-name-input">Tn hin th (Bt buc)</label><input type="text"
                            id="force-name-input" placeholder="Tn ca bn..."><label class="form-label"
                            for="force-avatar-input">URL nh i din (Bt buc)</label><input type="text"
                            id="force-avatar-input" placeholder="https://example.com/avatar.png"><label
                            class="form-label" for="force-bio-input">Gii thiu (Bio)</label><textarea
                            id="force-bio-input" rows="2" placeholder="Vit g  v bn..."></textarea><label
                            class="form-label" for="force-cover-input">URL nh ba</label><input type="text"
                            id="force-cover-input" placeholder="https://example.com/cover.png">
                        <div class="modal-actions" style="margin-top: 25px;"><button id="force-save-btn" class="btn">Cp
                                nht v Bt u</button></div>
                    </div>
                </div>
                <div id="edit-group-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Cp nht thng tin nhm</h2>
                        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                            <div style="flex-shrink: 0; text-align: center;"><label class="form-label"
                                    style="margin-bottom: 10px;">nh i din</label><img id="edit-group-avatar-preview"
                                    src="https://placehold.co/95x95"
                                    style="width: 95px; height: 95px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); cursor: pointer; transition: opacity 0.2s;"
                                    title="Nhn  ti nh ln">
                                <div id="edit-group-avatar-loading"
                                    style="font-size: 13px; color: var(--accent-1); display: none; margin-top: 5px;">
                                    ang ti...</div>
                            </div>
                            <div style="flex-grow: 1; min-width: 0;"><label class="form-label"
                                    for="edit-group-name-input">Tn nhm</label><input type="text"
                                    id="edit-group-name-input" placeholder="Tn nhm mi..."><label class="form-label"
                                    for="edit-group-avatar-input" style="margin-top: 15px;">Hoc dn URL
                                    Avatar</label><input type="text" id="edit-group-avatar-input"
                                    placeholder="https://.../avatar.png"></div>
                        </div>
                        <div class="modal-actions"><button id="cancel-edit-group-btn"
                                class="btn-ghost">Hy</button><button id="save-edit-group-btn" class="btn">Lu thay
                                i</button></div>
                    </div>
                </div>
                <div id="add-member-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Thm thnh vin vo nhm</h2>
                        <p id="add-member-group-name"
                            style="color: var(--text-2); margin-bottom: 20px; text-align: center;"></p><label
                            class="form-label">Chn bn b  thm:</label>
                        <div id="add-member-friend-list"
                            style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 20px; background: var(--input);">
                        </div>
                        <div class="modal-actions"><button id="cancel-add-member-btn"
                                class="btn-ghost">Hy</button><button id="confirm-add-member-btn" class="btn">Thm vo
                                nhm</button></div>
                    </div>
                </div>
                <div id="changelog-modal" class="modal-overlay" style="z-index: 9999;">
                           <div class="modal-content"
                        style="width: min(90vw, 650px); text-align: left; padding: 0; position: relative;">
                                <button class="modal-close-x" id="close-changelog-x-btn">&times;</button>
                                <img id="news-banner-image" src="Res/panel.png  " alt="Banner Tin Tc">
                                <div style="padding: 25px 35px 30px 35px;">
                                     <h2>Tin Tc</h2>
                                     <div id="changelog-content"
                                style="max-height: 50vh; overflow-y: auto; padding-right: 15px; margin-bottom: 25px; margin-top: 15px;">
                            </div>
                                    </div>
                               </div>
                          </div>
                <div id="report-bug-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Bo li</h2>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">Cm n bn 
                            gip ci thin Confe! Vui lng m t li bn gp phi.</p>
                        <div class="form"><label class="form-label" for="bug-description">M t li:</label><textarea
                                id="bug-description" rows="4" placeholder="..."></textarea><label class="form-label"
                                for="bug-steps">Cc bc ti hin ra li : </label><textarea id="bug-steps" rows="3"
                                placeholder="..."></textarea></div>
                        <div class="modal-actions"><button id="cancel-report-bug-btn"
                                class="btn-ghost">Hy</button><button id="submit-bug-report-btn" class="btn">Gi bo
                                co</button></div>
                    </div>
                </div>
                <div id="about-modal" class="modal-overlay">
                    <div class="modal-content" style="text-align: center;">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Thng tin tc gi</h2><img
                            src="https://i.ibb.co/xtQ6WDy8/z7088478191410-b16d303436bd2300dd9a3700a9db92ea-1.jpg"
                            alt="Tc gi"
                            style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; border: 2px solid var(--glass-border);">
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">c pht trin bi <span
                                style="color: var(--accent-1);">QiQi</span></p>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">Ver.1.0 </p>
                        <p style="font-size: 14px; line-height: 1.6;">Confe - Ni Nhn Gi Yu Thng. <br>Lin h: <a
                                href="mailto:betrumbaodeptraivippro@gmail.com"
                                style="color: var(--accent-1);">betrumbaodeptraivippro@gmail.com</a></p>
                        <div class="modal-actions" style="justify-content: center;"><button id="close-about-modal-btn"
                                class="btn-ghost">ng</button></div>
                    </div>
                </div>
                <div id="join-group-modal" class="modal-overlay">
                    <div class="modal-content" style="text-align: center;">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <div class="chat-info-section" style="margin-bottom: 15px;"><img id="join-group-avatar"
                                class="chat-info-avatar" src="https://placehold.co/80x80" alt="avatar nhm">
                            <h3 id="join-group-name" class="chat-info-name"
                                style="margin-top: 10px; margin-bottom: 5px; font-size: 20px;">Tn nhm</h3>
                            <p id="join-group-member-count" style="color: var(--text-2); font-size: 14px; margin: 0;">
                                ... thnh vin</p>
                        </div>
                        <p style="margin: 15px 0; color: var(--text-2);">Bn c mun tham gia nhm ny khng?</p>
                        <div class="modal-actions" style="justify-content: center;"><button id="cancel-join-group-btn"
                                class="btn-ghost">Hy</button><button id="confirm-join-group-btn" class="btn">Tham gia
                                ngay</button></div>
                    </div>
                </div>
                <div id="add-friend-modal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close-icon" title="ng" type="button"
                            onclick="this.closest('.modal-overlay').style.display='none'">&times;</button>
                        <h2>Thm bn b</h2><label for="add-friend-email-input" class="form-label">Nhp email ca ngi
                            bn mun kt bn:</label><input type="email" id="add-friend-email-input"
                            placeholder="nhapemail@confe.com">
                        <div class="modal-actions"><button id="cancel-add-friend-btn"
                                class="btn-ghost">Hy</button><button id="confirm-add-friend-btn" class="btn">Tm
                                kim</button></div>
                    </div>
                </div>
                <input type="file" id="group-avatar-upload-input" accept="image/*" style="display:none;">

                <div class="container" id="app" style="display:none;">
                    <div id="sidebar">
                        <div class="sidebar-head" style="justify-content: flex-start; padding-left: 10px;">
                            <button id="add-btn" title="Ty chn mi" style="margin: 0;">+</button>
                            <div class="settings-menu" id="add-menu" style="left: 10px; right: auto;">
                                <div class="settings-row clickable" id="create-group-from-menu">To nhm mi</div>
                                <div class="settings-row clickable" id="add-friend-from-menu">Thm bn b</div>
                            </div>
                        </div>
                        <div id="sidebar-search-container">
                            <input id="global-search" placeholder="Tm mi th: ngi dng, bn b, nhm..." />
                            <div id="search-dropdown"></div>
                        </div>
                        <div id="sidebar-loader">
                            <div class="list-title">Bn b</div>
                            <div class="skeleton-item">
                                <div class="skeleton skeleton-circle"></div>
                                <div class="skeleton skeleton-line"></div>
                            </div>
                            <div class="skeleton-item">
                                <div class="skeleton skeleton-circle"></div>
                                <div class="skeleton skeleton-line"></div>
                            </div>
                            <div class="list-title">Nhm</div>
                            <div class="skeleton-item">
                                <div class="skeleton skeleton-circle"></div>
                                <div class="skeleton skeleton-line"></div>
                            </div>
                        </div>
                        <div id="sidebar-lists">
                            <ul id="chat-list"></ul>
                        </div>
                    </div>

                    <div id="chat-window">
                        <div id="chat-header">
                            <div id="chat-header-left">
                                <img id="current-chat-avatar" src="https://placehold.co/40x40" alt="avatar">
                                <div id="chat-header-info">
                                    <div id="current-chat-friend-name">Chn cuc tr chuyn</div>
                                    <div id="peer-info-extra" style="display: none;">
                                        <span class="stranger-label">Ngi l</span>
                                        <button id="add-friend-header-btn" class="add-friend-btn">Kt bn</button>
                                    </div>
                                    <div id="chat-header-last-seen" class="last-seen-status"></div>
                                </div>
                            </div>
                            <div id="chat-header-buttons">
                                <button id="open-info-btn" title="Thng tin"></button>
                                <button id="group-info-btn" title="Thng tin nhm"></button>
                            </div>
                        </div>

                        <div id="messages-container"></div>
                        <div id="chat-window-placeholder" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round"
                                stroke-linejoin="round" class="placeholder-icon">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <h2>Qola Messenger</h2>
                            <p>Chn mt ngi bn hoc nhm t danh sch bn tri  bt u nhn tin.</p>
                        </div>
                        <div id="typing-indicator"></div>

                        <div id="reply-preview-container" style="display: none;">
                            <div id="reply-preview-sender"></div>
                            <div id="reply-preview-text"></div><button id="cancel-reply-btn"></button>
                        </div>
                        <div id="edit-preview-container" style="display: none;">
                            <div id="edit-preview-title">ang chnh sa</div>
                            <div id="edit-preview-text"></div><button id="cancel-edit-btn"></button>
                        </div>
                        <div id="image-preview-container" style="display: none;"><img id="image-preview" /><button
                                id="cancel-preview-btn"></button></div>
                        <div id="selection-bar"
                            style="display: none; padding: 10px; background: var(--glass-3); border-top: 1px solid var(--border); text-align: right;">
                            <span id="selection-count" style="margin-right: 15px; color: var(--text-2);"> chn:
                                0</span><button id="cancel-selection-btn" class="btn-ghost">Hy</button><button
                                id="confirm-selection-btn" class="btn">Xong</button>
                        </div>
                        <div id="mention-suggestions" class="suggestion-popup"></div>

                        <div class="chat-input">
                            <label for="image-input" class="image-upload-label"><svg xmlns="http://www.w3.org/2000/svg"
                                    width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg></label>
                            <input id="image-input" type="file" accept="image/*" style="display:none" />
                            <input id="message-input" placeholder="Nhp tin nhn..." />
                            <button id="send-btn">
                                <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                                <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="2" x2="12" y2="6"></line>
                                    <line x1="12" y1="18" x2="12" y2="22"></line>
                                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                                    <line x1="2" y1="12" x2="6" y2="12"></line>
                                    <line x1="18" y1="12" x2="22" y2="12"></line>
                                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                                </svg>
                            </button>
                        </div>
                        <div id="inactive-chat-indicator" style="display: none;">Khng th gi tin nhn cho ngi ny.
                        </div>
                    </div>

                    <div id="chat-info-panel">
                        <div id="chat-info-header">
                            <h3>Thng tin</h3><button id="close-info-btn"></button>
                        </div>
                        <div class="chat-info-body">
                            <div id="friend-info-content" style="display:none;">
                                <div class="chat-info-section"><img id="chat-friend-avatar-info"
                                        class="chat-info-avatar" src="https://placehold.co/80x80">
                                    <div id="friend-name-display-area" class="chat-info-name"
                                        style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <h4 id="chat-friend-name-info"
                                            style="margin: 0; font-size: 18px; font-weight: 600;">Cha chn</h4><button
                                            id="edit-nickname-btn" class="btn-ghost" title="t bit danh"
                                            style="padding: 4px 8px; font-size: 14px; margin-top: 0; width: auto; flex-shrink: 0;"></button>
                                    </div>
                                    <div id="friend-name-edit-area"
                                        style="display: none; margin-top: 10px; width: 100%;"><label class="form-label"
                                            for="nickname-input"
                                            style="text-align: left; margin: 0 0 6px 0; color: var(--text-2);">t bit
                                            danh</label><input type="text" id="nickname-input"
                                            placeholder="Nhp bit danh..."
                                            style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input); color: var(--text);">
                                        <div style="display: flex; gap: 8px; margin-top: 8px;"><button
                                                id="cancel-nickname-btn" class="btn-ghost"
                                                style="width: 100%; margin-top: 0; padding: 8px;">Hy</button><button
                                                id="save-nickname-btn" class="btn"
                                                style="width: 100%; margin-top: 0; padding: 8px;">Lu</button></div>
                                    </div>
                                </div>
                                <h5>nh  gi</h5>
                                <div id="sent-images-grid" class="sent-images-grid"></div>
                                <div class="chat-actions"><button id="toggle-mute-btn-friend" title="Tt thng bo"
                                        style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg
                                            id="mute-icon-on-friend" xmlns="http://www.w3.org/2000/svg" width="16"
                                            height="16" fill="currentColor" viewBox="0 0 16 16"
                                            style="display: inline-block; vertical-align: middle; margin-right: 5px;">
                                            <path
                                                d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z" />
                                        </svg><svg id="mute-icon-off-friend" xmlns="http://www.w3.org/2000/svg"
                                            width="16" height="16" fill="currentColor" viewBox="0 0 16 16"
                                            style="display: none; vertical-align: middle; margin-right: 5px;">
                                            <path
                                                d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z" />
                                        </svg><span id="mute-btn-text-friend">Tt thng bo</span></button><button
                                        id="block-user-btn">Chn ngi ny</button><button id="unblock-user-btn">B chn
                                        ngi ny</button><button id="remove-friend-btn">Xa bn b</button><button
                                        id="report-user-btn" style="background: #a16207;">Bo co ngi ny</button>
                                </div>
                            </div>
                            <div id="group-info-content" style="display:none;">
                                <div class="chat-info-section"><img id="group-avatar"
                                        class="chat-info-avatar editable-group-info"
                                        src="https://placehold.co/80x80/EFEFEF/333333?text=G" alt="avatar nhm">
                                    <h4 id="group-name-display" class="chat-info-name editable-group-info">Tn nhm</h4>
                                </div>
                                <h5>Thnh vin</h5>
                                <ul id="group-members-list"></ul><button id="add-group-member-btn"
                                    class="btn primary-btn"
                                    style="width: auto; padding: 6px 12px; font-size: 13px; margin: 10px 0 15px 0; display: none;">
                                    Thm thnh vin</button>
                                <h5>nh  gi</h5>
                                <div id="group-sent-images-grid" class="sent-images-grid"></div>
                                <div class="chat-actions"><button id="toggle-mute-btn-group" title="Tt thng bo"
                                        style="border:1px solid var(--border); background:var(--glass-border); color:var(--text); border-radius:10px; padding: 11px; cursor:pointer; display: block; width: 100%; margin-bottom: 10px;"><svg
                                            id="mute-icon-on-group" xmlns="http://www.w3.org/2000/svg" width="16"
                                            height="16" fill="currentColor" viewBox="0 0 16 16"
                                            style="display: inline-block; vertical-align: middle; margin-right: 5px;">
                                            <path
                                                d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h6.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z" />
                                        </svg><svg id="mute-icon-off-group" xmlns="http://www.w3.org/2000/svg"
                                            width="16" height="16" fill="currentColor" viewBox="0 0 16 16"
                                            style="display: none; vertical-align: middle; margin-right: 5px;">
                                            <path
                                                d="M5.161 14.016A2 2 0 0 0 8 16a2 2 0 0 0 2.828-1.984l-5.667-5.667zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h1.967l1.08-1.08A5.002 5.002 0 0 1 8 1.917zM14.22 12c.223.447.481.801.78 1H8.914l-1-1-.31-.31L1.053 2.379a.5.5 0 1 1 .708-.708L14.707 14.707a.5.5 0 0 1-.708.708l-1.61-1.61zM13 6c0-.88.32-4.2 1.22-6l-1.08 1.08A5.002 5.002 0 0 0 8 1.018a5.002 5.002 0 0 0-4.141 2.997l-1.08-1.08C3.68 3.8 4 5.12 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258H13z" />
                                        </svg><span id="mute-btn-text-group">Tt thng bo</span></button><button
                                        id="disband-group-btn" class="danger-btn" style="display: none;">Gii tn
                                        nhm</button><button id="leave-group-btn">Ri nhm</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-view friends-view" data-view="friends">
                <div class="friends-layout-container">

                    <nav class="friends-nav-sidebar">
                        <div class="friends-nav-header">
                            <h2>Bn b</h2>
                            <ul class="friends-nav-list">
                                <li class="friends-nav-item active" data-friends-page="list">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                        <circle cx="9" cy="7" r="4" />
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                    </svg>
                                    <span>Danh sch bn b</span>
                                </li>
                                <li class="friends-nav-item" data-friends-page="groups">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M3 7V5a2 2 0 0 1 2-2h2" />
                                        <path d="M17 3h2a2 2 0 0 1 2 2v2" />
                                        <path d="M21 17v2a2 2 0 0 1-2 2h-2" />
                                        <path d="M7 21H5a2 2 0 0 1-2-2v-2" />
                                        <rect x="7" y="7" width="10" height="10" rx="1" />
                                        <path d="M12 11v6" />
                                        <path d="M9 14h6" />
                                    </svg>
                                    <span>Danh sch nhm</span>
                                </li>
                                <li class="friends-nav-item" data-friends-page="requests">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                        <circle cx="9" cy="7" r="4" />
                                        <line x1="19" x2="19" y1="8" y2="14" />
                                        <line x1="22" x2="16" y1="11" y2="11" />
                                    </svg>
                                    <span>Li mi kt bn</span>
                                    <span id="friend-request-count-badge" class="nav-badge"
                                        style="display: none;">0</span>
                                </li>
                            </ul>
                    </nav>

                    <div class="friends-content-area">
                        <div class="friends-content-page active" id="friends-page-list">
                            <div class="friends-content-header">
                                <h2 id="friends-count-title">Bn b (0)</h2>
                                <div class="friends-content-filters">
                                    <input type="text" id="friends-list-search" class="friends-list-search-input"
                                        placeholder="Tm bn...">

                                </div>
                            </div>
                            <div class="friends-list-container" id="friends-list-alphabetical">
                                <p class="friends-list-placeholder">ang ti danh sch bn b...</p>
                            </div>
                        </div>

                        <div class="friends-content-page" id="friends-page-groups" style="display: none;">
                            <div class="friends-content-header">
                                <h2>Danh sch nhm v cng ng</h2>
                            </div>
                            <div class="friends-list-container" id="friends-groups-list">
                                <p class="friends-list-placeholder">Tnh nng ang pht trin.</p>
                            </div>
                        </div>

                        <div class="friends-content-page" id="friends-page-requests" style="display: none;">
                            <div class="friends-content-header">
                                <h2>Li mi kt bn</h2>
                            </div>
                            <div class="friends-list-container" id="friends-requests-list-page">
                                <p class="friends-list-placeholder">ang ti li mi...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-view wall-view" data-view="wall">
                <div id="wall-loader">
                    <div
                        style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">
                    </div>
                </div>
                <iframe id="wall-iframe" src="about:blank" frameborder="0"></iframe>
            </div>

        </main>
    </div>

    <div id="page-loader" style="display: none !important;">
        <div class="loader-content">
            <div class="loader-logo">Q</div>
            <p class="loader-text">ang ti d liu...</p>
            <div class="loader-progress-bar">
                <div class="loader-progress"></div>
            </div>
        </div>
        <div class="loader-footer">
            <p class="loader-tip"> Mo: ang ti mo...</p>
            <div class="loader-info">
                <span id="loader-version">Ver: ...</span>
                <span id="loader-open-id">Open ID: ...</span>
                <span id="loader-time">--:--:-- UTC+0</span>
            </div>
        </div>
    </div>
</body>
<script type="module">

    const loadingTips = [
        "Mo: Bn c th nhn chut phi vo tin nhn  tr li, thu hi hoc th cm xc!",
        "Mo: Nhn vo UID  gc di bn tri  sao chp ID ca bn.",
        "Mo: Bn c th i tn bn b bng cch nhn vo nt 'Thng tin' () trong chat.",
        "Mo: S dng @  tag bn b trong nhm chat.",
        "Mo: Ti nh ln bng cch dn (Paste) nh trc tip vo  chat."
    ];
    const MIN_LOADING_TIME = 3000;
    const startTime = Date.now();

    function showRandomTip() {
        const tipElement = document.querySelector("#page-loader .loader-tip");
        if (tipElement) {
            const randomIndex = Math.floor(Math.random() * loadingTips.length);
            tipElement.textContent = ` ${loadingTips[randomIndex]}`;
        }
    }
    function updateLoaderTime() {
        const timeElement = document.getElementById('loader-time');
        if (!timeElement) return;
        const now = new Date();
        const hours = String(now.getUTCHours()).padStart(2, '0');
        const minutes = String(now.getUTCMinutes()).padStart(2, '0');
        const seconds = String(now.getUTCSeconds()).padStart(2, '0');
        timeElement.textContent = `${hours}:${minutes}:${seconds} UTC+0`;
    }
    showRandomTip();
    updateLoaderTime();
    setInterval(updateLoaderTime, 1000);

    function generateOpenID(uid) {
        if (!uid || uid.length < 5) return "RANDOM_ID_123";
        const uidPart = uid.substring(0, 5);
        let randomPart = '';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        for (let i = 0; i < 7; i++) {
            randomPart += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return `${randomPart}${uidPart}`;
    }

    function hideLoader() {
        const endTime = Date.now();
        const timeElapsed = endTime - startTime;
        const timeRemaining = MIN_LOADING_TIME - timeElapsed;
        if (timeRemaining > 0) {
            setTimeout(() => {
                document.body.classList.add('loaded');
            }, timeRemaining);
        } else {
            document.body.classList.add('loaded');
        }
    }


    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
        getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc,
        collection, query, where, onSnapshot, serverTimestamp, limit, arrayUnion, arrayRemove, deleteField, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import {
        getDatabase, ref, onValue, onChildAdded, onChildChanged, push, update as rtdbUpdate,
        set, onDisconnect, serverTimestamp as dbServerTimestamp, off, remove,
        query as rtdbQuery, orderByChild, limitToLast, get
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    // import { getRemoteConfig, fetchAndActivate, getBoolean, getValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-remote-config.js"; // Nu dng Remote Config

    const firebaseConfig = {
        apiKey: "AIzaSyBPEMno1uZFg4uVXZjz-PbBR37gH6-3t5Y",
        authDomain: "confe-web.firebaseapp.com",
        databaseURL: "https://confe-web-default-rtdb.firebaseio.com",
        projectId: "confe-web",
        storageBucket: "confe-web.appspot.com",
        messagingSenderId: "677778119372",
        appId: "1:677778119372:web:ee3f1132871332743b0069"
    };
    const IMGBB_API_KEY = "e6c2724ff8344c073410da4876c3d35f"; // API Key ImgBB

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    // const remoteConfig = getRemoteConfig(app); // Nu dng

    const appRoot = document.getElementById('app');
    const navButtons = document.querySelectorAll('.app-nav .nav-button');
    const appViews = document.querySelectorAll('.app-main .app-view');
    const wallIframe = document.getElementById('wall-iframe');
    const navAvatar = document.getElementById('nav-avatar');
    const navSettingsMenu = document.getElementById('nav-settings-menu');
    const sidebar = document.getElementById('sidebar');
    const chatListElement = document.getElementById('chat-list');
    const addBtn = document.getElementById('add-btn');
    const addMenu = document.getElementById('add-menu');
    const globalSearch = document.getElementById('global-search');
    const searchDropdown = document.getElementById('search-dropdown');
    const openFriendReqBtn = document.getElementById('open-friend-req-btn');
    const chatWindow = document.getElementById('chat-window');
    const chatHeader = document.getElementById('chat-header');
    const currentChatAvatar = document.getElementById('current-chat-avatar');
    const currentChatFriendName = document.getElementById('current-chat-friend-name');
    const peerInfoExtra = document.getElementById('peer-info-extra');
    const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');
    const messagesContainer = document.getElementById('messages-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const imageInput = document.getElementById('image-input');
    const chatInputContainer = document.querySelector('.chat-input');
    const chatInfoPanel = document.getElementById('chat-info-panel');
    const openInfoBtn = document.getElementById('open-info-btn');
    const groupInfoBtn = document.getElementById('group-info-btn');
    const closeInfoBtn = document.getElementById('close-info-btn');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
    const replyPreviewContainer = document.getElementById('reply-preview-container');
    const replyPreviewSender = document.getElementById('reply-preview-sender');
    const replyPreviewText = document.getElementById('reply-preview-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const editPreviewContainer = document.getElementById('edit-preview-container');
    const editPreviewText = document.getElementById('edit-preview-text');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const inactiveChatIndicator = document.getElementById('inactive-chat-indicator');
    const messageContextMenu = document.getElementById('message-context-menu');
    const imageLightbox = document.getElementById('image-lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCloseBtn = document.querySelector('.lightbox-close-btn');
    const toast = document.getElementById('toast');
    let currentStatusUnsub = null; // <<< THM BIN NY
    const toastMessage = document.getElementById('toast-message');
    const toastCloseBtn = document.getElementById('toast-close-btn');
    const mentionSuggestions = document.getElementById('mention-suggestions');
    const reactionsModal = document.getElementById('reactions-modal');
    const reactionsList = document.getElementById('reactions-list');
    const closeReactionsModal = document.getElementById('close-reactions-modal');
    const friendReqModal = document.getElementById('friend-request-modal');
    const friendReqList = document.getElementById('friend-request-list');
    const lightboxDownloadBtn = document.getElementById('lightbox-download-btn');
    const lightboxThumbnailsContainer = document.getElementById('lightbox-thumbnails-container');
    const lightboxThumbnailsList = document.getElementById('lightbox-thumbnails-list');
    const closeFriendReqModal = document.getElementById('close-friend-req-modal');
    const createGroupModal = document.getElementById('create-group-modal');
    const closeGroupModalBtn = document.getElementById('close-group-modal-btn');
    const groupNameInput = document.getElementById('group-name-input');
    const groupMembersChecklist = document.getElementById('group-members-checklist');
    const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');
    const editProfileModal = document.getElementById('edit-profile-modal');
    const profileDisplayName = document.getElementById('profile-display-name');
    const profileBio = document.getElementById('profile-bio');
    const profileAvatarUrl = document.getElementById('profile-avatar-url');
    const saveProfileEditBtn = document.getElementById('save-profile-edit-btn');
    const cancelProfileEditBtn = document.getElementById('cancel-profile-edit-btn');
    const confirmModal = document.getElementById('custom-confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const reportUserModal = document.getElementById('report-user-modal');
    const reportingUserName = document.getElementById('reporting-user-name');
    const submitReportBtn = document.getElementById('submit-report-btn');
    const cancelReportBtn = document.getElementById('cancel-report-btn');
    const reportDetails = document.getElementById('report-details');
    const attachEvidenceBtn = document.getElementById('attach-evidence-btn');
    const evidencePreview = document.getElementById('evidence-preview');
    const selectionBar = document.getElementById('selection-bar');
    const selectionCount = document.getElementById('selection-count');
    const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
    const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
    const friendInfoContent = document.getElementById('friend-info-content');
    const friendAvatarInfo = document.getElementById('chat-friend-avatar-info');
    const friendNameInfo = document.getElementById('chat-friend-name-info');
    const sentImagesGrid = document.getElementById('sent-images-grid');
    const blockUserBtn = document.getElementById('block-user-btn');
    const unblockUserBtn = document.getElementById('unblock-user-btn');
    const removeFriendBtn = document.getElementById('remove-friend-btn');
    const groupInfoContent = document.getElementById('group-info-content');
    const groupAvatarInfo = document.getElementById('group-avatar');
    const groupNameDisplayInfo = document.getElementById('group-name-display');
    const groupMembersList = document.getElementById('group-members-list');
    const groupSentImagesGrid = document.getElementById('group-sent-images-grid');
    const leaveGroupBtn = document.getElementById('leave-group-btn');
    const changelogModal = document.getElementById('changelog-modal');
    const changelogContent = document.getElementById('changelog-content');
    const closeChangelogModalBtn = document.getElementById('close-changelog-modal');
    const showChangelogBtn = document.getElementById('show-changelog-btn');
    const announcementOverlay = document.getElementById('announcement-overlay');
    let currentChatImages = []; // Mng cha {url, key} ca nh trong chat hin ti
    let currentLightboxIndex = -1; // Index ca nh ang xem trong currentChatImages
    const announcementPopup = document.getElementById('announcement-popup');
    const announcementTitle = document.getElementById('announcement-title');
    const announcementImage = document.getElementById('announcement-image');
    const announcementText = document.getElementById('announcement-text');
    const closeAnnouncementBtn = document.getElementById('close-announcement-btn');
    const reportBugModal = document.getElementById('report-bug-modal');
    const openReportBugModalBtn = document.getElementById('open-report-bug-modal');
    const cancelReportBugBtn = document.getElementById('cancel-report-bug-btn');
    const submitBugReportBtn = document.getElementById('submit-bug-report-btn');
    const bugDescription = document.getElementById('bug-description');
    const bugSteps = document.getElementById('bug-steps');
    const aboutModal = document.getElementById('about-modal');
    const openAboutModalBtn = document.getElementById('open-about-modal');
    const closeAboutModalBtn = document.getElementById('close-about-modal-btn');
    const editNicknameBtn = document.getElementById('edit-nickname-btn');
    const friendNameDisplayArea = document.getElementById('friend-name-display-area');
    const friendNameEditArea = document.getElementById('friend-name-edit-area');
    const nicknameInput = document.getElementById('nickname-input');
    const saveNicknameBtn = document.getElementById('save-nickname-btn');
    const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
    const toggleMuteBtnFriend = document.getElementById('toggle-mute-btn-friend');
    const muteIconOnFriend = document.getElementById('mute-icon-on-friend');
    const muteIconOffFriend = document.getElementById('mute-icon-off-friend');
    const muteBtnTextFriend = document.getElementById('mute-btn-text-friend');
    const toggleMuteBtnGroup = document.getElementById('toggle-mute-btn-group');
    const muteIconOnGroup = document.getElementById('mute-icon-on-group');
    const muteIconOffGroup = document.getElementById('mute-icon-off-group');
    const muteBtnTextGroup = document.getElementById('mute-btn-text-group');
    const editGroupModal = document.getElementById('edit-group-modal');
    const editGroupNameInput = document.getElementById('edit-group-name-input');
    const editGroupAvatarInput = document.getElementById('edit-group-avatar-input');
    const editGroupAvatarPreview = document.getElementById('edit-group-avatar-preview');
    const editGroupAvatarLoading = document.getElementById('edit-group-avatar-loading');
    const groupAvatarUploadInput = document.getElementById('group-avatar-upload-input');
    const saveEditGroupBtn = document.getElementById('save-edit-group-btn');
    const cancelEditGroupBtn = document.getElementById('cancel-edit-group-btn');
    const addMemberBtn = document.getElementById('add-group-member-btn');
    const addMemberModal = document.getElementById('add-member-modal');
    const addMemberGroupName = document.getElementById('add-member-group-name');
    const addMemberFriendList = document.getElementById('add-member-friend-list');
    const confirmAddMemberBtn = document.getElementById('confirm-add-member-btn');
    const cancelAddMemberBtn = document.getElementById('cancel-add-member-btn');
    const disbandGroupBtn = document.getElementById('disband-group-btn');
    const wallLoader = document.getElementById('wall-loader');
    const friendsListElement = document.getElementById('friends-tab-list');
    const friendsSearchInput = document.getElementById('friends-search-input');

    let currentUser = null;
    let currentUserData = {};
    let currentFriends = []; // Mng UID bn b
    let friends = []; // Mng object bn b y  thng tin
    let currentChatId = null;
    let currentChatType = null;
    let currentFriendUid = null;
    let currentChatPeerData = null; // Data ca ngi ang chat cng (direct)
    let typingTimer;
    let typingUnsub = null;
    let msgsUnsub = null;
    let currentGroupMembers = []; // Thnh vin nhm hin ti
    let selectedImageFile = null;
    let replyingTo = null;
    let editingMessageKey = null;
    let isEditing = false;
    let lastMessageDate = null;
    let unreadCount = 0;
    const originalTitle = document.title;
    let userListenerUnsubscribe = null; // Listener cho data user hin ti
    let groupsListenerUnsubscribe = null; // Listener cho danh sch nhm user tham gia
    let allChats = []; // Mng cha thng tin tt c chat (direct + group)  sort
    let chatListeners = {}; // Lu cc listener ca last message v status
    let wallLoaded = false; // C check xem wall  load ln no cha
    let reportingUser = null; // Lu thng tin ngi b bo co
    let selectedEvidence = []; // Lu tin nhn bng chng khi bo co
    const userCache = {}; // Cache thng tin user
    const APP_VERSION = "1.3"; // << THM DNG NY (Sa s phin bn nu cn)

    // === D LIU CHANGELOG ===
    const changelogData = [
        {
            version: "1.0",
            date: "18/10/2025",
            subtitle: "Bn pht hnh chnh thc u tin!",
            details: [
                "Qola  chnh thc ra mt !",
                "Bn c th chat vi bn b v tham gia cc nhm chat !"
            ]
        }
    ];

    // Hm khi ng cc thnh phn chnh ca app sau khi xc thc v kim tra h s
    function initializeAppLogic(user, userData) {
        if (!appRoot) { console.error("initializeAppLogic: appRoot not found!"); return; }
        appRoot.style.display = 'flex'; // Hin giao din chnh
        showChatPlaceholder(); // <<< THM DNG NY

        const uidDisplay = document.getElementById('user-uid-display');
        const versionDisplay = document.getElementById('app-version-display');

        if (uidDisplay) {
            uidDisplay.textContent = user.uid; // Cp nht UID
            // Gn s kin click  copy
            uidDisplay.onclick = () => {
                navigator.clipboard.writeText(user.uid)
                    .then(() => {
                        showToast(" sao chp UID!", "success"); // Thng bo thnh cng
                    })
                    .catch(err => {
                        console.error('Li sao chp UID:', err);
                        showToast("Li sao chp UID!", "error"); // Thng bo li
                    });
            };
        }
        if (versionDisplay) {
            versionDisplay.textContent = APP_VERSION; // Cp nht Version
        }
        startUpdatingUTCTime(); // Bt u cp nht gi (t  y l )

        setupPresence(user.uid, userData.hideOnlineStatus); // Thit lp trng thi online/offline
        wireProfile(); // Cp nht avatar trn thanh nav
        loadAndSortChats(); // Ti danh sch chat ban u
        attachEventListeners(); // Gn cc s kin click, input...

        // Chuyn view da trn URL param ?view=...
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        if (viewParam) {
            const btn = document.querySelector(`.nav-button[data-view="${viewParam}"]`);
            if (btn) setTimeout(() => btn.click(), 50);
        }
        attachGlobalSearch(); // Kch hot thanh tm kim
        handleUrlChat(); // X l nu c link chat trc tip trong URL
        listenForNotifications_Optimized(); // Bt u lng nghe thng bo mi
        loadFriendRequests(); // Ti li mi kt bn ( hin chm  nu c)

        // M kha cc thnh phn UI
        if (messageInput) {
            messageInput.disabled = false;
            messageInput.placeholder = "Nhp tin nhn...";
        }
        if (sidebar) {
            sidebar.style.pointerEvents = 'auto'; // Cho php click trn sidebar
        }
        // Gi hm x l popup thng bo nu c
        // handleAnnouncementPopup(); // B comment nu cu dng Remote Config
    }

    function showChatPlaceholder() {
        if (currentChatFriendName) currentChatFriendName.textContent = "Chn cuc tr chuyn";
        if (currentChatAvatar) currentChatAvatar.style.display = 'none';
        if (openInfoBtn) openInfoBtn.style.display = 'none';
        if (groupInfoBtn) groupInfoBtn.style.display = 'none';
        if (document.getElementById('chat-header-last-seen')) document.getElementById('chat-header-last-seen').textContent = '';

        const placeholder = document.getElementById('chat-window-placeholder');
        const msgContainer = document.getElementById('messages-container');
        const chatInput = document.querySelector('.chat-input');
        const inactiveIndicator = document.getElementById('inactive-chat-indicator');

        if (placeholder) placeholder.style.display = 'flex';
        if (msgContainer) msgContainer.style.display = 'none';
        if (chatInput) chatInput.style.display = 'none';
        if (inactiveIndicator) inactiveIndicator.style.display = 'none';

        currentChatId = null;
        currentChatType = null;
        currentFriendUid = null;
    }

    // Lng nghe thay i trng thi ng nhp
    onAuthStateChanged(auth, async (user) => {
        // 1. Cha ng nhp -> V trang login
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        // 2. Ly d liu user t Firestore
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);

        // 3. User khng tn ti trong DB, b kha, hoc cn setup -> V trang login/setup
        if (!userDocSnap.exists() || userDocSnap.data().isDeactivated === true || userDocSnap.data().needsSetup === true) {
            await signOut(auth); // ng xut trc khi chuyn trang
            // Nu cn setup th chuyn sang setup.html, cn li v login
            if (userDocSnap.exists() && userDocSnap.data().needsSetup === true) {
                window.location.href = 'setup.html';
            } else {
                window.location.href = 'login.html';
            }
            return;
        }

        // 4. Gn bin global khi user hp l
        const userData = userDocSnap.data();
        document.getElementById('loader-version').textContent = `Ver: ${APP_VERSION}`;
        let userAgent = navigator.userAgent;
        const openIdElement = document.getElementById('loader-open-id');
        openIdElement.title = userAgent;

        if (userAgent.length > 50) {
            userAgent = userAgent.substring(0, 50) + "...";
        }
        openIdElement.textContent = `Agent: ${userAgent}`;
        hideLoader();
        currentUser = user;
        currentUserData = userData;

        // // Optional: X l Remote Config (nu dng)
        // try {
        //     await fetchAndActivate(remoteConfig);
        //     const isMaintenance = getBoolean(remoteConfig, "is_maintenance_mode");
        //     if (isMaintenance) {
        //         showMaintenancePopup(); // Hin popup bo tr v dng
        //         return;
        //     }
        // } catch (err) {
        //     console.error("Error fetching remote config:", err);
        // }

        // 5. B qua kim tra h s, gn gi tr mc nh nu thiu v khi ng app
        if (!userData.displayName) userData.displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ngi dng');
        if (!userData.avatarUrl) userData.avatarUrl = user.photoURL || "https://placehold.co/40x40";
        setupPresence(user.uid, userData.hideOnlineStatus);
        wireProfile();
        initializeAppLogic(user, userData);
    });

    /**
     * nh dng timestamp thnh chui "Last seen".
     * S khng hin th "ang hot ng" nu displayAsOnline l false.
     * S khng hin th trng thi gn y ("va mi", "x pht trc") nu showDetailedRecency l false.
     * @param {boolean} displayAsOnline C nn hin th l ang online khng.
     * @param {number} timestamp Thi gian (milliseconds).
     * @param {boolean} [showDetailedRecency=true] C nn hin th chi tit thi gian gn y khng.
     * @returns {string} Chui  nh dng.
     */
    function formatLastSeen(displayAsOnline, timestamp, showDetailedRecency = true) {
        // u tin hin th "ang hot ng" nu c php
        if (displayAsOnline) {
            return "ang hot ng";
        }

        // Nu khng c timestamp (offline lu)
        if (!timestamp) {
            return "Khng c thng tin";
        }

        const now = new Date();
        const lastSeenDate = new Date(timestamp);
        const diffSeconds = Math.floor((now - lastSeenDate) / 1000);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);

        if (!showDetailedRecency) {
            // Nu l ngy hm nay -> Hin th "ln cui lc HH:MM"
            if (diffHours < 24 && now.getDate() === lastSeenDate.getDate()) {
                const hours = String(lastSeenDate.getHours()).padStart(2, '0');
                const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
                return `Truy cp ln cui lc ${hours}:${minutes}`;
            }
            // Nu l hm qua -> Hin th "hm qua lc HH:MM"
            if (diffHours < 48 && now.getDate() - lastSeenDate.getDate() === 1) {
                const hours = String(lastSeenDate.getHours()).padStart(2, '0');
                const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
                return `Truy cp hm qua lc ${hours}:${minutes}`;
            }
            // Nu lu hn -> Hin th ngy/thng/nm
            const day = String(lastSeenDate.getDate()).padStart(2, '0');
            const month = String(lastSeenDate.getMonth() + 1).padStart(2, '0');
            const year = lastSeenDate.getFullYear();
            return `Truy cp ln cui ${day}/${month}/${year}`;
            // Hoc c th tr v "Khng c thng tin" nu mun n hon ton thi gian gn y?
            // return "Khng c thng tin";
        }

        if (diffSeconds < 60) return "Va mi truy cp";
        if (diffMinutes < 60) return `Truy cp ${diffMinutes} pht trc`;
        // Trong cng ngy -> "ln cui lc HH:MM"
        if (diffHours < 24 && now.getDate() === lastSeenDate.getDate()) {
            const hours = String(lastSeenDate.getHours()).padStart(2, '0');
            const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
            return `Truy cp ln cui lc ${hours}:${minutes}`;
        }
        // Hm qua -> "hm qua lc HH:MM"
        if (diffHours < 48 && now.getDate() - lastSeenDate.getDate() === 1) {
            const hours = String(lastSeenDate.getHours()).padStart(2, '0');
            const minutes = String(lastSeenDate.getMinutes()).padStart(2, '0');
            return `Truy cp hm qua lc ${hours}:${minutes}`;
        }
        // Lu hn -> Ngy/thng/nm
        const day = String(lastSeenDate.getDate()).padStart(2, '0');
        const month = String(lastSeenDate.getMonth() + 1).padStart(2, '0');
        const year = lastSeenDate.getFullYear();
        return `Truy cp ln cui ${day}/${month}/${year}`;
    }

    let intervalId = null; // Bin  lu ID ca setInterval

    // Hm cp nht gi ln UI
    function updateUTCTimeDisplay() {
        const utcTimeDisplay = document.getElementById('utc-time-display');
        if (!utcTimeDisplay) {
            console.warn("UTC time display element not found.");
            if (intervalId) clearInterval(intervalId); // Dng nu element bin mt
            return;
        }
        const now = new Date();
        // Ly gi, pht, giy UTC
        const hours = String(now.getUTCHours()).padStart(2, '0');
        const minutes = String(now.getUTCMinutes()).padStart(2, '0');
        const seconds = String(now.getUTCSeconds()).padStart(2, '0');
        utcTimeDisplay.textContent = `${hours}:${minutes}:${seconds} UTC+0`;
    }

    // Hm bt u cp nht gi mi giy
    function startUpdatingUTCTime() {
        if (intervalId) clearInterval(intervalId); // Xa interval c nu c
        updateUTCTimeDisplay(); // Cp nht ln u ngay lp tc
        intervalId = setInterval(updateUTCTimeDisplay, 1000); // Cp nht mi giy
    }

    // Khi to theme (dark/light) da vo localStorage
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Mc nh l dark

    }

    // Chuyn i k t c bit HTML thnh dng an ton
    function escapeHtml(unsafeString) {
        if (typeof unsafeString !== 'string') {
            return ''; // Tr v chui rng nu u vo khng phi string
        }
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;' // Hoc &apos;
        };
        return unsafeString.replace(/[&<>"']/g, char => map[char]);
    }

    // To HTML cho du tick xanh (nu user  xc minh)
    function createVerifiedTickHTML(isVerified) {
        return isVerified ? '<span class="verified-tick"></span>' : '';
    }

    window.showToast = function (msg, type = 'info') {
        let icon = "";
        if (type === "success") icon = "";
        else if (type === "error" || type === "danger") icon = "";
        else if (type === "warning") icon = "";

        let container = document.getElementById("toastContainer");
        if (!container) {
            container = document.createElement("div");
            container.id = "toastContainer";
            container.className = "toast-container";
            document.body.appendChild(container);
        }
        const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `${icon} ${msg}`;
        container.appendChild(t);
        setTimeout(() => { t.classList.add('show'); }, 10);
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
    }

    // Hin th modal xc nhn (Yes/No) v tr v Promise (true/false)
    function showConfirmation(message) {
        return new Promise(resolve => {
            // u tin dng modal nu c
            if (confirmMessage && confirmModal && confirmOkBtn && confirmCancelBtn) {
                confirmMessage.textContent = message;
                confirmModal.style.display = 'flex'; // Hin modal

                // Gn s kin ch chy 1 ln cho nt OK v Cancel
                confirmOkBtn.onclick = () => {
                    confirmModal.style.display = 'none'; // n modal
                    resolve(true); // Tr v true khi bm OK
                };
                confirmCancelBtn.onclick = () => {
                    confirmModal.style.display = 'none'; // n modal
                    resolve(false); // Tr v false khi bm Cancel
                };
                // Optional: ng khi bm ra ngoi modal overlay
                confirmModal.onclick = (e) => {
                    if (e.target === confirmModal) {
                        confirmModal.style.display = 'none';
                        resolve(false); // Coi nh bm Cancel
                    }
                };
            } else {
                // Fallback: Dng window.confirm ca trnh duyt
                console.warn("Confirmation modal elements not found, using window.confirm.");
                resolve(window.confirm(message));
            }
        });
    }

    async function addFriendByEmail() {
        // 1. Ly DOM elements
        const emailInput = document.getElementById('add-friend-email-input');
        const addFriendModal = document.getElementById('add-friend-modal'); // m bo ID ny ng
        const confirmBtn = document.getElementById('confirm-add-friend-btn');

        // Kim tra elements tn ti
        if (!emailInput || !addFriendModal || !confirmBtn) {
            console.error("Missing elements for add friend modal!");
            showToast("Li giao din, khng th thm bn b.", "error");
            return;
        }

        const email = emailInput.value.trim().toLowerCase();

        if (!email) {
            showToast("Vui lng nhp email.", "error");
            return;
        }

        confirmBtn.disabled = true;
        confirmBtn.textContent = "ang tm...";

        try {
            const q = query(collection(db, "users"), where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showToast("Khng tm thy ngi dng vi email ny.", "error");
            } else {
                const targetUser = querySnapshot.docs[0].data();
                const targetUid = querySnapshot.docs[0].id; // Ly UID t doc ID

                if (targetUid === currentUser.uid) {
                    showToast("y l email ca bn.", "error");
                } else {
                    // M trang profile trong tab mi
                    window.open(`profile.html?uid=${targetUid}`, '_blank');

                    // Dn dp modal
                    emailInput.value = '';
                    addFriendModal.style.display = 'none';
                }
            }
        } catch (err) {
            console.error("Li khi tm bn:", err);
            showToast(" xy ra li khi tm kim.", "error");
        } finally { // Dng finally  m bo nt c reset
            // Ch reset nu modal cha b ng (trng hp tm thy v m tab mi)
            if (addFriendModal.style.display !== 'none') {
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Tm kim";
            } else {
                // Nu modal  ng, vn nn reset trng thi nt phng trng hp m li
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Tm kim";
            }
        }
    }

    /**
     * Hin th thng tin chi tit ca bn b trong panel bn phi.
     * Bao gm avatar, tn, bit danh (nu c), nh  gi, nt mute, chn, xa bn, bo co.
     * @param {string} friendUid UID ca ngi bn cn hin th thng tin.
     */
    async function showFriendInfo(friendUid) {
        if (!friendInfoContent || !groupInfoContent) { console.error("Missing info panel content elements!"); return; }
        groupInfoContent.style.display = 'none'; // n panel nhm
        friendInfoContent.style.display = 'block'; // Hin panel bn b

        // Ly cc DOM element cn thit trong panel (cn thn trng tn vi bin global)
        const friendAvatarPanel = friendInfoContent.querySelector('.chat-info-avatar'); // i tn bin local
        const friendNamePanel = friendInfoContent.querySelector('#chat-friend-name-info'); // i tn bin local
        const nameDisplayAreaPanel = friendInfoContent.querySelector('#friend-name-display-area');
        const nameEditAreaPanel = friendInfoContent.querySelector('#friend-name-edit-area');
        const editNicknameBtnPanel = friendInfoContent.querySelector('#edit-nickname-btn');
        const nicknameInputPanel = friendInfoContent.querySelector('#nickname-input');
        const saveNicknameBtnPanel = friendInfoContent.querySelector('#save-nickname-btn');
        const cancelNicknameBtnPanel = friendInfoContent.querySelector('#cancel-nickname-btn');
        const sentImagesGridPanel = friendInfoContent.querySelector('#sent-images-grid');
        const toggleMuteBtnFriendPanel = friendInfoContent.querySelector('#toggle-mute-btn-friend');
        const muteIconOnFriendPanel = friendInfoContent.querySelector('#mute-icon-on-friend');
        const muteIconOffFriendPanel = friendInfoContent.querySelector('#mute-icon-off-friend');
        const muteBtnTextFriendPanel = friendInfoContent.querySelector('#mute-btn-text-friend');
        const blockUserBtnPanel = friendInfoContent.querySelector('#block-user-btn');
        const unblockUserBtnPanel = friendInfoContent.querySelector('#unblock-user-btn');
        const removeFriendBtnPanel = friendInfoContent.querySelector('#remove-friend-btn');
        const reportUserBtnPanel = friendInfoContent.querySelector('#report-user-btn');


        // Kim tra cc element quan trng
        if (!friendAvatarPanel || !friendNamePanel || !blockUserBtnPanel || !unblockUserBtnPanel || !removeFriendBtnPanel || !reportUserBtnPanel || !sentImagesGridPanel || !toggleMuteBtnFriendPanel) {
            console.error("Missing elements inside friend info panel!");
            return;
        }

        // Mc nh n vng sa tn
        if (nameDisplayAreaPanel) nameDisplayAreaPanel.style.display = 'flex';
        if (nameEditAreaPanel) nameEditAreaPanel.style.display = 'none';

        // Reset UI trc khi load data mi
        friendNamePanel.innerHTML = 'ang ti...';
        friendAvatarPanel.src = 'https://placehold.co/95x95';
        sentImagesGridPanel.innerHTML = '';
        blockUserBtnPanel.style.display = 'none';
        unblockUserBtnPanel.style.display = 'none';
        removeFriendBtnPanel.style.display = 'none';
        toggleMuteBtnFriendPanel.style.display = 'none';
        reportUserBtnPanel.style.display = 'none';


        // Ly thng tin ngi bn mi nht
        const friendDoc = await getDoc(doc(db, "users", friendUid));
        if (!friendDoc.exists()) {
            friendNamePanel.innerHTML = "Khng tm thy user";
            return; // Dng nu khng c user
        }

        const d = friendDoc.data();
        const isFriend = currentUserData.friends?.includes(friendUid);
        const isBlocked = currentUserData.blocked?.includes(friendUid);
        const verifiedTick = createVerifiedTickHTML(d.isVerified);
        const currentNickname = currentUserData.nicknames?.[friendUid];
        const displayName = currentNickname || d.displayName || d.email;
        const realName = d.displayName || d.email; // Lun gi tn tht

        // Hin th thng tin c bn
        friendNamePanel.innerHTML = `${escapeHtml(displayName)} ${verifiedTick}`;
        friendAvatarPanel.src = d.avatarUrl || `https://placehold.co/95x95/EFEFEF/333?text=${escapeHtml(realName[0].toUpperCase())}`;

        // Hin/n nt chn/b chn/xa bn
        removeFriendBtnPanel.style.display = isFriend ? 'block' : 'none';
        blockUserBtnPanel.style.display = !isBlocked ? 'block' : 'none';
        unblockUserBtnPanel.style.display = isBlocked ? 'block' : 'none';
        reportUserBtnPanel.style.display = 'block'; // Nt bo co lun hin
        toggleMuteBtnFriendPanel.style.display = 'block'; // Nt mute lun hin

        // Gn s kin cho cc nt hnh ng c bn
        blockUserBtnPanel.onclick = () => blockUser(friendUid, displayName);
        unblockUserBtnPanel.onclick = () => unblockUser(friendUid, displayName);
        reportUserBtnPanel.onclick = () => {
            reportingUser = { uid: friendUid, name: realName }; // Bo co bng tn tht
            if (reportingUserName && reportUserModal) {
                reportingUserName.textContent = `Bn ang bo co ${escapeHtml(realName)}.`;
                reportUserModal.style.display = 'flex';
            }
        };
        removeFriendBtnPanel.onclick = async () => { /* ... logic xa bn ... */
            const confirmed = await showConfirmation(`Bn chc chn mun xa "${escapeHtml(displayName)}" khi danh sch bn b?`);
            if (confirmed) {
                const meRef = doc(db, 'users', currentUser.uid);
                const friendRef = doc(db, 'users', friendUid);
                try {
                    await updateDoc(meRef, { friends: arrayRemove(friendUid), [`nicknames.${friendUid}`]: deleteField() });
                    await updateDoc(friendRef, { friends: arrayRemove(currentUser.uid) });
                    showToast(" xa bn.", 'success');
                    if (chatInfoPanel) chatInfoPanel.classList.remove('open');
                    const chatIdToRemove = [currentUser.uid, friendUid].sort().join('_');
                    if (currentChatId === chatIdToRemove) { /* Reset chat UI */
                        if (currentChatFriendName) currentChatFriendName.textContent = "Chn cuc tr chuyn";
                        if (messagesContainer) messagesContainer.innerHTML = '';
                        if (messageInput) messageInput.disabled = true; if (sendBtn) sendBtn.disabled = true;
                        currentChatId = null; currentChatType = null;
                        if (currentChatAvatar) currentChatAvatar.style.display = 'none';
                        if (openInfoBtn) openInfoBtn.style.display = 'none';
                        if (toggleMuteBtnFriendPanel) toggleMuteBtnFriendPanel.style.display = 'none';
                    }
                    // loadAndSortChats s t cp nht sidebar
                } catch (error) { console.error("Li khi xa bn:", error); showToast("C li xy ra khi xa bn."); }
            }
        };

        if (editNicknameBtnPanel && nameDisplayAreaPanel && nameEditAreaPanel && nicknameInputPanel && saveNicknameBtnPanel && cancelNicknameBtnPanel) {
            editNicknameBtnPanel.onclick = () => {
                nameDisplayAreaPanel.style.display = 'none';
                nameEditAreaPanel.style.display = 'block';
                nicknameInputPanel.value = currentNickname || '';
                nicknameInputPanel.placeholder = `t bit danh cho ${escapeHtml(realName)}`;
                nicknameInputPanel.focus();
            };
            cancelNicknameBtnPanel.onclick = () => {
                nameDisplayAreaPanel.style.display = 'flex';
                nameEditAreaPanel.style.display = 'none';
            };
            saveNicknameBtnPanel.onclick = async () => { /* ... logic lu nickname ... */
                const newNickname = nicknameInputPanel.value.trim();
                saveNicknameBtnPanel.disabled = true; saveNicknameBtnPanel.textContent = 'Lu...';
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const fieldName = `nicknames.${friendUid}`;
                    if (newNickname) {
                        await updateDoc(userRef, { [fieldName]: newNickname });
                        if (!currentUserData.nicknames) currentUserData.nicknames = {};
                        currentUserData.nicknames[friendUid] = newNickname;
                        showToast(" lu bit danh!", "success");
                    } else {
                        await updateDoc(userRef, { [fieldName]: deleteField() });
                        if (currentUserData.nicknames) delete currentUserData.nicknames[friendUid];
                        showToast(" xa bit danh.", "info");
                    }
                    const finalName = newNickname || realName;
                    friendNamePanel.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; // Cp nht tn trong panel
                    // Cp nht tn trn header nu ang chat vi ngi ny
                    const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
                    if (currentChatId === chatIdToCheck && currentChatFriendName) {
                        currentChatFriendName.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`;
                    }
                    // Cp nht tn trn sidebar nu c
                    const sidebarNameEl = document.getElementById(`sidebar-friend-name-${friendUid}`);
                    if (sidebarNameEl) { sidebarNameEl.innerHTML = `${escapeHtml(finalName)} ${verifiedTick}`; }
                    nameDisplayAreaPanel.style.display = 'flex'; nameEditAreaPanel.style.display = 'none'; // ng vng sa
                } catch (err) { console.error("Li lu nickname: ", err); showToast("Li!", "error"); }
                finally { saveNicknameBtnPanel.disabled = false; saveNicknameBtnPanel.textContent = 'Lu'; }
            };
        } else {
            console.warn("Missing nickname elements in friend info panel.");
        }

        if (toggleMuteBtnFriendPanel && muteIconOnFriendPanel && muteIconOffFriendPanel && muteBtnTextFriendPanel) {
            const chatIdForMute = [currentUser.uid, friendUid].sort().join('_');
            const isMutedFriend = currentUserData.mutedChats?.[chatIdForMute] === true;
            muteIconOnFriendPanel.style.display = isMutedFriend ? 'none' : 'inline-block';
            muteIconOffFriendPanel.style.display = isMutedFriend ? 'inline-block' : 'none';
            muteBtnTextFriendPanel.textContent = isMutedFriend ? "Bt thng bo" : "Tt thng bo";
            toggleMuteBtnFriendPanel.title = isMutedFriend ? "Bt thng bo" : "Tt thng bo";

            toggleMuteBtnFriendPanel.onclick = async () => { /* ... logic mute ... */
                const currentlyMuted = currentUserData.mutedChats?.[chatIdForMute] === true;
                const newMutedStatus = !currentlyMuted;
                toggleMuteBtnFriendPanel.disabled = true;
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const fieldName = `mutedChats.${chatIdForMute}`;
                    if (newMutedStatus) {
                        await updateDoc(userRef, { [fieldName]: true });
                        if (!currentUserData.mutedChats) currentUserData.mutedChats = {};
                        currentUserData.mutedChats[chatIdForMute] = true;
                        showToast(" tt thng bo cho cuc tr chuyn ny.", "info");
                    } else {
                        await updateDoc(userRef, { [fieldName]: deleteField() });
                        if (currentUserData.mutedChats) delete currentUserData.mutedChats[chatIdForMute];
                        showToast(" bt thng bo.", "success");
                    }
                    muteIconOnFriendPanel.style.display = newMutedStatus ? 'none' : 'inline-block';
                    muteIconOffFriendPanel.style.display = newMutedStatus ? 'inline-block' : 'none';
                    muteBtnTextFriendPanel.textContent = newMutedStatus ? "Bt thng bo" : "Tt thng bo";
                    toggleMuteBtnFriendPanel.title = newMutedStatus ? "Bt thng bo" : "Tt thng bo";
                } catch (err) { console.error("Li mute:", err); showToast("Li!", "error"); }
                finally { toggleMuteBtnFriendPanel.disabled = false; }
            };
        } else {
            console.warn("Missing mute elements in friend info panel.");
        }

        sentImagesGridPanel.innerHTML = ''; // Xa nh c
        const chatMsgRef = ref(rtdb, `/messages/${[currentUser.uid, friendUid].sort().join('_')}`);
        // Query ly nh mi nht (v d 9 nh)
        const imagesQuery = rtdbQuery(chatMsgRef, orderByChild('timestamp'), limitToLast(9));
        get(imagesQuery).then(snap => { // Dng get() thay onValue
            sentImagesGridPanel.innerHTML = ''; // Xa li ln na
            if (!snap.exists()) { sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Cha c nh no.</p>'; return; }
            const imageMsgs = [];
            snap.forEach((child) => { const msg = child.val(); if (msg.imageUrl) imageMsgs.push(msg.imageUrl); });
            imageMsgs.reverse().forEach(url => { // Hin th mi nht trc
                const img = document.createElement('img'); img.src = url; img.alt = "nh  gi";
                img.onclick = () => openLightbox(url);
                sentImagesGridPanel.appendChild(img);
            });
            if (imageMsgs.length === 0) {
                sentImagesGridPanel.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Cha c nh no.</p>';
            }
        }).catch(err => {
            console.error("Error fetching sent images:", err);
            sentImagesGridPanel.innerHTML = '<p style="color:red;">Li ti nh</p>';
        });
    }

    /**
     * Lng nghe danh sch li mi kt bn ang ch x l (pending) gi n user hin ti.
     * Hin th danh sch trong modal v cp nht chm  thng bo trn nt bn b.
     */
    function loadFriendRequests() {
        if (!currentUser) return;
        const q = query(collection(db, 'friend_requests'), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));

        onSnapshot(q, async (snap) => { // Thm async
            // Cp nht badge
            const badge = document.getElementById('friend-request-count-badge');
            if (badge) {
                badge.textContent = snap.empty ? '0' : snap.docs.length;
                badge.style.display = snap.empty ? 'none' : 'flex';
            }

            // Ly thng tin chi tit ca ngi gi (nu ang  trang Li mi)
            const requestsPage = document.getElementById('friends-page-requests');
            if (requestsPage && requestsPage.classList.contains('active')) {
                if (snap.empty) {
                    renderFriendRequestsPage([]); // Render mng rng
                    return;
                }

                // Ly data chi tit
                const requestsDataPromises = snap.docs.map(async (docSnap) => {
                    const req = docSnap.data();
                    try {
                        const userDoc = await getDoc(doc(db, 'users', req.from_uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            return {
                                id: docSnap.id,
                                ...req,
                                from_displayName: userData.displayName || req.from_email,
                                from_avatar: userData.avatarUrl
                            };
                        }
                    } catch (e) { console.error(e); }
                    return { id: docSnap.id, ...req }; // Fallback
                });

                const requestsData = await Promise.all(requestsDataPromises);
                renderFriendRequestsPage(requestsData); // Render vi data chi tit
            }
        });
    }

    // === HM MI: TI DATA CHO TRANG LI MI (khi click) ===
    async function loadFriendRequestsPage() {
        const listContainer = document.getElementById('friends-requests-list-page');
        if (!listContainer) return;
        listContainer.innerHTML = '<p class="friends-list-placeholder">ang ti li mi...</p>';

        // Chy query 1 ln (getDocs) thay v onSnapshot
        const q = query(collection(db, 'friend_requests'), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));
        const snap = await getDocs(q);

        if (snap.empty) {
            renderFriendRequestsPage([]);
            return;
        }

        const requestsDataPromises = snap.docs.map(async (docSnap) => {
            const req = docSnap.data();
            try {
                const userDoc = await getDoc(doc(db, 'users', req.from_uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    return { id: docSnap.id, ...req, from_displayName: userData.displayName || req.from_email, from_avatar: userData.avatarUrl };
                }
            } catch (e) { console.error(e); }
            return { id: docSnap.id, ...req }; // Fallback
        });

        const requestsData = await Promise.all(requestsDataPromises);
        renderFriendRequestsPage(requestsData);
    }
    /**
     * Lng nghe danh sch li mi kt bn ang ch x l (pending) gi n user hin ti.
     * Hin th danh sch trong modal v cp nht chm  thng bo trn nt bn b.
     */

    async function sendFriendRequest(targetUid) {
        if (!currentUser || !currentUserData) return Promise.reject(new Error("Cha ng nhp."));
        if (targetUid === currentUser.uid) return Promise.reject(new Error("Khng th gi li mi cho chnh mnh."));
        if (currentUserData.friends?.includes(targetUid)) return Promise.reject(new Error(" l bn b."));

        console.log(`Sending friend request to: ${targetUid}`);

        // Check if a request already exists (either direction)
        const q1 = query(collection(db, 'friend_requests'),
            where('from_uid', '==', currentUser.uid),
            where('to_uid', '==', targetUid),
            where('status', '==', 'pending')
        );
        const q2 = query(collection(db, 'friend_requests'),
            where('from_uid', '==', targetUid),
            where('to_uid', '==', currentUser.uid),
            where('status', '==', 'pending')
        );

        try {
            const [sentSnapshot, receivedSnapshot] = await Promise.all([getDocs(q1), getDocs(q2)]);

            if (!sentSnapshot.empty) {
                console.log("Request already sent.");
                return Promise.reject(new Error(" gi li mi trc ."));
            }
            if (!receivedSnapshot.empty) {
                console.log("Request already received.");
                return Promise.reject(new Error("Ngi ny  gi li mi cho bn. Kim tra danh sch li mi."));
            }

            // No existing pending request, create a new one
            console.log("Creating new friend request document...");
            await addDoc(collection(db, 'friend_requests'), {
                from_uid: currentUser.uid,
                from_email: currentUser.email, // Store sender email for display
                to_uid: targetUid,
                status: 'pending', // 'pending', 'accepted', 'declined'
                timestamp: serverTimestamp()
            });
            console.log("Friend request document created.");
            return Promise.resolve(" gi li mi kt bn!"); // Resolve on success

        } catch (error) {
            console.error("Error sending friend request:", error);
            return Promise.reject(new Error("Li gi li mi kt bn: " + error.message)); // Reject on error
        }
    }


    // Xin quyn hin th thng bo ca trnh duyt
    function requestSimpleNotificationPermission() {
        if (!("Notification" in window)) {
            alert("Trnh duyt ny khng h tr thng bo trn mn hnh.");
            return;
        }
        // Ch xin quyn nu cha c cp hoc b t chi trc 
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                    showToast(" bt thng bo trnh duyt!", "success");
                } else {
                    showToast("Bn  khng cho php nhn thng bo.", "error");
                }
            });
        } else {
            showToast("Thng bo trnh duyt  c bt t trc.", "info");
        }
    }

    // Hin th thng bo n gin ca trnh duyt
    function showSimpleNotification(senderName, messageText, avatarUrl) {
        if (Notification.permission !== "granted") return; // Ch hin khi  c cp quyn

        const options = {
            body: messageText,
            icon: avatarUrl || 'https://placehold.co/96x96?text=Q', // nh i din hoc placeholder
            // tag: 'qola-message', // Optional: Dng tag  gom thng bo
            // renotify: true,      // Optional: Rung/bo li nu tag ging nhau
        };

        // To thng bo mi
        const notification = new Notification(senderName, options);

        // Optional: ng thng bo sau vi giy
        setTimeout(notification.close.bind(notification), 5000); // T ng sau 5s

        // Optional: X l khi click vo thng bo (v d: m ca s chat)
        notification.onclick = () => {
            window.focus(); // Focus vo ca s trnh duyt
            // TODO: Thm logic chuyn n ng ca s chat nu cn
        };
    }

    /**
     * Thit lp trng thi online/offline cho user hin ti trong Realtime Database.
     * @param {string} uid User ID ca ngi dng hin ti.
     * @param {boolean} [isHidden=false] Nu true, user s lun hin th offline.
     */
    function setupPresence(uid, isHidden = false) {
        const statusRef = ref(rtdb, `/status/${uid}`); // ng dn n trng thi ca user

        // Nu ngi dng chn n trng thi -> Set offline v dng
        if (isHidden) {
            set(statusRef, { isOnline: false, last_seen: dbServerTimestamp() });
            console.log(`User ${uid} chose to hide status, set to offline.`);
            return; // Dng hm ti y
        }

        // Nu khng n -> Thit lp logic online/offline bnh thng
        const connectedRef = ref(rtdb, '.info/connected'); // Firebase connection status

        onValue(connectedRef, (snap) => {
            // Ch thc hin khi kt ni thnh cng (snap.val() === true)
            if (snap.val() === false) {
                // C th tm thi set offline  y nu mun,
                // nhng onDisconnect  x l khi mt kt ni t ngt
                return;
            }

            // Khi client mt kt ni (tt tab, mt mng), Firebase s t ng set offline
            onDisconnect(statusRef)
                .set({ isOnline: false, last_seen: dbServerTimestamp() })
                .then(() => {
                    // Sau khi thit lp onDisconnect thnh cng, set trng thi hin ti l online
                    set(statusRef, { isOnline: true, last_seen: dbServerTimestamp() });
                    console.log(`Presence setup complete for ${uid}. Status: Online.`);
                })
                .catch((err) => {
                    // Ignore PERMISSION_DENIED due to security rules
                });
        });
    }

    /**
     * Lng nghe thay i d liu ca user hin ti (v d: avatarUrl, hideOnlineStatus)
     * v cp nht giao din tng ng (v d: avatar trn thanh nav).
     */
    function wireProfile() {
        if (!currentUser || !navAvatar) {
            console.error("wireProfile: currentUser or navAvatar not available!");
            return; // Dng nu thiu thng tin
        }

        // Lng nghe thay i trn document ca user hin ti trong Firestore
        const userDocRef = doc(db, 'users', currentUser.uid);

        // S dng onSnapshot  t ng cp nht khi c thay i
        onSnapshot(userDocRef, (ds) => {
            if (!ds.exists()) {
                console.error("User document suddenly disappeared!");
                // C th x l ng xut  y nu cn
                return;
            }
            const userData = ds.data() || {}; // Ly data, phng trng hp rng

            // Cp nht avatar trn thanh nav
            const avatarSrc = userData.avatarUrl || `https://placehold.co/48x48/111/fff?text=${(userData.email || '?')[0].toUpperCase()}`;
            navAvatar.src = avatarSrc; // Cp nht src ca img#nav-avatar

            // Cp nht class 'is-hiding-status' trn body  CSS x l n chm xanh
            // (CSS cn c rule: body.is-hiding-status .status.online { background: #64748b; })
            document.body.classList.toggle('is-hiding-status', userData.hideOnlineStatus === true);

            // QUAN TRNG: Khng cp nht currentUserData  y na
            // Vic cp nht currentUserData s do listener trong loadAndSortChats x l
            //  trnh load li danh sch chat khng cn thit khi ch avatar thay i.

        }, (error) => {
            console.error("Error listening to user profile:", error);
            // C th hin th li cho ngi dng  y
        });
    }

    /**
     * Hm chnh  bt u qu trnh ti v lng nghe danh sch chat.
     * Gn listener cho d liu user hin ti v danh sch nhm user tham gia.
     * Khi c thay i (bn mi, nhm mi), s gi loadAndRebuildChatList.
     */
    async function loadAndSortChats() {
        if (!chatListElement || !currentUser || !currentUserData) {
            console.error("loadAndSortChats: Missing required elements or data.");
            return;
        }
        console.log("Running loadAndSortChats...");

        if (!userListenerUnsubscribe) {
            console.log("Attaching user listener...");
            const userDocRef = doc(db, 'users', currentUser.uid);
            userListenerUnsubscribe = onSnapshot(userDocRef, async (userDocSnap) => {
                console.log("User data snapshot received!");
                if (userDocSnap.exists()) {
                    const newUserData = userDocSnap.data();
                    const oldFriends = JSON.stringify(currentUserData.friends || []);
                    const newFriends = JSON.stringify(newUserData.friends || []);
                    currentUserData = newUserData; // Cp nht data mi nht

                    // Ly d liu chi tit ca bn b (quan trng cho cc hm khc)
                    const friendUIDs = currentUserData.friends || [];
                    const friendPromises = friendUIDs.map(uid => getDoc(doc(db, 'users', uid)));
                    const friendDocs = await Promise.all(friendPromises);
                    friends = friendDocs // Cp nht bin global 'friends'
                        .filter(snap => snap.exists())
                        .map(snap => ({ uid: snap.id, ...snap.data() }));
                    currentFriends = currentUserData.friends || []; // Cp nht mng UID bn b

                    // Ch load li list nu danh sch bn b THAY I
                    if (oldFriends !== newFriends) {
                        console.log("Friend list changed, reloading chat list...");
                        await loadAndRebuildChatList(); // Load li list khi bn b thay i
                    } else {
                        // Nu bn b khng i, ch cp nht UI ph
                        wireProfile(); // Cp nht avatar nav
                        document.body.classList.toggle('is-hiding-status', currentUserData.hideOnlineStatus === true);
                    }
                } else {
                    console.error("User document does not exist!");
                    await signOut(auth); window.location.href = 'login.html';
                }
            }, (error) => {
                console.error("Error listening to user document:", error);
            });
        }

        if (!groupsListenerUnsubscribe) {
            console.log("Attaching groups listener...");
            const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
            groupsListenerUnsubscribe = onSnapshot(groupsQuery, async (querySnapshot) => {
                console.log("Groups data snapshot received!");
                // Lun load li list khi nhm thay i (tn, thnh vin, avatar...)
                await loadAndRebuildChatList();
            }, (error) => {
                console.error("Error listening to groups collection:", error);
            });
        }

        await loadAndRebuildChatList();
    }

    /**
     * Hm ny ly d liu bn b v nhm, to mng allChats,
     * sau  gn listener cho tin nhn cui v trng thi online ca tng chat.
     */
    async function loadAndRebuildChatList() {
        if (!chatListElement || !currentUser || !currentUserData || !db || !rtdb) {
            console.error("loadAndRebuildChatList: Missing required elements or data.");
            return;
        }
        console.log("--- Starting loadAndRebuildChatList ---");

        // Hin skeleton loading
        if (sidebar) sidebar.classList.remove('loaded');
        chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">ang cp nht danh sch...</li>';

        // Hy listener last message & status C
        console.log("Clearing old listeners...");
        Object.entries(chatListeners).forEach(([key, unsub]) => {
            try { unsub(); } catch (e) { console.warn(`Error unsubscribing ${key}:`, e); }
            delete chatListeners[key];
        });
        console.log("Old listeners cleared.");
        allChats = []; // Reset mng chat

        try {
            // Ly danh sch bn b T currentUserData MI NHT
            const friendUIDs = currentUserData.friends || [];
            console.log("Friend UIDs from currentUserData:", friendUIDs);

            // Ly danh sch nhm T Firestore
            console.log("Fetching groups from Firestore...");
            const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
            const groupSnap = await getDocs(groupsQuery);
            console.log("Fetched groups:", groupSnap.docs.length);

            // To danh sch chat ban u (Promise cho bn b)
            const friendPromises = friendUIDs.map(async (uid) => {
                console.log("Processing friend UID:", uid);
                try {
                    const userDoc = await getDoc(doc(db, 'users', uid));
                    if (userDoc.exists()) {
                        const u = userDoc.data();
                        // Cp nht cache nu cha c hoc data c
                        userCache[uid] = { displayName: u.displayName, avatarUrl: u.avatarUrl, isVerified: u.isVerified };

                        const chatId = [currentUser.uid, uid].sort().join('_');
                        if (!allChats.some(chat => chat.id === chatId)) { // Chng trng lp
                            allChats.push({
                                id: chatId,
                                peerUid: uid,
                                name: u.displayName || u.email || 'Ngi dng',
                                avatarUrl: u.avatarUrl,
                                isVerified: u.isVerified || false,
                                type: 'direct',
                                lastMessageTimestamp: 0,
                                lastMessagePreview: '...'
                            });
                            console.log("Added direct chat to allChats:", chatId);
                        }
                    } else {
                        console.warn("Friend document does not exist for UID:", uid);
                    }
                } catch (friendError) {
                    console.error("Error fetching friend data for UID:", uid, friendError);
                }
            });

            // X l nhm
            groupSnap.docs.forEach(docSnap => {
                const g = docSnap.data();
                const groupId = docSnap.id;
                console.log("Processing group ID:", groupId);
                if (!allChats.some(chat => chat.id === groupId)) { // Chng trng lp
                    allChats.push({
                        id: groupId,
                        name: g.groupName || 'Nhm khng tn',
                        avatarUrl: g.avatarUrl,
                        type: 'group',
                        isVerified: false,
                        lastMessageTimestamp: 0,
                        lastMessagePreview: '...'
                    });
                    console.log("Added group chat to allChats:", groupId);
                }
            });

            // Ch tt c promise ly thng tin bn b hon thnh
            console.log("Waiting for all friend data promises...");
            await Promise.all(friendPromises);
            console.log("Friend data promises completed.");

            console.log("Final allChats list before attaching listeners:", allChats.map(c => c.id));

            // Gn listener last message & status MI
            if (allChats.length > 0) {
                console.log("Attaching last message and status listeners...");
                allChats.forEach(chat => {
                    const chatId = chat.id;

                    const lastMsgQuery = rtdbQuery(ref(rtdb, `/messages/${chatId}`), orderByChild('timestamp'), limitToLast(1));
                    if (chatListeners[chatId]) chatListeners[chatId](); // Hy listener c nu cn st
                    chatListeners[chatId] = onValue(lastMsgQuery, (snap) => {
                        let timestamp = 0; let preview = '...';
                        if (snap.exists()) {
                            const [, lastMsg] = Object.entries(snap.val())[0];
                            timestamp = lastMsg.timestamp || 0;
                            if (lastMsg.recalled) preview = 'Tin nhn  thu hi';
                            else if (lastMsg.text) preview = lastMsg.text;
                            else if (lastMsg.imageUrls?.length) preview = ` gi ${lastMsg.imageUrls.length} nh/video`;
                            else if (lastMsg.imageUrl) preview = ' gi mt nh';
                            else preview = 'Bt u tr chuyn';
                            const senderPrefix = lastMsg.senderId === currentUser.uid ? 'Bn: ' : (chat.type === 'group' ? `${(lastMsg.senderName || '?').split(' ')[0]}: ` : '');
                            preview = senderPrefix + preview;
                        }
                        const chatIndex = allChats.findIndex(c => c.id === chatId);
                        if (chatIndex > -1) {
                            if (allChats[chatIndex].lastMessageTimestamp !== timestamp || allChats[chatIndex].lastMessagePreview !== preview) {
                                allChats[chatIndex].lastMessageTimestamp = timestamp;
                                allChats[chatIndex].lastMessagePreview = preview;
                                renderChatList(); // Render li khi c thay i
                            }
                        }
                    }, (error) => {
                        console.error(`Error listening to last message ${chatId}:`, error);
                        if (chatListeners[chatId]) { chatListeners[chatId](); delete chatListeners[chatId]; }
                    });

                }); // Kt thc forEach gn listener
                // Render ln u sau khi gn listener
                renderChatList();
            } else {
                // Nu khng c chat no c
                renderChatList(); // Gi  hin "Cha c chat" v tt skeleton
            }
            console.log("--- Finished loadAndRebuildChatList ---");

        } catch (error) {
            console.error("Fatal error in loadAndRebuildChatList:", error);
            chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: red; padding: 20px;">Li ti danh sch chat!</li>';
            if (sidebar) sidebar.classList.add('loaded'); // Vn tt skeleton khi li
        }
    }

    /**
     * Hm render danh sch chat (allChats) ln sidebar.
     * Sp xp theo tin nhn mi nht trc.
     */
    /**
     * Hm render danh sch chat (allChats) ln sidebar.
     * Sp xp theo tin nhn mi nht trc v p dng hiu ng gradient cho tn user verified.
     */
    const renderChatList = () => {
        // Kim tra element cn thit
        if (!chatListElement || !sidebar) {
            console.error("renderChatList: chatListElement or sidebar not found!");
            return;
        }

        // Sp xp mng allChats theo timestamp mi nht (tin nhn mi nht ln u)
        allChats.sort((a, b) => (b.lastMessageTimestamp || 0) - (a.lastMessageTimestamp || 0));
        chatListElement.innerHTML = ''; // Xa ni dung danh sch c

        // X l trng hp khng c cuc tr chuyn no
        if (allChats.length === 0) {
            chatListElement.innerHTML = '<li class="chat-item-placeholder" style="list-style: none; text-align: center; color: var(--text-secondary); padding: 20px;">Cha c cuc tr chuyn no.</li>';
        } else {
            // Lp qua tng chat trong mng  sp xp  to item
            allChats.forEach(chat => {
                const li = document.createElement('li');
                li.className = 'item clickable chat-list-item'; // Class chung
                li.dataset.chatId = chat.id; // Lu chatId

                // Gn s kin click  m chat tng ng
                li.onclick = () => {
                    if (chat.type === 'direct') {
                        // Ly data bn b (u tin cache)
                        const friendData = friends.find(f => f.uid === chat.peerUid) || { uid: chat.peerUid, displayName: chat.name, avatarUrl: chat.avatarUrl, isVerified: chat.isVerified };
                        startDirectChat(friendData);
                    } else { // Nu l group chat
                        startGroupChat(chat.id, chat.name);
                    }
                    // nh du item ang active (optional)
                    document.querySelectorAll('.chat-list-item.active').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                };

                // Ly avatar, tn, v tick xanh
                const avatarPlaceholder = chat.name ? chat.name[0].toUpperCase() : (chat.type === 'group' ? 'G' : '?');
                const avatarSrc = chat.avatarUrl || `https://placehold.co/40x40?text=${avatarPlaceholder}`;
                const verifiedTick = createVerifiedTickHTML(chat.isVerified); // Ly HTML tick xanh

                // Xc nh class cho tn (thm 'gradient-text' nu verified)
                const nameClass = chat.isVerified ? 'item-name gradient-text' : 'item-name';
                // To HTML cho tn (khng bao gm tick)
                const nameHtml = `<div class="${nameClass}" id="sidebar-friend-name-${chat.peerUid}">${escapeHtml(chat.name)}</div>`;

                // To HTML hon chnh cho list item
                li.innerHTML = `
            <div class="item-left">
                <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                <div style="min-width: 0;">
                    ${nameHtml} ${verifiedTick}
                    <div class="item-last-msg">${escapeHtml(chat.lastMessagePreview || '...')}</div>
                </div>
            </div>
            `;
                chatListElement.appendChild(li); // Thm item vo danh sch
            });
        }
        // Lun tt skeleton SAU KHI render xong (d c chat hay khng)
        sidebar.classList.add('loaded');
    };

    /**
     * Bt u hoc chuyn sang cuc tr chuyn trc tip vi mt ngi bn.
     * Ly thng tin chi tit ca bn b, kim tra trng thi (bn b, b chn),
     * v gi openChat  hin th giao din. Cp nht URL.
     * @param {object} friend Object cha t nht uid, displayName, avatarUrl, isVerified ca ngi bn.
     */
    async function startDirectChat(friend) {
        // Kim tra thng tin u vo v trng thi ng nhp
        if (!friend || !friend.uid || !currentUser) {
            console.warn("startDirectChat: Invalid friend data or user not logged in.");
            window.location.href = 'index.html'; // Chuyn v trang chnh nu thiu thng tin
            return;
        }

        if (friend && friend.uid === currentUser.uid) {
            showToast("Bn khng th t tr chuyn vi chnh mnh.", "info");
            // Optional: Reset URL nu c param ?chat=myuid
            const params = new URLSearchParams(window.location.search);
            if (params.get('chat') === currentUser.uid) {
                history.replaceState(null, '', window.location.pathname); // Xa param khi URL
            }
            // Optional: Reset giao din chat v placeholder nu cn
            // resetChatUI(); // Cn to hm ny nu mun
            return; // Dng hm ti y
        }

        if (window.innerWidth <= 768) {
            window.location.href = `chat.html?chat=${friend.uid}`;
            return; // Dng hm  y cho mobile
        }

        // Ly d liu mi nht ca ngi bn t Firestore
        const friendDoc = await getDoc(doc(db, 'users', friend.uid));
        if (!friendDoc.exists()) {
            showToast("Khng tm thy ngi dng ny.", "error");
            return; // Dng nu user khng tn ti
        }

        const friendData = friendDoc.data();
        currentChatPeerData = friendData; // Lu li data y  ca ngi ang chat cng

        // Xc nh trng thi chat (active, inactive do b chn...)
        let isChatActive = true;
        let inactiveReason = "";
        let isFriend = currentUserData.friends?.includes(friend.uid); // Kim tra c phi bn b khng

        if (currentUserData.blocked?.includes(friend.uid)) {
            inactiveReason = "Bn  chn ngi ny. Hy b chn  tip tc nhn tin.";
            isChatActive = false;
        } else if (friendData?.blocked?.includes(currentUser.uid)) {
            inactiveReason = "Bn khng th gi tin nhn cho ngi ny.";
            isChatActive = false;
        } else if (friendData.isDeactivated === true) {
            inactiveReason = "Ti khon ny  ngng hot ng.";
            isChatActive = false;
        }

        // To chatId v cp nht bin global
        const uids = [currentUser.uid, friend.uid].sort();
        const chatId = uids.join('_');
        currentFriendUid = friend.uid; // Lu uid ca ngi bn ang chat

        // Gi hm openChat  hin th UI
        openChat({
            id: chatId,
            name: friendData.displayName || friendData.email, // Ly tn hin th
            type: 'direct',
            isActive: isChatActive // Trng thi active/inactive
        });

        // Cp nht text cho indicator nu chat inactive
        if (inactiveChatIndicator) inactiveChatIndicator.textContent = inactiveReason;

        const peerInfoExtra = document.getElementById('peer-info-extra');
        const addFriendHeaderBtn = document.getElementById('add-friend-header-btn');

        if (peerInfoExtra && addFriendHeaderBtn) { // Kim tra element tn ti
            // Ch hin khi KHNG phi bn b, chat ang active v KHNG phi chat vi chnh mnh
            if (!isFriend && isChatActive && friend.uid !== currentUser.uid) {
                peerInfoExtra.style.display = 'flex'; // Hin khi "Ngi l + Kt bn"

                // Kim tra xem  gi/nhn li mi cha
                addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ang ti...';
                const qSent = query(collection(db, 'friend_requests'), where('from_uid', '==', currentUser.uid), where('to_uid', '==', friend.uid), where('status', '==', 'pending'));
                const qReceived = query(collection(db, 'friend_requests'), where('from_uid', '==', friend.uid), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));

                try {
                    const [sentSnap, receivedSnap] = await Promise.all([getDocs(qSent), getDocs(qReceived)]);

                    if (!sentSnap.empty) { //  gi li mi
                        addFriendHeaderBtn.textContent = ' gi';
                        addFriendHeaderBtn.disabled = true;
                    } else if (!receivedSnap.empty) { //  nhn li mi t h
                        addFriendHeaderBtn.textContent = 'Chp nhn';
                        addFriendHeaderBtn.disabled = false;
                        addFriendHeaderBtn.onclick = async () => { /* ... logic chp nhn li mi ... */
                            addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ang x l...';
                            const reqId = receivedSnap.docs[0].id;
                            try {
                                await handleAcceptFriend(reqId, friend.uid);
                                showToast(' chp nhn li mi!', 'success');
                                peerInfoExtra.style.display = 'none';
                                isFriend = true; // Cp nht trng thi bn b
                                if (removeFriendBtn) removeFriendBtn.style.display = 'block';
                            } catch (acceptErr) {
                                console.error("Li chp nhn:", acceptErr);
                                showToast("Li: " + acceptErr.message, "error");
                                addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'Chp nhn';
                            }
                        };
                    } else { // Cha c li mi no
                        addFriendHeaderBtn.textContent = 'Kt bn';
                        addFriendHeaderBtn.disabled = false;
                        addFriendHeaderBtn.onclick = () => { /* ... logic gi li mi ... */
                            addFriendHeaderBtn.disabled = true; addFriendHeaderBtn.textContent = 'ang gi...';
                            sendFriendRequest(friend.uid)
                                .then(() => {
                                    showToast(" gi li mi kt bn!", "success");
                                    addFriendHeaderBtn.textContent = ' gi';
                                })
                                .catch((err) => {
                                    console.error("Li gi li mi:", err);
                                    showToast("Li: " + err.message, "error");
                                    addFriendHeaderBtn.disabled = false; addFriendHeaderBtn.textContent = 'Kt bn';
                                });
                        };
                    }
                } catch (checkError) {
                    console.error("Li kim tra li mi:", checkError);
                    addFriendHeaderBtn.textContent = 'Li';
                    addFriendHeaderBtn.disabled = true;
                }

            } else {
                peerInfoExtra.style.display = 'none'; // n i nu l bn b, khng active, hoc l chnh mnh
            }
        } else {
            console.warn("Peer info extra elements not found!");
        }

        // Cp nht URL (ch trn PC)
        history.replaceState(null, '', `?chat=${friend.uid}`);
    }

    /**
     * Bt u hoc chuyn sang cuc tr chuyn nhm.
     * Ly thng tin thnh vin nhm v gi openChat. Cp nht URL.
     * @param {string} groupId ID ca nhm.
     * @param {string} groupName Tn ca nhm.
     */
    async function startGroupChat(groupId, groupName) {

        if (window.innerWidth <= 768) {
            window.location.href = `chat.html?chat_group=${groupId}`;
            return; // Dng hm  y cho mobile
        }

        // Thng bo Beta (nu cha hin)
        if (!sessionStorage.getItem('groupBetaWarningShown')) {
            showToast('Tnh nng Nhm ang trong giai on th nghim (Beta)...');
            sessionStorage.setItem('groupBetaWarningShown', 'true');
        }

        // Reset trng thi chat trc tip
        currentFriendUid = null;
        currentChatPeerData = null;

        // Ly thng tin thnh vin nhm trc khi m chat
        const groupRef = doc(db, "groups", groupId);
        const groupDoc = await getDoc(groupRef);
        if (groupDoc.exists()) {
            const groupData = groupDoc.data();
            const memberUids = groupData.member_uids || [];
            // Kim tra xem user hin ti c cn l thnh vin khng
            if (!memberUids.includes(currentUser.uid)) {
                showToast("Bn khng cn l thnh vin ca nhm ny.", "error");
                // C th chuyn v trang chnh hoc lm g  khc
                // V d: reset UI chat
                if (currentChatId === groupId) {
                    currentChatFriendName.textContent = "Chn cuc tr chuyn";
                    messagesContainer.innerHTML = '';
                    messageInput.disabled = true; sendBtn.disabled = true;
                    currentChatId = null; currentChatType = null;
                    if (currentChatAvatar) currentChatAvatar.style.display = 'none';
                    if (groupInfoBtn) groupInfoBtn.style.display = 'none';
                }
                return; // Dng nu khng cn l thnh vin
            }

            // Ly thng tin chi tit cc thnh vin
            const memberPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
            const memberDocs = await Promise.all(memberPromises);
            currentGroupMembers = memberDocs
                .filter(d => d.exists())
                .map(d => {
                    const uData = d.data();
                    // Cp nht cache
                    userCache[uData.uid] = { displayName: uData.displayName, avatarUrl: uData.avatarUrl, isVerified: uData.isVerified };
                    return { uid: uData.uid, displayName: uData.displayName || uData.email, avatarUrl: uData.avatarUrl };
                });

            // M chat nhm
            openChat({ id: groupId, name: groupName, type: 'group', isActive: true });

            // Cp nht URL (ch trn PC)
            history.replaceState(null, '', `?chat_group=${groupId}`);
        } else {
            showToast("Nhm khng tn ti.", "error");
            // Reset UI nu nhm khng tn ti
            if (currentChatId === groupId) {
                currentChatFriendName.textContent = "Chn cuc tr chuyn";
                messagesContainer.innerHTML = '';
                messageInput.disabled = true; sendBtn.disabled = true;
                currentChatId = null; currentChatType = null;
                if (currentChatAvatar) currentChatAvatar.style.display = 'none';
                if (groupInfoBtn) groupInfoBtn.style.display = 'none';
            }
        }
    }

    /**
     * Hm ct li  m giao din chat, reset UI, gn listener mi.
     * c gi bi startDirectChat v startGroupChat.
     * Cp nht header vi tn (c gradient nu verified), avatar, v trng thi Last Seen.
     * @param {object} chat Object cha id, name, type ('direct'/'group'), isActive.
     */
    function openChat(chat) {
        console.log("Opening chat:", chat); // Log  debug
        // <<< THM 3 DNG NY VO U HM >>>
        const placeholder = document.getElementById('chat-window-placeholder');
        if (placeholder) placeholder.style.display = 'none';
        if (messagesContainer) messagesContainer.style.display = 'flex';

        // Hy listener tin nhn c
        if (msgsUnsub) {
            try { msgsUnsub(); console.log(`Unsubscribed messages for ${currentChatId}`); } catch (e) { console.warn("Error unsubscribing messages:", e); }
            msgsUnsub = null;
        }
        // Hy listener typing c
        if (typingUnsub) {
            try { typingUnsub(); console.log(`Unsubscribed typing for ${currentChatId}`); } catch (e) { console.warn("Error unsubscribing typing:", e); }
            typingUnsub = null;
        }
        // Hy listener status c (quan trng)
        if (currentStatusUnsub) {
            try { currentStatusUnsub(); console.log(`Unsubscribed status for ${currentFriendUid}`); } catch (e) { console.warn("Error unsubscribing status:", e); }
            currentStatusUnsub = null;
        }

        lastMessageDate = null;          // Reset ngy ca tin nhn cui
        currentChatId = chat.id;         // Cp nht ID chat hin ti
        currentChatType = chat.type;     // Cp nht loi chat
        // currentGroupMembers  c cp nht trong startGroupChat nu l group
        if (messagesContainer) messagesContainer.innerHTML = ''; // Xa tin nhn c
        if (typingIndicator) typingIndicator.textContent = '';     // Xa trng thi g phm
        if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // ng panel thng tin
        cancelReply(); cancelEdit(); cancelImagePreview();        // Hy cc trng thi preview

        // Ly element hin th last seen v reset n
        const lastSeenElement = document.getElementById('chat-header-last-seen');
        if (lastSeenElement) lastSeenElement.textContent = '';
        // n phn thng tin ngi l (quan trng khi chuyn chat)
        if (peerInfoExtra) peerInfoExtra.style.display = 'none';

        // Kim tra cc element header tn ti
        if (currentChatFriendName && currentChatAvatar && openInfoBtn && groupInfoBtn) {
            // Ly tn hin th (u tin nickname)
            const chatDisplayName = (chat.type === 'direct' && currentFriendUid && currentUserData.nicknames?.[currentFriendUid])
                ? currentUserData.nicknames[currentFriendUid]
                : chat.name;

            // X l tn v hiu ng gradient
            currentChatFriendName.classList.remove('gradient-text'); // Xa class c
            const isPeerVerified = chat.type === 'direct' && currentChatPeerData?.isVerified; // Check verified
            if (isPeerVerified) {
                currentChatFriendName.classList.add('gradient-text'); // Thm class nu verified
            }
            currentChatFriendName.innerHTML = escapeHtml(chatDisplayName); // Cp nht tn (khng c tick)

            // Thm tick xanh vo sau tn (nu c)
            const verifiedTickHTML = createVerifiedTickHTML(isPeerVerified);
            currentChatFriendName.innerHTML += verifiedTickHTML; // Ni chui HTML tick

            // Cp nht Avatar Header v cc nt Info
            if (chat.type === 'direct' && currentChatPeerData) { // Chat trc tip
                currentChatAvatar.src = currentChatPeerData.avatarUrl || `https://placehold.co/40x40/EFEFEF/333?text=${escapeHtml(chatDisplayName[0])}`;
                currentChatAvatar.style.display = 'block';
                currentChatAvatar.onclick = () => { if (currentFriendUid) window.open(`profile.html?uid=${currentFriendUid}`, '_blank'); };
                groupInfoBtn.style.display = 'none';
                openInfoBtn.style.display = 'block';
                openInfoBtn.onclick = () => { if (currentFriendUid) { showFriendInfo(currentFriendUid); if (chatInfoPanel) chatInfoPanel.classList.add('open'); } };
                // currentFriendUid  c gn trong startDirectChat
            } else if (chat.type === 'group') { // Chat nhm
                getDoc(doc(db, "groups", chat.id)).then(groupDoc => { // Ly avatar nhm
                    let avatarSrc = `https://placehold.co/40x40/1e293b/fff?text=${escapeHtml(chat.name[0])}`;
                    if (groupDoc.exists()) { const groupData = groupDoc.data(); avatarSrc = groupData.avatarUrl || avatarSrc; }
                    currentChatAvatar.src = avatarSrc;
                }).catch(err => console.error("Error fetching group avatar:", err));
                currentChatAvatar.style.display = 'block';
                currentChatAvatar.onclick = null; // Khng cn click avatar nhm
                openInfoBtn.style.display = 'none';
                groupInfoBtn.style.display = 'block';
                groupInfoBtn.onclick = () => { showGroupInfo(chat.id); if (chatInfoPanel) chatInfoPanel.classList.add('open'); };
                currentFriendUid = null; // Reset friendUid
            } else { // Trng thi ch (cha chn chat)
                currentChatFriendName.textContent = "Chn cuc tr chuyn";
                currentChatAvatar.style.display = 'none';
                openInfoBtn.style.display = 'none';
                groupInfoBtn.style.display = 'none';
                currentFriendUid = null;
            }
        } else {
            console.error("Missing header elements for openChat!");
        }

        if (chat.type === 'direct' && currentFriendUid && lastSeenElement) {
            const statusRef = ref(rtdb, `/status/${currentFriendUid}`);
            if (currentStatusUnsub) { try { currentStatusUnsub(); } catch (e) { } currentStatusUnsub = null; }

            currentStatusUnsub = onValue(statusRef, (snap) => {
                const statusData = snap.val() || { isOnline: false, last_seen: null };

                // Ly ci t n ca C HAI NGI
                const iAmHidingStatus = currentUserData.hideOnlineStatus === true;
                const peerIsHidingStatus = currentChatPeerData?.hideOnlineStatus === true; // Ly t data ngi kia

                // Nu MT TRONG HAI ngi (cu hoc h) bt ch  n
                // th KHNG hin th bt k thng tin trng thi no.
                if (iAmHidingStatus || peerIsHidingStatus) {
                    lastSeenElement.textContent = ''; // Xa sch, khng hin th g
                    return; // Dng hm onValue ti y
                }

                // Ch chy phn cn li nu C HAI U KHNG N
                const displayAsOnline = statusData.isOnline; // Gi ch cn check status ca ngi kia
                const showDetailedRecency = true; // Lun hin chi tit nu khng ai n

                // Format chui trng thi
                const statusString = formatLastSeen(displayAsOnline, statusData.last_seen, showDetailedRecency);

                // Cp nht UI
                lastSeenElement.textContent = statusString;

            }, (error) => { // X l li
                console.error(`Error listening to status ${currentFriendUid}:`, error);
                lastSeenElement.textContent = "Li ti trng thi";
                if (currentStatusUnsub) { try { currentStatusUnsub(); } catch (e) { } currentStatusUnsub = null; }
            });

        } else if (lastSeenElement) { // Nu l group chat hoc thiu element
            lastSeenElement.textContent = ''; // n trng thi
            if (currentStatusUnsub) { try { currentStatusUnsub(); } catch (e) { } currentStatusUnsub = null; }
        }

        if (chatInputContainer && inactiveChatIndicator && messageInput) {
            if (chat.isActive) {
                chatInputContainer.style.display = 'flex';
                inactiveChatIndicator.style.display = 'none';
                messageInput.disabled = false;
                messageInput.placeholder = "Nhp tin nhn...";
                if (!chatInfoPanel || !chatInfoPanel.classList.contains('open')) {
                    setTimeout(() => messageInput.focus(), 50); // Delay focus
                }
            } else {
                chatInputContainer.style.display = 'none';
                inactiveChatIndicator.style.display = 'block';
                // inactiveChatIndicator.textContent  c cp nht trong startDirectChat
            }
        } else {
            console.error("Missing input area elements for openChat!");
        }

        if (typingIndicator) {
            const typingRef = ref(rtdb, `/typing/${chat.id}`);
            typingUnsub = onValue(typingRef, (snap) => {
                const obj = snap.val() || {}; const othersTyping = Object.keys(obj).filter(uid => obj[uid] && uid !== currentUser.uid);
                if (othersTyping.length > 0) { if (chat.type === 'direct') typingIndicator.textContent = 'ang nhp...'; else { const typerNames = othersTyping.map(uid => currentGroupMembers.find(m => m.uid === uid)?.displayName?.split(' ')[0] || userCache[uid]?.displayName?.split(' ')[0] || 'Ai ').filter(Boolean); const maxNamesToShow = 2; const displayNames = typerNames.slice(0, maxNamesToShow).join(', '); const remainingCount = typerNames.length - maxNamesToShow; typingIndicator.textContent = `${displayNames}${remainingCount > 0 ? ` v ${remainingCount} ngi khc` : ''} ang nhp...`; } }
                else typingIndicator.textContent = '';
                if (messagesContainer) { const shouldScrollTyping = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 100; if (typingIndicator.textContent && shouldScrollTyping) setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50); }
            });
        } else {
            console.error("Typing indicator element not found!");
        }

        if (messagesContainer) {
            const msgsRef = ref(rtdb, `/messages/${chat.id}`);
            const initialLoadQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(50)); // Ti 50 tin nhn cui

            get(initialLoadQuery).then(snap => {
                messagesContainer.innerHTML = ''; // Xa trc khi render
                currentChatImages = []; // Reset nh khi load li
                if (snap.exists()) {
                    const messagesArray = []; snap.forEach(childSnap => { messagesArray.push({ key: childSnap.key, data: childSnap.val() }); });
                    // messagesArray.sort((a, b) => a.data.timestamp - b.data.timestamp); // Sort nu cn
                    messagesArray.forEach(msgObj => {
                        renderMessage(msgObj.key, msgObj.data, chat);
                        if (msgObj.data.imageUrl && !msgObj.data.recalled) currentChatImages.push({ url: msgObj.data.imageUrl, key: msgObj.key });
                    });
                } else { messagesContainer.innerHTML = '<div style="text-align: center; color: var(--text-2); padding: 20px;">Cha c tin nhn no.</div>'; }
                console.log("Current Chat Images after initial load:", currentChatImages);

                // Ch lng nghe tin nhn mi nht v thay i sau initial load
                const newMsgsQuery = rtdbQuery(msgsRef, orderByChild('timestamp'), limitToLast(1));
                const unsubChildAdded = onChildAdded(newMsgsQuery, (snap) => { const key = snap.key; const msgData = snap.val(); if (!document.querySelector(`.msg-wrapper[data-key="${key}"]`)) { renderMessage(key, msgData, chat); if (msgData.imageUrl && !msgData.recalled) { currentChatImages.push({ url: msgData.imageUrl, key: key }); console.log("Added new image:", currentChatImages); } } });
                const unsubChildChanged = onChildChanged(msgsRef, (snap) => { const key = snap.key; const msgData = snap.val(); renderMessage(key, msgData, chat); if (msgData.recalled) { const idx = currentChatImages.findIndex(img => img.key === key); if (idx > -1) { currentChatImages.splice(idx, 1); console.log("Removed recalled image:", currentChatImages); if (imageLightbox.classList.contains('show') && currentLightboxIndex === idx) { closeLightbox(); showToast("nh bn ang xem  b thu hi.", "info"); } else if (imageLightbox.classList.contains('show') && currentLightboxIndex > idx) { currentLightboxIndex--; } } } });
                msgsUnsub = () => { off(newMsgsQuery, 'child_added', unsubChildAdded); off(msgsRef, 'child_changed', unsubChildChanged); };
                setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 150);
            }).catch(error => { console.error("Error loading initial messages:", error); messagesContainer.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Li ti tin nhn!</div>'; });
        } else {
            console.error("Messages container element not found!");
            showChatPlaceholder();
        }

        if (imageInput) {
            imageInput.onchange = handleImageSelection;
        }
    }

    /**
     * Render mt tin nhn ln giao din hoc cp nht tin nhn  c.
     * @param {string} key ID ca tin nhn.
     * @param {object} m D liu tin nhn t Firebase.
     * @param {object} chatCtx Thng tin v cuc tr chuyn hin ti {id, type}.
     */
    function renderMessage(key, m, chatCtx) {
        // 1. Kim tra iu kin thot sm (b chn, tin nhn null)
        if (!currentUserData || currentUserData.blocked?.includes(m?.senderId)) return;
        if (!m) {
            const elToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
            if (elToRemove) elToRemove.remove();
            return;
        }

        const isSent = m.senderId === currentUser.uid;

        // 2. Cp nht tiu  tab nu c tin nhn mi khi tab n
        if (!isSent && document.hidden) {
            unreadCount++;
            document.title = `(${unreadCount}) ${originalTitle}`;
        }

        // 3. Ly hoc to element .msg-wrapper
        let existingEl = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
        const isNewMessage = !existingEl;
        if (isNewMessage) {
            existingEl = document.createElement('div');
            existingEl.className = 'msg-wrapper';
            existingEl.dataset.key = key;
        }

        // 4. Kim tra mention v thm class highlight
        let isMentioned = m.mentions?.includes(currentUser.uid) || m.mentions?.includes('all');
        existingEl.classList.toggle('mentioned-me', isMentioned);

        // 5. Render di phn cch ngy (ch khi l tin mi)
        if (isNewMessage && m.timestamp && messagesContainer) {
            const messageDate = new Date(m.timestamp).toLocaleDateString('vi-VN');
            if (messageDate !== lastMessageDate) {
                const separator = document.createElement('div');
                separator.className = 'message-date-separator';
                separator.textContent = (messageDate === new Date().toLocaleDateString('vi-VN')) ? 'Hm nay' : messageDate;
                // Chn vo trc existingEl nu n  c trong DOM, ngc li append
                if (existingEl.parentNode === messagesContainer) {
                    messagesContainer.insertBefore(separator, existingEl);
                } else {
                    messagesContainer.appendChild(separator); // Ln u
                }
                lastMessageDate = messageDate;
            }
        }

        // 6. Gn element vo giao din (nu l tin mi)
        if (isNewMessage && messagesContainer) {
            messagesContainer.appendChild(existingEl);
        }

        // 7. To HTML cho ni dung tin nhn
        existingEl.classList.toggle('sent', isSent);
        existingEl.classList.toggle('received', !isSent);

        let avatarHtml = '';
        if (!isSent) {
            let avatarUrl = ''; let senderUid = '';
            if (chatCtx.type === 'direct' && currentChatPeerData) {
                avatarUrl = currentChatPeerData.avatarUrl || `https://placehold.co/32x32/EFEFEF/333?text=${(currentChatPeerData.displayName || '?')[0]}`;
                senderUid = currentChatPeerData.uid;
            } else if (chatCtx.type === 'group') {
                const member = currentGroupMembers.find(mem => mem.uid === m.senderId) || userCache[m.senderId]; // Fallback to cache
                avatarUrl = member?.avatarUrl || `https://placehold.co/32x32/1e293b/fff?text=${m.senderName ? m.senderName[0].toUpperCase() : '?'}`;
                senderUid = m.senderId;
            }
            if (avatarUrl) avatarHtml = `<img src="${avatarUrl}" class="msg-avatar" data-uid="${senderUid}" alt="Avatar">`;
        }

        let senderNameHtml = '';
        if (!isSent && chatCtx.type === 'group') {
            senderNameHtml = `<div class="msg-sender-name">${escapeHtml(m.senderName) || '...'}</div>`;
        }

        let msgBubbleHtml = '';
        if (m.recalled) {
            msgBubbleHtml = `<div class="msg recalled-message">Tin nhn  c thu hi</div>`;
        } else {
            let content = `<div class="msg ${isSent ? 'sent' : ''}" data-sender-name="${escapeHtml(m.senderName || '')}">`; // Lu tn  reply

            // Quote tr li
            if (m.replyTo) {
                const repliedWrapper = document.querySelector(`.msg-wrapper[data-key="${m.replyTo}"]`);
                if (repliedWrapper) {
                    const repliedEl = repliedWrapper.querySelector('.msg');
                    if (repliedEl && !repliedEl.classList.contains('recalled-message')) {
                        const origSender = repliedEl.dataset.senderName || '...';
                        const origText = repliedEl.querySelector('.msg-text')?.textContent || (repliedEl.querySelector('img') ? 'nh' : '...');
                        content += `<div class="reply-quote"><div class="sender">Tr li ${escapeHtml(origSender)}</div><div class="text">${escapeHtml(origText)}</div></div>`;
                    } else content += `<div class="reply-quote"><div class="sender">Tr li tin nhn  thu hi</div></div>`;
                } else {
                    content += `<div class="reply-quote"><div class="sender">Tr li tin nhn khng cn tn ti</div></div>`; // Fallback nu khng tm thy tin nhn gc
                }
            }

            // Text v mention
            // Text, mention, v LINK
            let msgTextHtml = '';
            if (m.text) {
                let escaped = escapeHtml(m.text); // 1. Escape HTML trc

                // 2. X l mentions (nh c)
                if (m.mentions && chatCtx.type === 'group') {
                    const membersSorted = [...currentGroupMembers, ...(Object.values(userCache))].sort((a, b) => (b.displayName || '').length - (a.displayName || '').length);
                    escaped = escaped.replace(/@all/g, '<span class="mention">@all</span>');
                    membersSorted.forEach(mem => {
                        if (!mem || !mem.displayName) return;
                        const escName = escapeHtml(`@${mem.displayName}`);
                        const rgx = new RegExp(`(?<![\\w.-])(${escName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})(?![\\w.-])`, 'g');
                        if (m.mentions.includes(mem.uid)) {
                            escaped = escaped.replace(rgx, `<span class="mention">@${mem.displayName}</span>`);
                        }
                    });
                }

                // 3. TM V THAY TH LINK (ON MI)
                // Regex  tm URL (kh c bn, c th ci thin nu cn)
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                let processedText = escaped.replace(urlRegex, function (url) {
                    let displayUrl = url;
                    let fullUrl = url;
                    // Nu link bt u bng www. th thm http:// vo href
                    if (!url.match(/^[a-zA-Z]+:\/\//)) {
                        fullUrl = 'http://' + url;
                    }
                    // To th <a>
                    return `<a href="${escapeHtml(fullUrl)}" target="_blank" class="message-link">${escapeHtml(displayUrl)}</a>`;
                });

                // 4. Gn HTML cui cng
                msgTextHtml = `<div class="msg-text">${processedText}</div>`; // Thay escaped bng processedText
            }
            content += msgTextHtml;

            // nh
            if (m.imageUrl) {
                // Thm data-key vo nh  openLightbox c th tm index
                content += `<img src="${m.imageUrl}" alt="nh  gi" data-key="${key}" style="cursor: pointer;"/>`;
            }
            // Timestamp & Edited
            if (m.timestamp) {
                const d = new Date(m.timestamp);
                const hm = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                const edited = m.edited ? `<span class="edited-label">(sa)</span>` : '';
                content += `<div class="msg-meta">${hm}${edited}</div>`;
            }

            // Trng thi  gi/ xem
            if (isSent) {
                let status = ' gi';
                if (chatCtx.type === 'direct') {
                    const peerUid = chatCtx.id.split('_').find(id => id !== currentUser.uid);
                    if (m.readBy?.[peerUid]) status = ' xem';
                } else if (m.readBy && Object.keys(m.readBy).length > 1) { // Group: xem bi > 1 ngi (l mnh)
                    status = ' xem';
                }
                content += `<div class="msg-status">${status}</div>`;
            }
            content += `</div>`; // ng th div.msg
            msgBubbleHtml = content;
        }

        // 8. GHP HTML HON CHNH
        existingEl.innerHTML = `
        ${avatarHtml}
        <div class="msg-content-wrapper">
            ${senderNameHtml}
            ${msgBubbleHtml}
            </div>
    `; // Ch : B reaction-picker khi y

        // 9. RENDER REACTION PICKER & DISPLAY (Lun to mi/cp nht)
        let picker = existingEl.querySelector('.reaction-picker');
        const msgContentWrapper = existingEl.querySelector('.msg-content-wrapper'); // Khi cha bubble chat

        if (!m.recalled && msgContentWrapper) { // Ch thm picker nu cha thu hi
            if (!picker) {
                picker = createReactionPicker(key); // To picker
                msgContentWrapper.appendChild(picker); // Gn vo wrapper
            }
            // Cp nht li v tr picker nu cn (sent/received)
            picker.style.top = '-45px'; // Reset v tr top
            if (isSent) { picker.style.right = '10px'; picker.style.left = 'auto'; }
            else { picker.style.left = '10px'; picker.style.right = 'auto'; }

            // Render Reactions Display
            const reactions = m.reactions || {};
            let reactionsDisplay = existingEl.querySelector('.reactions-display');
            if (Object.keys(reactions).length > 0) {
                if (!reactionsDisplay) {
                    reactionsDisplay = document.createElement('div');
                    reactionsDisplay.className = 'reactions-display';
                    msgContentWrapper.appendChild(reactionsDisplay);
                }
                let reactionsHTML = '';
                for (const emoji in reactions) {
                    let count = (emoji === '') ? Object.values(reactions[emoji]).reduce((s, v) => s + (typeof v === 'number' ? v : 1), 0) : Object.keys(reactions[emoji]).length;
                    if (count > 0) reactionsHTML += `<span>${emoji} ${count}</span>`;
                }
                reactionsDisplay.innerHTML = reactionsHTML;
                reactionsDisplay.onclick = (e) => { e.stopPropagation(); showReactionsDetails(key); };
                // Cp nht v tr display
                if (isSent) { reactionsDisplay.style.right = '10px'; reactionsDisplay.style.left = 'auto'; }
                else { reactionsDisplay.style.left = '0px'; reactionsDisplay.style.right = 'auto'; }

            } else if (reactionsDisplay) {
                reactionsDisplay.remove(); // Xa display nu khng cn reaction
            }
        } else { // Nu b thu hi
            if (picker) picker.remove(); // Xa picker
            let reactionsDisplay = existingEl.querySelector('.reactions-display');
            if (reactionsDisplay) reactionsDisplay.remove(); // Xa display
        }

        // 10. GN LI CC S KIN KHC
        const imageInMessage = existingEl.querySelector('.msg img');
        if (imageInMessage) {
            // m bo dataset.key tn ti trn th img
            if (imageInMessage.dataset.key) {
                imageInMessage.onclick = () => openLightbox(imageInMessage.src, imageInMessage.dataset.key);
            } else {
                console.error("Image in message is missing data-key:", key);
                // Fallback: M nh m khng c navigation
                imageInMessage.onclick = () => openLightbox(imageInMessage.src, null);
            }
        }
        const avatarInMessage = existingEl.querySelector('.msg-avatar');
        if (avatarInMessage?.dataset.uid) avatarInMessage.onclick = () => window.open(`profile.html?uid=${avatarInMessage.dataset.uid}`, '_blank');
        existingEl.onclick = () => { // X l chn tin nhn bng chng
            if (messagesContainer?.classList.contains('selection-mode')) {
                const messageData = { key, ...m };
                const index = selectedEvidence.findIndex(e => e.key === key);
                if (index > -1) { selectedEvidence.splice(index, 1); existingEl.classList.remove('selected'); }
                else { selectedEvidence.push(messageData); existingEl.classList.add('selected'); }
                updateSelectionCount();
            }
        };

        // 11. CP NHT TRNG THI " C"
        if (!isSent && (!m.readBy || !m.readBy[currentUser.uid])) {
            rtdbUpdate(ref(rtdb, `/messages/${chatCtx.id}/${key}/readBy`), { [currentUser.uid]: true });
        }

        // 12. T NG CUN XUNG DI
        if (messagesContainer) { // Check messagesContainer tn ti
            const shouldScroll = messagesContainer.scrollHeight - messagesContainer.scrollTop < messagesContainer.clientHeight + 150 || isSent || isNewMessage;
            if (shouldScroll) {
                setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 50);
            }
        }
    }

    /**
     * Gi tin nhn mi hoc lu tin nhn  chnh sa.
     * Kim tra ni dung vi phm trc khi gi. Nu vi phm, tng cnh bo v khng gi.
     */
    async function sendMessage() {
        const text = messageInput ? messageInput.value.trim() : '';
        if (!currentChatId || (!text && !selectedImageFile && !isEditing) || (sendBtn && sendBtn.classList.contains('loading'))) {
            return;
        }

        if (!isEditing && text) {
            const triggerKeywords = ["ln dng", "ch dng", "i phng", "i phng p qu", "i phng p gh"]; // <<< THAY LIST T KHA KCH HOT
            const forbiddenPraiseTopics = ["i phng p qu", "i phng p gh"]; // <<< THAY LIST CH  CM KHEN
            const lowerCaseText = text.toLowerCase();

            const hasTriggerKeyword = triggerKeywords.some(k => lowerCaseText.includes(k.toLowerCase()));
            // Kim tra "khen" rt c bn, c th sai:
            const seemsLikeForbiddenPraise = forbiddenPraiseTopics.some(topic => lowerCaseText.includes(topic.toLowerCase()) && (lowerCaseText.includes("p") || lowerCaseText.includes("tuyt") || lowerCaseText.includes("thch"))); // <<< CN CI THIN

            if (hasTriggerKeyword /* && seemsLikeForbiddenPraise */) { // Tm b check khen cho  phc tp
                console.warn("Potential violation detected:", currentUser.uid, text);

                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    // Ly warning count mi nht phng trng hp client b stale
                    const userSnap = await getDoc(userRef);
                    const currentWarnings = userSnap.exists() ? (userSnap.data().warningCount || 0) : 0;
                    const newWarningCount = currentWarnings + 1;

                    // Cp nht warning count ln Firestore
                    await updateDoc(userRef, {
                        warningCount: newWarningCount
                    });

                    // Cp nht local data
                    currentUserData.warningCount = newWarningCount;

                    // Hin th cnh bo
                    showToast(`Cnh bo ${newWarningCount}/3: Ni dung khng ph hp. Vui lng tun th quy nh.`, "error");

                    // Nu  3 cnh bo -> ng xut lun
                    if (newWarningCount >= 3) {
                        showToast("Bn  nhn  3 cnh bo. Ti khon s b tm kha.", "error");
                        // i 1 cht  user c toast ri mi ng xut
                        setTimeout(async () => {
                            await signOut(auth);
                            window.location.href = 'login.html';
                        }, 3000); // 3 giy
                    }

                } catch (warningError) {
                    console.error("Error updating warning count:", warningError);
                    showToast("Li x l cnh bo.", "error");
                    // C th vn cho gi nu x l cnh bo li? Hoc vn chn? -> Vn chn cho an ton
                }

                // KHNG GI TIN NHN NY I
                // Reset input nhng gi li text  user sa
                if (sendBtn) { sendBtn.classList.remove('loading'); sendBtn.disabled = false; }
                if (messageInput) messageInput.disabled = false;
                handleTextInput(); // Cp nht li trng thi nt gi
                return; // Dng hm sendMessage
            }
        }

        if (sendBtn) { sendBtn.classList.add('loading'); sendBtn.disabled = true; }
        if (messageInput) messageInput.disabled = true;

        try {
            // ... (Phn cn li ca sendMessage: upload nh, gi tin, gi notif... gi nguyn nh code hon chnh ln trc) ...
            let imageUrl = null; if (selectedImageFile && !isEditing) imageUrl = await uploadImage(selectedImageFile);
            if (isEditing && editingMessageKey) { const msgRef = ref(rtdb, `/messages/${currentChatId}/${editingMessageKey}`); const updateData = { text: text || null, edited: true, timestamp: dbServerTimestamp() }; await rtdbUpdate(msgRef, updateData); console.log(`Message ${editingMessageKey} edited.`); cancelEdit(); }
            else { let mentions = []; if (currentChatType === 'group' && text) { const rgx = /@(\S+)/g; let match; while ((match = rgx.exec(text)) !== null) { const uname = match[1]; if (uname === 'all') { if (!mentions.includes('all')) mentions.push('all'); } else { const member = currentGroupMembers.find(m => m.displayName === uname) || Object.values(userCache).find(u => u.displayName === uname); if (member && !mentions.includes(member.uid)) mentions.push(member.uid); } } } const newMsgPayload = { senderId: currentUser.uid, senderName: currentUserData.displayName || currentUser.email.split('@')[0], text: text || null, imageUrl: imageUrl, timestamp: Date.now(), readBy: { [currentUser.uid]: true }, replyTo: replyingTo ? replyingTo.key : null, mentions: mentions.length > 0 ? mentions : null }; const newMsgRef = push(ref(rtdb, `/messages/${currentChatId}`)); const newMsgKey = newMsgRef.key; const updates = {}; updates[`/messages/${currentChatId}/${newMsgKey}`] = newMsgPayload; const notifPayload = { from: newMsgPayload.senderName, avatar: currentUserData.avatarUrl, preview: newMsgPayload.text || " gi mt nh", chatId: currentChatId, chatType: currentChatType, senderId: currentUser.uid }; if (currentChatType === 'direct') { const recipientId = currentFriendUid; if (recipientId) { const recipientDoc = await getDoc(doc(db, 'users', recipientId)); const recipientData = recipientDoc.exists() ? recipientDoc.data() : {}; if (!recipientData.mutedChats?.[currentChatId]) updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload; } } else if (currentChatType === 'group') { const groupRef = doc(db, 'groups', currentChatId); const groupDoc = await getDoc(groupRef); const memberUids = groupDoc.exists() ? groupDoc.data().member_uids || [] : []; for (const recipientId of memberUids) { if (recipientId === currentUser.uid) continue; const recipientDoc = await getDoc(doc(db, 'users', recipientId)); const recipientData = recipientDoc.exists() ? recipientDoc.data() : {}; if (!recipientData.mutedChats?.[currentChatId]) updates[`/notifications/${recipientId}/${newMsgKey}`] = notifPayload; } } if (Object.keys(updates).length > 0) await rtdbUpdate(ref(rtdb), updates); console.log(`New message ${newMsgKey} sent.`); if (messageInput) messageInput.value = ''; if (chatInputContainer) chatInputContainer.classList.remove('has-text'); cancelImagePreview(); cancelReply(); clearTimeout(typingTimer); set(ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`), false); }

        } catch (e) {
            console.error("Li khi gi/sa tin nhn:", e);
            showToast(`Gi tin nhn tht bi: ${e.message}`, 'error');
        } finally {

            if (sendBtn) { sendBtn.classList.remove('loading'); sendBtn.disabled = false; }
            if (messageInput) { messageInput.disabled = false; }
            handleTextInput(); // Cp nht li trng thi nt gi
        }
    }

    /**
     * X l khi ngi dng t chi li mi kt bn.
     * Cp nht trng thi li mi thnh 'declined'.
     * @param {string} reqId ID ca document li mi kt bn.
     */
    async function handleRejectFriend(reqId) {
        if (!reqId) return; // Kim tra reqId
        const reqRef = doc(db, 'friend_requests', reqId);

        try {
            // Cp nht trng thi li mi thnh 'declined'
            await updateDoc(reqRef, { status: 'declined' });
            showToast('  t chi li mi.');
            // Danh sch li mi s t cp nht nh onSnapshot trong loadFriendRequests
            // ng modal li mi nu ang m
            if (friendReqModal) friendReqModal.style.display = 'none';

        } catch (error) {
            console.error("Li khi t chi li mi:", error);
            showToast("C li xy ra khi t chi li mi.", "error");
        }
    }

    /**
     * X l khi ngi dng chp nhn li mi kt bn.
     * Cp nht trng thi li mi thnh 'accepted' v thm bn b cho c hai ngi.
     * @param {string} reqId ID ca document li mi kt bn.
     * @param {string} fromUid UID ca ngi gi li mi.
     */
    async function handleAcceptFriend(reqId, fromUid) {
        if (!reqId || !fromUid || !currentUser) return; // Kim tra d liu
        const reqRef = doc(db, 'friend_requests', reqId);
        const currentUserRef = doc(db, 'users', currentUser.uid);
        const senderUserRef = doc(db, 'users', fromUid);

        try {
            // Cp nht trng thi li mi
            await updateDoc(reqRef, { status: 'accepted' });

            // Thm bn b cho c hai ngi (dng arrayUnion  trnh trng lp)
            await updateDoc(currentUserRef, { friends: arrayUnion(fromUid) });
            await updateDoc(senderUserRef, { friends: arrayUnion(currentUser.uid) });

            showToast(' chp nhn li mi kt bn!', 'success');
            // Danh sch li mi s t cp nht nh onSnapshot trong loadFriendRequests
            // Danh sch chat cng s t cp nht nh listener user trong loadAndSortChats
            // ng modal li mi nu ang m
            if (friendReqModal) friendReqModal.style.display = 'none';

        } catch (error) {
            console.error("Li khi chp nhn li mi:", error);
            showToast("C li xy ra khi chp nhn li mi.", "error");
        }
    }

    /**
     * Upload nh ln ImgBB.
     * @param {File} file File nh cn upload.
     * @returns {Promise<string>} Promise tr v URL ca nh  upload.
     * @throws {Error} Nu thiu API key hoc upload tht bi.
     */
    async function uploadImage(file) {
        if (!IMGBB_API_KEY) throw new Error('Thiu API Key ImgBB');
        const fd = new FormData();
        fd.append('image', file);
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
            const data = await res.json();
            if (data.success) {
                console.log("Image uploaded:", data.data.url);
                return data.data.url; // Tr v URL nh
            } else {
                throw new Error(data.error?.message || 'Upload nh tht bi khng r l do.');
            }
        } catch (error) {
            console.error("ImgBB Upload Error:", error);
            throw new Error('Khng th upload nh: ' + error.message); // Nm li  hm sendMessage x l
        }
    }

    /**
     * Hin th menu chut phi cho tin nhn.
     * @param {MouseEvent} e S kin chut phi.
     */
    function showMessageContextMenu(e) {
        const wrapper = e.target.closest('.msg-wrapper'); // Tm element .msg-wrapper gn nht
        if (!wrapper || !wrapper.dataset.key || !messageContextMenu) return; // Thot nu khng phi tin nhn hoc thiu menu

        e.preventDefault(); // Ngn menu mc nh ca trnh duyt
        const msgKey = wrapper.dataset.key;
        const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);

        // Ly d liu tin nhn mi nht  to menu chnh xc
        get(msgRef).then(snap => {
            if (!snap.exists()) return; // Tin nhn  b xa khi DB
            const msg = snap.val();
            messageContextMenu.innerHTML = ''; // Xa cc nt c

            if (!msg.recalled) {
                const btnReply = document.createElement('button');
                btnReply.className = 'context-menu-btn';
                btnReply.textContent = ' Tr li';
                btnReply.onclick = () => {
                    replyToMessage(msgKey, msg);
                    messageContextMenu.style.display = 'none'; // n menu sau khi chn
                };
                messageContextMenu.appendChild(btnReply);
            }

            if (msg.senderId === currentUser.uid) {
                // Nt Chnh sa (ch cho tin nhn text cha thu hi)
                if (msg.text && !msg.recalled) {
                    const btnEdit = document.createElement('button');
                    btnEdit.className = 'context-menu-btn';
                    btnEdit.textContent = ' Chnh sa';
                    btnEdit.onclick = () => {
                        startEditMessage(msgKey, msg);
                        messageContextMenu.style.display = 'none';
                    };
                    messageContextMenu.appendChild(btnEdit);
                }
                // Nt Thu hi (ch trong 3 pht u v cha thu hi)
                const timeSinceSent = Date.now() - msg.timestamp;
                if (timeSinceSent < 3 * 60 * 1000 && !msg.recalled) {
                    const btnRecall = document.createElement('button');
                    btnRecall.className = 'context-menu-btn danger'; // Mu  cnh bo
                    btnRecall.textContent = ' Thu hi';
                    btnRecall.onclick = () => {
                        recallMessage(msgKey);
                        messageContextMenu.style.display = 'none';
                    };
                    messageContextMenu.appendChild(btnRecall);
                }
            }

            const btnDelete = document.createElement('button');
            btnDelete.className = 'context-menu-btn danger';
            btnDelete.textContent = ' Xa  pha bn';
            btnDelete.onclick = () => {
                deleteMessageForSelf(msgKey);
                messageContextMenu.style.display = 'none';
            };
            messageContextMenu.appendChild(btnDelete);

            // Hin th menu ti v tr chut
            if (messageContextMenu.hasChildNodes()) { // Ch hin nu c t nht 1 nt
                messageContextMenu.style.display = 'block';
                // Tnh ton v tr  khng b trn mn hnh (n gin)
                const menuWidth = messageContextMenu.offsetWidth;
                const menuHeight = messageContextMenu.offsetHeight;
                let left = e.pageX;
                let top = e.pageY;
                if (left + menuWidth > window.innerWidth - 10) { left = window.innerWidth - menuWidth - 10; }
                if (top + menuHeight > window.innerHeight - 10) { top = window.innerHeight - menuHeight - 10; }
                messageContextMenu.style.left = `${left}px`;
                messageContextMenu.style.top = `${top}px`;
            }

        }).catch(error => console.error("Error getting message for context menu:", error));
    }

    /**
     * Thu hi mt tin nhn (ch ngi gi lm c).
     * Cp nht trng thi 'recalled' v xa ni dung/nh/reply/reactions.
     * @param {string} key ID ca tin nhn cn thu hi.
     */
    function recallMessage(key) {
        if (!currentChatId || !key) return;
        const msgRef = ref(rtdb, `/messages/${currentChatId}/${key}`);
        // Cp nht nhiu trng cng lc
        rtdbUpdate(msgRef, {
            text: null,
            imageUrl: null,
            recalled: true,
            replyTo: null,
            reactions: null, // Xa reactions khi thu hi
            edited: deleteField() // Xa trng thi edited nu c
        }).catch(error => {
            console.error("Error recalling message:", error);
            showToast("Thu hi tht bi!", "error");
        });
    }

    /**
     * Xa mt tin nhn ch  pha ngi dng hin ti (khi giao din).
     * @param {string} key ID ca tin nhn cn xa.
     */
    function deleteMessageForSelf(key) {
        const elementToRemove = document.querySelector(`.msg-wrapper[data-key="${key}"]`);
        if (elementToRemove) {
            elementToRemove.remove(); // Xa khi DOM
        }
    }

    /**
     * Chn mt ngi dng khc.
     * Cp nht Firestore: thm UID vo list blocked ca mnh, xa bn b (c 2 chiu).
     * @param {string} friendUid UID ca ngi cn chn.
     * @param {string} name Tn hin th ca ngi cn chn ( confirm).
     */
    async function blockUser(friendUid, name) {
        if (!currentUser || !friendUid) return;
        const confirmed = await showConfirmation(`Chn ${escapeHtml(name)}? Bn s khng nhn c tin nhn t h na v h s b xa khi danh sch bn b (nu c).`);
        if (confirmed) {
            // Ly nt trong panel info (nu ang m)
            const blockBtnPanel = document.getElementById('block-user-btn');
            const unblockBtnPanel = document.getElementById('unblock-user-btn');
            if (blockBtnPanel) blockBtnPanel.disabled = true; // Disable nt ngay

            try {
                const currentUserRef = doc(db, 'users', currentUser.uid);
                const targetUserRef = doc(db, 'users', friendUid);

                // Cp nht document ca mnh
                await updateDoc(currentUserRef, {
                    blocked: arrayUnion(friendUid), // Thm vo danh sch chn
                    friends: arrayRemove(friendUid), // Xa khi danh sch bn b
                    [`nicknames.${friendUid}`]: deleteField() // Xa nickname nu c
                });

                // Cp nht document ca ngi b chn (ch xa bn b)
                await updateDoc(targetUserRef, {
                    friends: arrayRemove(currentUser.uid)
                });

                // Cp nht d liu local
                currentUserData.blocked = [...(currentUserData.blocked || []), friendUid];
                currentUserData.friends = currentUserData.friends?.filter(id => id !== friendUid);
                if (currentUserData.nicknames) delete currentUserData.nicknames[friendUid];

                showToast(` chn ${escapeHtml(name)}.`, 'success');
                if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // ng panel info

                // Cp nht UI nu ang chat vi ngi 
                const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToCheck) {
                    inactiveChatIndicator.textContent = "Bn  chn ngi ny.";
                    inactiveChatIndicator.style.display = 'block';
                    if (chatInputContainer) chatInputContainer.style.display = 'none';
                    if (blockBtnPanel) blockBtnPanel.style.display = 'none';
                    if (unblockBtnPanel) unblockBtnPanel.style.display = 'block'; // Hin nt b chn
                    // Cp nht li isChatActive  hm openChat x l ng
                    const chatObj = allChats.find(c => c.id === currentChatId);
                    if (chatObj) chatObj.isActive = false;
                }
                // Cp nht danh sch chat sidebar (onSnapshot s t x l)

            } catch (err) {
                console.error("Li khi chn:", err);
                showToast("C li xy ra khi chn ngi dng!", "error");
                if (blockBtnPanel) blockBtnPanel.disabled = false; // Enable li nt nu li
            }
        }
    }

    /**
     * B chn mt ngi dng.
     * Cp nht Firestore: xa UID khi list blocked ca mnh.
     * @param {string} friendUid UID ca ngi cn b chn.
     * @param {string} name Tn hin th ca ngi cn b chn ( confirm).
     */
    async function unblockUser(friendUid, name) {
        if (!currentUser || !friendUid) return;
        const confirmed = await showConfirmation(`B chn ${escapeHtml(name)}?`);
        if (confirmed) {
            const blockBtnPanel = document.getElementById('block-user-btn');
            const unblockBtnPanel = document.getElementById('unblock-user-btn');
            if (unblockBtnPanel) unblockBtnPanel.disabled = true; // Disable nt

            try {
                const currentUserRef = doc(db, 'users', currentUser.uid);
                await updateDoc(currentUserRef, {
                    blocked: arrayRemove(friendUid) // Xa khi danh sch chn
                });

                // Cp nht d liu local
                currentUserData.blocked = currentUserData.blocked?.filter(id => id !== friendUid);

                showToast(` b chn ${escapeHtml(name)}.`, 'success');
                if (chatInfoPanel) chatInfoPanel.classList.remove('open');

                // Cp nht UI nu ang xem info panel hoc chat window ca ngi 
                const chatIdToCheck = [currentUser.uid, friendUid].sort().join('_');
                if (currentChatId === chatIdToCheck) {
                    inactiveChatIndicator.style.display = 'none';
                    if (chatInputContainer) chatInputContainer.style.display = 'flex'; // M li input
                    if (blockBtnPanel) blockBtnPanel.style.display = 'block'; // Hin nt chn
                    if (unblockBtnPanel) unblockBtnPanel.style.display = 'none'; // n nt b chn
                    // Cp nht li isChatActive
                    const chatObj = allChats.find(c => c.id === currentChatId);
                    if (chatObj) chatObj.isActive = true; // Kch hot li chat
                }

            } catch (err) {
                console.error("Li khi b chn:", err);
                showToast("C li xy ra khi b chn!", "error");
                if (unblockBtnPanel) unblockBtnPanel.disabled = false; // Enable li nt nu li
            }
        }
    }
    /**
     * Bt u trng thi tr li tin nhn.
     * Hin th thanh preview v lu thng tin tin nhn gc.
     * @param {string} key ID ca tin nhn c tr li.
     * @param {object} message D liu ca tin nhn c tr li.
     */
    function replyToMessage(key, message) {
        if (!replyPreviewContainer || !replyPreviewSender || !replyPreviewText || !messageInput) return;
        replyingTo = { key, message }; // Lu li thng tin
        replyPreviewContainer.style.display = 'block'; // Hin preview
        // Hin th tn ngi gi gc (hoc "chnh mnh")
        replyPreviewSender.textContent = `ang tr li ${message.senderId === currentUser.uid ? 'chnh mnh' : message.senderName || '...'}`;
        // Hin th text hoc "nh"
        replyPreviewText.textContent = message.text || (message.imageUrl ? 'Mt hnh nh' : '...');
        messageInput.focus(); // Focus vo  nhp liu
    }

    /**
     * Hy trng thi tr li tin nhn.
     * n thanh preview v xa thng tin  lu.
     */
    function cancelReply() {
        replyingTo = null; // Xa thng tin
        if (replyPreviewContainer) replyPreviewContainer.style.display = 'none'; // n preview
    }

    /**
     * Bt u trng thi chnh sa tin nhn (ch text).
     * Hin th thanh preview sa, in text c vo input, i nt Gi thnh Lu.
     * @param {string} key ID ca tin nhn cn sa.
     * @param {object} message D liu ca tin nhn cn sa.
     */
    function startEditMessage(key, message) {
        if (!editPreviewContainer || !editPreviewText || !messageInput || !sendBtn) return;
        if (replyingTo) cancelReply(); // Hy reply nu ang reply
        isEditing = true; // Bt c ang sa
        editingMessageKey = key; // Lu key tin nhn ang sa
        editPreviewText.textContent = message.text; // Hin text gc trong preview
        editPreviewContainer.style.display = 'block'; // Hin preview sa
        messageInput.value = message.text; // in text c vo input
        messageInput.focus(); // Focus input
        sendBtn.innerHTML = 'Lu'; // i text nt Gi
        // Kch hot nt Lu (v  c text)
        if (chatInputContainer) chatInputContainer.classList.add('has-text');
    }

    /**
     * Hy trng thi chnh sa tin nhn.
     * n thanh preview, xa text trong input, i nt Lu thnh Gi.
     */
    function cancelEdit() {
        isEditing = false;
        editingMessageKey = null;
        if (editPreviewContainer) editPreviewContainer.style.display = 'none';
        if (messageInput) messageInput.value = ''; // Xa input
        if (sendBtn) {
            // Tr li icon gi (copy SVG t HTML)
            sendBtn.innerHTML = `<svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                           <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`;
        }
        // Hy kch hot nt gi nu input rng
        if (messageInput && chatInputContainer) {
            chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0 || selectedImageFile != null);
        }
    }

    /**
     * Hy vic xem trc nh sp gi.
     * n preview, reset input file v bin selectedImageFile.
     */
    function cancelImagePreview() {
        selectedImageFile = null;
        if (imageInput) imageInput.value = ''; // Reset input file
        if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
        if (messageInput) messageInput.placeholder = 'Nhp tin nhn...';
        // Hy kch hot nt gi nu input text cng rng
        if (messageInput && chatInputContainer) {
            chatInputContainer.classList.toggle('has-text', messageInput.value.trim().length > 0);
        }
    }

    /**
     * To element div cha cc nt reaction emoji.
     * @param {string} msgKey ID ca tin nhn m picker ny gn vo.
     * @returns {HTMLDivElement} Element reaction picker.
     */
    function createReactionPicker(msgKey) {
        const picker = document.createElement('div');
        picker.className = 'reaction-picker';
        // Danh sch emoji (c th ty chnh) + nt hy ''
        ['', '', '', '', '', '', ''].forEach(emoji => {
            const btn = document.createElement('span');
            btn.className = 'reaction-btn';
            btn.textContent = emoji;
            // Gn s kin click  gi hm reactToMessage
            btn.onclick = (e) => {
                e.stopPropagation(); // Ngn s kin click lan ra msg-wrapper
                reactToMessage(msgKey, emoji);
                // Ty chn: n picker ngay sau khi click
                // picker.style.opacity = '0';
                // picker.style.pointerEvents = 'none';
            };
            picker.appendChild(btn);
        });
        return picker;
    }

    /**
     * X l khi ngi dng th/hy th reaction vo tin nhn.
     * Cp nht d liu reaction trong Realtime Database.
     * @param {string} msgKey ID ca tin nhn c reaction.
     * @param {string} emoji Emoji c chn (''  hy).
     */
    async function reactToMessage(msgKey, emoji) {
        if (!currentChatId || !msgKey || !currentUser) return; // Kim tra iu kin cn thit

        // Kim tra xem tin nhn c tn ti v cha b thu hi khng
        const checkMsgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
        const msgSnapshot = await get(checkMsgRef); // Ly data 1 ln
        if (!msgSnapshot.exists() || msgSnapshot.val().recalled) {
            showToast("Khng th th cm xc vo tin nhn ny.", "success");
            return; // Dng nu tin nhn khng hp l
        }

        const pathBase = `/messages/${currentChatId}/${msgKey}/reactions`; // ng dn gc ti reactions ca tin nhn

        // X l nt Hy reaction ''
        if (emoji === '') {
            const reactionsRef = ref(rtdb, pathBase);
            get(reactionsRef).then(snap => { // Ly data reactions 1 ln
                if (snap.exists()) {
                    const reactions = snap.val();
                    // Duyt qua tt c emoji v xa reaction ca user hin ti
                    for (const existingEmoji in reactions) {
                        remove(ref(rtdb, `${pathBase}/${existingEmoji}/${currentUser.uid}`));
                    }
                    console.log(`Removed all reactions from user ${currentUser.uid} on msg ${msgKey}`);
                }
            }).catch(err => console.error("Error removing reactions:", err));
            return; // Dng hm sau khi x l hy
        }

        // X l cc emoji khc
        const reactionRef = ref(rtdb, `${pathBase}/${emoji}/${currentUser.uid}`);

        // Ly trng thi reaction hin ti ca user cho emoji ny
        get(reactionRef).then(snap => {
            if (emoji === '') {
                // Tri tim l b m -> Tng ln 1
                const currentCount = snap.val() || 0; // Ly count hin ti, mc nh l 0
                set(reactionRef, currentCount + 1); // Tng count ln 1
                console.log(`User ${currentUser.uid} added heart to msg ${msgKey}. New count: ${currentCount + 1}`);
            } else {
                // Cc emoji khc l cng tc bt/tt
                if (snap.exists()) {
                    remove(reactionRef); // Nu  react -> Hy reaction
                    console.log(`User ${currentUser.uid} removed ${emoji} from msg ${msgKey}`);
                } else {
                    set(reactionRef, true); // Nu cha react -> Thm reaction (gi tr true)
                    console.log(`User ${currentUser.uid} added ${emoji} to msg ${msgKey}`);
                }
            }
        }).catch(err => console.error(`Error reacting with ${emoji}:`, err));
    }

    /**
     * Hin th modal chi tit cc lt reaction cho mt tin nhn.
     * @param {string} msgKey ID ca tin nhn cn xem chi tit reactions.
     */
    async function showReactionsDetails(msgKey) {
        // Kim tra cc element modal cn thit
        if (!reactionsModal || !reactionsList || !closeReactionsModal) {
            console.error("Missing reaction modal elements!");
            return;
        }

        // Ly d liu tin nhn mi nht
        const msgRef = ref(rtdb, `/messages/${currentChatId}/${msgKey}`);
        const snap = await get(msgRef); // Ly data 1 ln
        if (!snap.exists()) {
            showToast("Tin nhn khng cn tn ti.", "error");
            return;
        }
        const msg = snap.val();
        const reactions = msg.reactions || {}; // Ly reactions, mc nh l object rng

        reactionsList.innerHTML = 'ang ti thng tin ngi th...'; // Hin th loading
        reactionsModal.style.display = 'flex'; // Hin modal

        // Gom tt c ngi th v emoji/count vo mt mng
        let allReactors = [];
        for (const [emoji, reactors] of Object.entries(reactions)) {
            for (const [uid, value] of Object.entries(reactors)) {
                // Tnh count (l value nu l , ngc li l 1)
                const count = (emoji === '' && typeof value === 'number') ? value : 1;
                allReactors.push({ uid, emoji, count });
            }
        }

        // Sp xp (v d: theo emoji trc, ri n tn user) - Ty chn
        allReactors.sort((a, b) => a.emoji.localeCompare(b.emoji));

        if (allReactors.length === 0) {
            reactionsList.innerHTML = '<p style="color: var(--text-2); text-align: center;">Cha c ai by t cm xc.</p>';
            return; // Dng nu khng c ai th
        }

        // To HTML cho danh sch ngi th
        let html = '';
        // Ly thng tin user (tn, avatar) cho tng ngi th
        const userPromises = allReactors.map(reactor => getDoc(doc(db, 'users', reactor.uid)));
        const userDocs = await Promise.all(userPromises);

        allReactors.forEach((reactor, index) => {
            const userDoc = userDocs[index]; // Ly userDoc tng ng
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const displayName = userData.displayName || userData.email || 'Ngi dng n danh';
                const avatarUrl = userData.avatarUrl || `https://placehold.co/36x36?text=${displayName[0].toUpperCase()}`;
                const countDisplay = reactor.count > 1 ? ` ${reactor.count}` : ''; // Hin th s lng nu > 1 (cho tim)
                html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="${avatarUrl}" alt="Avatar">
                        <span class="reaction-user-name">${escapeHtml(displayName)}</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${countDisplay}</span>
                </div>
            `;
            } else {
                // X l trng hp khng tm thy user (v d: user  xa ti khon)
                html += `
                <div class="reaction-user-item">
                    <div class="reaction-user-info">
                        <img class="reaction-user-avatar" src="https://placehold.co/36x36?text=?">
                        <span class="reaction-user-name" style="color: var(--text-2); font-style: italic;">Ngi dng khng tn ti</span>
                    </div>
                    <span class="reaction-emoji">${reactor.emoji}${reactor.count > 1 ? ` ${reactor.count}` : ''}</span>
                </div>
            `;
            }
        });

        reactionsList.innerHTML = html; // Cp nht ni dung danh sch
    }

    // Gn s kin ng modal reactions (nu cha c trong attachEventListeners)
    if (closeReactionsModal) {
        closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
    }
    if (reactionsModal) { // ng khi bm ra ngoi
        reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };
    }

    /**
     * M modal to nhm mi v hin th danh sch bn b  mi.
     */
    async function openCreateGroupModal() {
        // Kim tra cc element cn thit
        if (!createGroupModal || !groupMembersChecklist || !groupNameInput || !confirmCreateGroupBtn) {
            console.error("Missing elements for create group modal!");
            return;
        }

        groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">ang ti danh sch bn b...</p>'; // Hin th loading
        groupNameInput.value = ''; // Reset tn nhm
        createGroupModal.style.display = 'flex'; // Hin modal

        // Ly danh sch bn b mi nht t Firestore (hoc dng bin `friends`  cache nu c)
        const meDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const friendUids = meDoc.data()?.friends || [];

        groupMembersChecklist.innerHTML = ''; // Xa loading/ni dung c

        if (friendUids.length === 0) {
            groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Bn cha c bn b  mi vo nhm.</p>';
            confirmCreateGroupBtn.disabled = true; // V hiu ha nt to nu khng c ai  mi
            return;
        } else {
            confirmCreateGroupBtn.disabled = false; // Bt li nt to
        }

        // Hin th danh sch bn b vi checkbox
        let friendCount = 0;
        for (const friendUid of friendUids) {
            // u tin ly data t cache `friends` nu c, khng th query Firestore
            const friendData = friends.find(f => f.uid === friendUid);
            let displayName = 'Ngi dng n';
            let avatarUrl = 'https://placehold.co/32x32?text=?';

            if (friendData) {
                displayName = friendData.displayName || friendData.email || 'Ngi dng n';
                avatarUrl = friendData.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
                friendCount++;
            } else {
                // Fallback: Query Firestore nu khng c trong cache (t xy ra nu `loadAndSortChats` chy ng)
                try {
                    const friendDoc = await getDoc(doc(db, 'users', friendUid));
                    if (friendDoc.exists()) {
                        const fd = friendDoc.data();
                        displayName = fd.displayName || fd.email || 'Ngi dng n';
                        avatarUrl = fd.avatarUrl || `https://placehold.co/32x32?text=${displayName[0].toUpperCase()}`;
                        friendCount++;
                    } else {
                        continue; // B qua nu user khng tn ti
                    }
                } catch (err) {
                    console.error("Error fetching friend data for group modal:", friendUid, err);
                    continue; // B qua nu li
                }
            }


            // To HTML cho mi bn b
            const div = document.createElement('div');
            div.innerHTML = `
            <label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;">
                <input type="checkbox" class="group-member-checkbox" value="${friendUid}" style="width: 18px; height: 18px; flex-shrink: 0;">
                <img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(displayName)}</span>
            </label>`;
            const label = div.querySelector('label');
            // Thm hiu ng hover n gin
            label.onmouseover = () => label.style.backgroundColor = 'var(--glass)';
            label.onmouseout = () => label.style.backgroundColor = 'transparent';
            groupMembersChecklist.appendChild(div);
        }
        // Nu sau khi duyt ht m khng c bn b hp l no
        if (friendCount === 0) {
            groupMembersChecklist.innerHTML = '<p style="color: var(--text-2); text-align: center;">Khng tm thy bn b hp l  mi.</p>';
            confirmCreateGroupBtn.disabled = true;
        }
    }

    /**
     * Xc nhn to nhm mi sau khi  nhp tn v chn thnh vin.
     */
    async function confirmCreateGroup() {
        if (!groupNameInput || !groupMembersChecklist || !confirmCreateGroupBtn || !createGroupModal) return;

        const groupName = groupNameInput.value.trim();
        if (!groupName) {
            showToast('Vui lng nhp tn nhm.', 'error');
            return;
        }

        // Ly UID ca cc thnh vin c chn
        const memberCheckboxes = groupMembersChecklist.querySelectorAll('.group-member-checkbox:checked');
        const invitedUids = Array.from(memberCheckboxes).map(cb => cb.value);

        // Bao gm c ngi to nhm
        const memberUids = [currentUser.uid, ...invitedUids];

        // Nhm phi c t nht 2 ngi (tnh c ngi to)
        if (memberUids.length < 2) {
            showToast('Nhm phi c t nht 2 thnh vin.', 'error');
            return;
        }

        // To object roles (ngi to l admin, cn li l member)
        const roles = { [currentUser.uid]: 'admin' };
        invitedUids.forEach(uid => roles[uid] = 'member');

        confirmCreateGroupBtn.disabled = true; // V hiu ha nt
        confirmCreateGroupBtn.textContent = 'ang to...';

        try {
            // Thm document nhm mi vo Firestore
            const newGroupRef = await addDoc(collection(db, 'groups'), {
                groupName: groupName,
                member_uids: memberUids, // Mng UID thnh vin
                roles: roles,            // Object vai tr
                createdBy: currentUser.uid, // UID ngi to
                createdAt: serverTimestamp(), // Thi gian to
                // avatarUrl: null // C th thm avatar mc nh nu mun
            });

            showToast(` to nhm "${groupName}"!`, 'success');
            createGroupModal.style.display = 'none'; // ng modal
            groupNameInput.value = ''; // Reset form

            // Ty chn: T ng m chat nhm va to
            startGroupChat(newGroupRef.id, groupName);

        } catch (error) {
            console.error("Li khi to nhm:", error);
            showToast("Khng th to nhm: " + error.message, 'error');
        } finally {
            confirmCreateGroupBtn.disabled = false; // M li nt
            confirmCreateGroupBtn.textContent = 'To Nhm';
        }
    }

    /**
     * Kick mt thnh vin ra khi nhm (ch Admin/Mod lm c).
     * @param {string} groupId ID ca nhm.
     * @param {string} targetUid UID ca thnh vin b kick.
     */
    async function kickMember(groupId, targetUid) {
        if (!groupId || !targetUid) return;
        const groupRef = doc(db, 'groups', groupId);
        try {
            // Cp nht Firestore: Xa UID khi mng members v xa role
            await updateDoc(groupRef, {
                member_uids: arrayRemove(targetUid),    // Xa khi mng thnh vin
                [`roles.${targetUid}`]: deleteField() // Xa vai tr ca h
            });
            showToast(' kick thnh vin thnh cng.', 'success');
            // Giao din s t cp nht nh onSnapshot trong showGroupInfo
        } catch (error) {
            console.error("Li khi kick thnh vin:", error);
            showToast("C li xy ra khi kick thnh vin.", "error");
        }
    }

    /**
     * Thay i vai tr ca thnh vin trong nhm (ch Admin lm c).
     * @param {string} groupId ID ca nhm.
     * @param {string} targetUid UID ca thnh vin cn i vai tr.
     * @param {'moderator' | 'member'} newRole Vai tr mi ('moderator' hoc 'member').
     */
    async function changeRole(groupId, targetUid, newRole) {
        if (!groupId || !targetUid || (newRole !== 'moderator' && newRole !== 'member')) return;
        const groupRef = doc(db, 'groups', groupId);
        try {
            // Cp nht Firestore: Thay i gi tr trong object roles
            await updateDoc(groupRef, {
                [`roles.${targetUid}`]: newRole
            });
            showToast(` cp nht vai tr thnh ${newRole === 'moderator' ? 'Ph nhm' : 'Thnh vin'}.`, 'success');
            // Giao din s t cp nht nh onSnapshot trong showGroupInfo
        } catch (error) {
            console.error("Li khi thay i vai tr:", error);
            showToast("C li xy ra khi i vai tr.", "error");
        }
    }

    /**
     * Ri khi mt nhm chat.
     * @param {string} groupId ID ca nhm cn ri.
     * @param {string} groupName Tn ca nhm ( hin th confirm).
     */
    async function leaveGroup(groupId, groupName) {
        if (!groupId || !currentUser) return;
        const confirmed = await showConfirmation(`Bn c chc mun ri khi nhm "${groupName || 'ny'}"?`);
        if (confirmed) {
            const groupRef = doc(db, 'groups', groupId);
            leaveGroupBtn.disabled = true; leaveGroupBtn.textContent = 'ang ri...'; // Cp nht nt
            try {
                // Cp nht Firestore: Xa UID khi mng members v xa role
                await updateDoc(groupRef, {
                    member_uids: arrayRemove(currentUser.uid),
                    [`roles.${currentUser.uid}`]: deleteField()
                });
                showToast(' ri nhm thnh cng.', 'success');
                if (chatInfoPanel) chatInfoPanel.classList.remove('open'); // ng panel info

                // Reset UI nu ang xem nhm va ri
                if (currentChatId === groupId) {
                    if (currentChatFriendName) currentChatFriendName.textContent = "Chn cuc tr chuyn";
                    if (messagesContainer) messagesContainer.innerHTML = '';
                    if (messageInput) messageInput.disabled = true;
                    if (sendBtn) sendBtn.disabled = true;
                    currentChatId = null; currentChatType = null;
                    if (currentChatAvatar) currentChatAvatar.style.display = 'none';
                    if (groupInfoBtn) groupInfoBtn.style.display = 'none';
                    if (toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
                }
                // T ng load li list chat (v onSnapshot ca group s c trigger)
                // loadAndSortChats(); // Khng cn gi li  y

            } catch (error) {
                console.error("Li khi ri nhm:", error);
                showToast("C li xy ra khi ri nhm.", "error");
                leaveGroupBtn.disabled = false; leaveGroupBtn.textContent = 'Ri nhm'; // Reset nt nu li
            }
        }
    }

    /**
     * Gii tn mt nhm chat (ch Admin lm c).
     * Xa document nhm khi Firestore v xa tin nhn/typing khi RTDB.
     * @param {string} groupId ID ca nhm cn gii tn.
     * @param {string} groupName Tn ca nhm ( hin th confirm).
     */
    async function disbandGroup(groupId, groupName) {
        if (!groupId || !currentUser) return;
        const confirmed = await showConfirmation(`Bn c chc chn mun gii tn nhm "${groupName || 'ny'}" khng? Hnh ng ny s xa ton b tin nhn v KHNG TH hon tc!`);
        if (confirmed) {
            if (!disbandGroupBtn) return; // Kim tra nt tn ti
            disbandGroupBtn.disabled = true; disbandGroupBtn.textContent = 'ang gii tn...';
            try {
                // 1. Xa document nhm khi Firestore
                await deleteDoc(doc(db, 'groups', groupId));

                // 2. Xa d liu tin nhn khi RTDB
                await remove(ref(rtdb, `/messages/${groupId}`));

                // 3. Xa d liu typing khi RTDB
                await remove(ref(rtdb, `/typing/${groupId}`));

                showToast(" gii tn nhm thnh cng!", "success");
                if (chatInfoPanel) chatInfoPanel.classList.remove('open');

                // Reset UI nu ang xem nhm va gii tn
                if (currentChatId === groupId) {
                    if (currentChatFriendName) currentChatFriendName.textContent = "Chn cuc tr chuyn";
                    if (messagesContainer) messagesContainer.innerHTML = '';
                    if (messageInput) messageInput.disabled = true;
                    if (sendBtn) sendBtn.disabled = true;
                    currentChatId = null; currentChatType = null;
                    if (currentChatAvatar) currentChatAvatar.style.display = 'none';
                    if (groupInfoBtn) groupInfoBtn.style.display = 'none';
                    if (toggleMuteBtnGroup) toggleMuteBtnGroup.style.display = 'none';
                }
                // T ng load li list chat (v onSnapshot ca group s c trigger)

            } catch (err) {
                console.error("Li gii tn nhm:", err);
                showToast("Li khi gii tn nhm!", "error");
                disbandGroupBtn.disabled = false; disbandGroupBtn.textContent = ' Gii tn nhm';
            }
        }
    }

    /**
     * Gn s kin input cho  tm kim chung (sidebar).
     * Tm kim bn b, nhm v hin th kt qu trong dropdown.
     */
    function attachGlobalSearch() {
        if (!globalSearch || !searchDropdown) return; // Kim tra element

        globalSearch.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            // n dropdown nu  tm kim rng
            if (!searchTerm) {
                searchDropdown.style.display = 'none';
                searchDropdown.innerHTML = '';
                return;
            }

            searchDropdown.innerHTML = '<div class="result-item"><div class="result-sub">ang tm...</div></div>'; // Hin th loading
            searchDropdown.style.display = 'block';

            // Ly danh sch bn b v nhm t cache (bin `friends` v query Firestore)
            // Lu : Bin `friends` cn c cp nht trong `loadAndSortChats`
            const friendUIDs = currentUserData.friends || [];
            // const friendsData = friends; // Dng bin global  cp nht

            const qg = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
            const gs = await getDocs(qg);
            const groupsData = [];
            gs.forEach(d => groupsData.push({ id: d.id, ...d.data() }));

            // Lc kt qu
            const friendsFiltered = friends.filter(u =>
                (u.displayName || u.email || '').toLowerCase().includes(searchTerm)
            );
            const groupsFiltered = groupsData.filter(g =>
                (g.groupName || '').toLowerCase().includes(searchTerm)
            );
            // Optional: Thm tm kim ngi dng khc (cha phi bn b)
            // const usersQuery = query(collection(db, "users"), where("email", ">=", searchTerm), where("email", "<=", searchTerm + '\uf8ff'), limit(5));
            // const usersSnap = await getDocs(usersQuery);
            // const usersFiltered = usersSnap.docs.map(d => d.data()).filter(u => u.uid !== currentUser.uid && !friendUIDs.includes(u.uid));


            searchDropdown.innerHTML = ''; // Xa loading

            // Hm helper  render mt mc kt qu
            const renderResultItem = (itemData, type) => {
                const el = document.createElement('div');
                el.className = 'result-item';
                const avatarPlaceholder = (itemData.displayName || itemData.groupName || '?')[0].toUpperCase();
                const avatarSrc = itemData.avatarUrl || `https://placehold.co/32x32?text=${avatarPlaceholder}`;
                const name = type === 'group' ? ` ${itemData.groupName}` : (itemData.displayName || itemData.email);
                const verifiedTick = createVerifiedTickHTML(itemData.isVerified);

                el.innerHTML = `
                <div class="result-left">
                    <img class="result-avatar" src="${avatarSrc}" alt="Avatar">
                    <div><div class="result-name">${escapeHtml(name)}${verifiedTick}</div></div>
                </div>
            `;
                // Thm nt kt bn nu l user l (cha lm phn tm user l)
                /* if (type === 'user' && !isFriend) {
                    el.innerHTML += `<div class="result-action"><button class="add-friend-btn" data-uid="${itemData.uid}">Kt bn</button></div>`;
                } */

                el.onclick = () => {
                    if (type === 'direct') startDirectChat(itemData);
                    else if (type === 'group') startGroupChat(itemData.id, itemData.groupName);
                    // else if (type === 'user') { /* M profile user l? */ }
                    hideDropdown();
                };
                // Gn s kin cho nt kt bn nu c
                // const addBtn = el.querySelector('.add-friend-btn');
                // if (addBtn) { addBtn.onclick = (ev) => { ev.stopPropagation(); /* ... logic gi li mi ... */ }; }

                return el;
            };

            // Hm helper  thm section vo dropdown
            const addSection = (title, items, renderFunc, type) => {
                const st = document.createElement('div'); st.className = 'section-title'; st.textContent = title; searchDropdown.appendChild(st);
                if (!items.length) { const em = document.createElement('div'); em.className = 'result-item'; em.innerHTML = `<div class="result-sub" style="text-align:center;">Khng c kt qu</div>`; searchDropdown.appendChild(em); return; }
                items.forEach(x => searchDropdown.appendChild(renderFunc(x, type)));
            };

            // Render cc section
            addSection('Bn b', friendsFiltered, renderResultItem, 'direct');
            addSection('Nhm', groupsFiltered, renderResultItem, 'group');
            // addSection('Ngi dng khc', usersFiltered, renderResultItem, 'user'); // Nu c tm user l

            searchDropdown.style.display = 'block'; // Hin th dropdown
        });

        // n dropdown khi click ra ngoi
        const hideDropdown = () => { if (searchDropdown) searchDropdown.style.display = 'none'; };
        document.addEventListener('click', (e) => {
            if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) {
                hideDropdown();
            }
        });
    }

    /**
     * X l tham s 'chat' hoc 'chat_group' trong URL khi ti trang.
     * T ng m cuc tr chuyn tng ng nu c.
     */
    async function handleUrlChat() {
        const params = new URLSearchParams(window.location.search);
        const friendUid = params.get('chat');
        const groupId = params.get('chat_group');

        if (friendUid) {
            try {
                const userDoc = await getDoc(doc(db, 'users', friendUid));
                if (userDoc.exists()) {
                    await startDirectChat({ uid: friendUid, ...userDoc.data() }); // Truyn data user vo
                } else {
                    console.warn("User specified in URL not found:", friendUid);
                    history.replaceState(null, '', window.location.pathname); // Xa param khi URL
                }
            } catch (error) {
                console.error("Error handling direct chat URL:", error);
                history.replaceState(null, '', window.location.pathname);
            }
        } else if (groupId) {
            try {
                const groupDoc = await getDoc(doc(db, 'groups', groupId));
                if (groupDoc.exists()) {
                    await startGroupChat(groupId, groupDoc.data().groupName); // Gi startGroupChat
                } else {
                    console.warn("Group specified in URL not found:", groupId);
                    history.replaceState(null, '', window.location.pathname);
                }
            } catch (error) {
                console.error("Error handling group chat URL:", error);
                history.replaceState(null, '', window.location.pathname);
            }
        }
    }

    /**
     * Lng nghe cc notification mi c y vo RTDB cho user hin ti.
     * Hin th thng bo trnh duyt nu chat  khng ang m v khng b mute.
     */
    function listenForNotifications_Optimized() {
        if (!currentUser) return;
        const notifsRef = ref(rtdb, `/notifications/${currentUser.uid}`);
        onChildAdded(notifsRef, async (snapshot) => { // Dng async  await ly data mute
            const notification = snapshot.val();
            if (!notification) { remove(snapshot.ref); return; } // Xa notif rng

            try {
                // Ly trng thi mute MI NHT ca user hin ti
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const latestUserData = userDoc.exists() ? userDoc.data() : {};

                // Kim tra xem chat ny c b user hin ti mute khng
                const isMuted = latestUserData.mutedChats?.[notification.chatId] === true;

                // Nu chat b mute hoc ang m -> Ch xa notif, khng hin th
                if (isMuted || notification.chatId === currentChatId) {
                    remove(snapshot.ref);
                    return;
                }

                // Nu khng b mute v khng ang m -> Hin th thng bo
                showSimpleNotification(notification.from, notification.preview, notification.avatar);
                // Optional: Tng unread count trn tab title nu cn (c th trng vi renderMessage)
                // if (document.hidden) { unreadCount++; document.title = `(${unreadCount}) ${originalTitle}`; }

            } catch (error) {
                console.error("Error processing notification:", error);
            } finally {
                // Lun xa notification khi RTDB sau khi x l (hoc li)
                remove(snapshot.ref);
            }
        });
    }

    /**
     * X l input  gi  mention (@) trong group chat.
     */
    function handleMentionInput() {
        if (!mentionSuggestions || !messageInput) return;
        let isMentioning = false; let mentionQuery = '';

        messageInput.addEventListener('input', (e) => {
            const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
            if (lastAtPos !== -1 && currentChatType === 'group') { isMentioning = true; mentionQuery = text.substring(lastAtPos + 1, cursorPos).toLowerCase(); showSuggestions(mentionQuery); }
            else { isMentioning = false; mentionSuggestions.style.display = 'none'; }
        });
        // Optional: Add keydown listener for arrow keys/enter

        function showSuggestions(query) {
            mentionSuggestions.innerHTML = ''; let suggestions = [];
            if ('all'.includes(query)) suggestions.push({ type: 'all' });
            if (currentGroupMembers.length > 0) { const filtered = currentGroupMembers.filter(m => m.uid !== currentUser.uid && (m.displayName || '').toLowerCase().includes(query)); suggestions = suggestions.concat(filtered.map(m => ({ ...m, type: 'user' }))); }
            if (suggestions.length === 0) { mentionSuggestions.style.display = 'none'; return; }
            suggestions.forEach(item => { const div = document.createElement('div'); div.className = 'suggestion-item'; if (item.type === 'all') { div.innerHTML = `<span class="all">@all</span>`; div.onclick = () => insertMention('@all', 'all'); } else { const avatar = item.avatarUrl || `https://placehold.co/28x28?text=${(item.displayName || '?')[0]}`; div.innerHTML = `<img src="${avatar}" alt=""><span class="name">${escapeHtml(item.displayName || '')}</span>`; div.onclick = () => insertMention(item.displayName, item.uid); } mentionSuggestions.appendChild(div); });
            mentionSuggestions.style.display = 'block';
        }
        function insertMention(name, uidOrAll) {
            const text = messageInput.value; const cursorPos = messageInput.selectionStart; let lastAtPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) { if (text[i] === '@') { if (i === 0 || /\s/.test(text[i - 1])) { lastAtPos = i; break; } } if (/\s/.test(text[i])) break; }
            if (lastAtPos !== -1) { const before = text.substring(0, lastAtPos); const after = text.substring(cursorPos); const mentionText = (uidOrAll === 'all') ? '@all' : `@${name}`; messageInput.value = before + mentionText + ' ' + after; messageInput.focus(); const newPos = before.length + mentionText.length + 1; messageInput.setSelectionRange(newPos, newPos); }
            mentionSuggestions.style.display = 'none'; isMentioning = false; messageInput.dispatchEvent(new Event('input')); // Trigger input event
        }
    }

    function openLightbox(imageUrl, messageKey) {
        console.log("openLightbox called with:", imageUrl, messageKey);
        if (!imageLightbox || !lightboxImg) return;

        imageLightbox.style.display = '';

        // <<< THM DNG NY  RENDER TT C THUMBNAIL CA CHAT HIN TI >>>
        renderLightboxThumbnails(currentChatImages);

        const index = messageKey ? currentChatImages.findIndex(img => img.key === messageKey) : -1;

        if (index > -1) {
            currentLightboxIndex = index;
            lightboxImg.src = imageUrl;
            // Cp nht URL cho nt ti
            if (lightboxDownloadBtn) {
                lightboxDownloadBtn.href = imageUrl;
            }
            imageLightbox.classList.add('show');
            updateLightboxNav();
            updateLightboxThumbnails(); // Kch hot thumbnail active v cun
        } else {
            console.warn("Image key not found or null, opening without navigation.");
            currentLightboxIndex = -1;
            lightboxImg.src = imageUrl;
            if (lightboxDownloadBtn) { lightboxDownloadBtn.href = imageUrl; } // Cp nht nt ti cho nh n
            imageLightbox.classList.add('show');
            updateLightboxNav(); // S n nt nav
            updateLightboxThumbnails(); // Vn gi  x l cun/active nu cn
        }
    }

    // === HM RENDER TT C THUMBNAIL CA CHAT HIN TI ===
    function renderLightboxThumbnails(images) {
        if (!lightboxThumbnailsList) return;

        lightboxThumbnailsList.innerHTML = ''; // Xa thumbnails c
        if (images.length === 0) {
            lightboxThumbnailsContainer.style.display = 'none'; // n container nu khng c nh
            return;
        } else {
            lightboxThumbnailsContainer.style.display = 'flex'; // Hin container
        }

        images.forEach((imgObj, idx) => {
            const thumbnail = document.createElement('img');
            thumbnail.className = 'lightbox-thumbnail-item';
            thumbnail.src = imgObj.url;
            thumbnail.alt = `Thumbnail ${idx + 1}`;
            thumbnail.dataset.index = idx; // Lu index  d dng chuyn nh

            thumbnail.onclick = () => {
                showLightboxImage(idx); // Bm thumbnail s chuyn nh
            };
            lightboxThumbnailsList.appendChild(thumbnail);
        });
        updateLightboxThumbnails(); // Gi ln u  cun v active
    }

    // === HM CP NHT THUMBNAIL ACTIVE V CUN ===
    function updateLightboxThumbnails() {
        if (!lightboxThumbnailsList || currentLightboxIndex === -1) {
            lightboxThumbnailsContainer.style.display = 'none'; // n nu khng c nh
            return;
        }

        lightboxThumbnailsContainer.style.display = 'flex'; // m bo hin

        const thumbnails = lightboxThumbnailsList.querySelectorAll('.lightbox-thumbnail-item');
        thumbnails.forEach((thumb, idx) => {
            if (idx === currentLightboxIndex) {
                thumb.classList.add('active');
                // Cun n thumbnail ang active
                thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            } else {
                thumb.classList.remove('active');
            }
        });
    }

    // === GN LI S KIN NG LIGHTBOX ===
    // (m bo l  c, nu cha th thm vo)
    if (lightboxCloseBtn) lightboxCloseBtn.onclick = closeLightbox;
    if (imageLightbox) imageLightbox.onclick = (e) => {
        if (e.target === imageLightbox || e.target.id === 'lightbox-download-btn') { // Khng ng khi bm nt ti
            // Cn x l ring cho nt ti  n khng ng overlay
            // Nt ti c target="_blank" nn n s m tab mi v khng ng lightbox
            if (e.target.id !== 'lightbox-download-btn') {
                closeLightbox();
            }
        }
    };
    // Nu mun ng khi bm vo overlay m khng bao gm nh, ch cn:
    // if (imageLightbox) imageLightbox.onclick = (e) => {
    //     if (e.target.classList.contains('lightbox-overlay')) { // Ch ng khi click trc tip vo nn overlay
    //         closeLightbox();
    //     }
    // };


    // === Optional: Thm iu hng bng bn phm (nu cha c) ===
    document.addEventListener('keydown', (e) => {
        if (imageLightbox.classList.contains('show')) {
            if (e.key === 'ArrowLeft') {
                if (currentLightboxIndex > 0) showLightboxImage(currentLightboxIndex - 1);
            } else if (e.key === 'ArrowRight') {
                if (currentLightboxIndex < currentChatImages.length - 1) showLightboxImage(currentLightboxIndex + 1);
            } else if (e.key === 'Escape') {
                closeLightbox();
            }
        }
    });

    /**
     * Ti nh ang hin th trong lightbox v my ngi dng,
     * s dng tn file gc t URL.
     */
    async function downloadCurrentImage() {
        if (!lightboxImg || !lightboxImg.src) {
            showToast("Khng c nh  ti.", "error");
            return;
        }

        const imageUrl = lightboxImg.src;
        let filename = "image.jpg"; // Tn mc nh

        try {
            // Tch ly phn cui cng ca URL sau du /
            const urlParts = imageUrl.split('/');
            const lastPart = urlParts[urlParts.length - 1];

            // Tch b phn query string (sau du ?) nu c
            const filenameWithPotentialQuery = lastPart;
            const queryIndex = filenameWithPotentialQuery.indexOf('?');
            const cleanFilename = queryIndex !== -1 ? filenameWithPotentialQuery.substring(0, queryIndex) : filenameWithPotentialQuery;

            // Decode URL encoding (v d: %20 thnh du cch)
            // Ch thc hin nu tn file khng rng sau khi x l
            if (cleanFilename) {
                filename = decodeURIComponent(cleanFilename);
            }

            // Optional: Nu tn file khng c phn m rng, th on t blob type
            // (Phn ny nng cao hn, c th b qua nu tn file thng c ui)
            const fileExtensionMatch = filename.match(/\.[0-9a-z]+$/i);
            if (!fileExtensionMatch) {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const mimeType = blob.type; // e.g., 'image/jpeg'
                const extension = mimeType.split('/')[1] || 'jpg';
                filename = `${filename}.${extension}`;
            }


        } catch (e) {
            console.warn("Could not accurately parse filename from URL, using default:", imageUrl, e);
            // Gi li tn mc nh nu c li
        }


        if (lightboxDownloadBtn) {
            lightboxDownloadBtn.style.pointerEvents = 'none';
            lightboxDownloadBtn.style.opacity = '0.5';
        }

        try {
            const response = await fetch(imageUrl, {
                // Thm option ny nu gp li CORS khi fetch nh t domain khc (nh ImgBB)
                // mode: 'cors' // C th cn hoc khng ty server nh
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename; // <<< S DNG TN FILE  LY C
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
        } catch (error) {
            console.error('Li ti nh:', error);
            showToast("Khng th ti nh ny. Li: " + error.message, "error");
            window.open(imageUrl, '_blank'); // M tab mi nu li
        } finally {
            if (lightboxDownloadBtn) {
                lightboxDownloadBtn.style.pointerEvents = 'auto';
                lightboxDownloadBtn.style.opacity = '1';
            }
        }
    }

    // === HM NG LIGHTBOX ===
    function closeLightbox() {
        if (!imageLightbox) return;
        imageLightbox.classList.remove('show'); // n lightbox
        currentLightboxIndex = -1; // Reset index
        // Optional: Xa src  gii phng b nh?
        // if (lightboxImg) lightboxImg.src = '';
    }

    // === HM HIN TH NH THEO INDEX ===
    // === HM HIN TH NH THEO INDEX (Cp nht thumbnail) ===
    function showLightboxImage(index) {
        if (!lightboxImg || !currentChatImages || index < 0 || index >= currentChatImages.length) {
            return; // Thot nu index khng hp l
        }

        currentLightboxIndex = index; // Cp nht index
        lightboxImg.src = currentChatImages[index].url; // i nh

        // Cp nht URL cho nt ti
        if (lightboxDownloadBtn) {
            lightboxDownloadBtn.href = currentChatImages[index].url;
        }

        updateLightboxNav();           // Cp nht nt prev/next
        updateLightboxThumbnails();    // <<< THM DNG NY  CP NHT THUMBNAIL
    }

    // === HM CP NHT HIN TH NT PREV/NEXT ===
    function updateLightboxNav() {
        const prevBtn = document.getElementById('lightbox-prev-btn');
        const nextBtn = document.getElementById('lightbox-next-btn');
        if (!prevBtn || !nextBtn) return;

        // Hin nt Prev nu khng phi nh u tin
        prevBtn.style.display = (currentLightboxIndex > 0) ? 'block' : 'none';

        // Hin nt Next nu khng phi nh cui cng
        nextBtn.style.display = (currentLightboxIndex > -1 && currentLightboxIndex < currentChatImages.length - 1) ? 'block' : 'none';
    }

    // === GN S KIN CHO CC NT LIGHTBOX MI ===
    const prevBtn = document.getElementById('lightbox-prev-btn');
    const nextBtn = document.getElementById('lightbox-next-btn');
    // Nt ng  c trong attachEventListeners hoc thm  y:
    if (lightboxCloseBtn) lightboxCloseBtn.onclick = closeLightbox;
    // ng khi click vo overlay
    if (imageLightbox) imageLightbox.onclick = (e) => { if (e.target === imageLightbox) closeLightbox(); };
    // Nt Prev
    if (prevBtn) prevBtn.onclick = () => showLightboxImage(currentLightboxIndex - 1);
    // Nt Next
    if (nextBtn) nextBtn.onclick = () => showLightboxImage(currentLightboxIndex + 1);

    // Optional: Thm iu hng bng bn phm
    document.addEventListener('keydown', (e) => {
        if (imageLightbox.classList.contains('show')) { // Ch x l khi lightbox ang m
            if (e.key === 'ArrowLeft') {
                if (currentLightboxIndex > 0) showLightboxImage(currentLightboxIndex - 1);
            } else if (e.key === 'ArrowRight') {
                if (currentLightboxIndex < currentChatImages.length - 1) showLightboxImage(currentLightboxIndex + 1);
            } else if (e.key === 'Escape') {
                closeLightbox();
            }
        }
    });

    /**
     * Lu thay i thng tin h s t modal chnh sa.
     */
    async function saveProfileChanges() {
        if (!profileDisplayName || !profileBio || !profileAvatarUrl || !saveProfileEditBtn || !cancelProfileEditBtn || !editProfileModal) return; // Check elements

        const newDisplayName = profileDisplayName.value.trim();
        const newBio = profileBio.value.trim();
        const newAvatarUrl = profileAvatarUrl.value.trim();

        if (!newDisplayName) return showToast('Tn hin th khng c  trng.', 'error');
        // Optional: Validate URL avatar c bn
        // if (newAvatarUrl && !newAvatarUrl.startsWith('http')) return showToast('URL Avatar khng hp l.', 'error');

        saveProfileEditBtn.disabled = true; saveProfileEditBtn.textContent = 'ang lu...';

        const userRef = doc(db, 'users', currentUser.uid);
        try {
            await updateDoc(userRef, {
                displayName: newDisplayName,
                bio: newBio || deleteField(), // Xa field nu bio rng
                avatarUrl: newAvatarUrl || deleteField() // Xa field nu avatar rng (nn c nh mc nh)
            });
            showToast('Cp nht h s thnh cng!', 'success');
            editProfileModal.style.display = 'none'; // ng modal
            // Giao din (avatar nav) s t cp nht nh listener `wireProfile`
        } catch (error) {
            console.error("Li khi cp nht h s:", error);
            showToast('C li xy ra, khng th cp nht.', 'error');
        } finally {
            saveProfileEditBtn.disabled = false; saveProfileEditBtn.textContent = 'Lu thay i';
        }
    }

    /**
     * Gi bo co ngi dng ln Firestore.
     */
    async function submitReport() {
        if (!reportingUser || !currentUser || !reportUserModal || !submitReportBtn) return;
        const reasonRadio = document.querySelector('input[name="reportReason"]:checked');
        if (!reasonRadio) return showToast("Vui lng chn l do bo co.", "error");
        const reason = reasonRadio.value;
        const details = reportDetails ? reportDetails.value.trim() : '';

        submitReportBtn.disabled = true; submitReportBtn.textContent = 'ang gi...';

        try {
            await addDoc(collection(db, "reports"), {
                reporterUid: currentUser.uid,
                reportedUid: reportingUser.uid,
                reason: reason,
                details: details || null, // Lu null nu khng c chi tit
                evidence: selectedEvidence.length > 0 ? selectedEvidence : null, // Lu mng tin nhn bng chng
                timestamp: serverTimestamp()
                // Optional: Thm ng cnh nh chat ID, group ID
                // chatId: currentChatId,
                // chatType: currentChatType
            });
            showToast(" gi bo co thnh cng. Cm n bn!", "success");
        } catch (error) {
            console.error("Li khi gi bo co:", error);
            showToast("C li xy ra, khng th gi bo co.", "error");
        } finally {
            reportUserModal.style.display = 'none'; // ng modal
            if (reportDetails) reportDetails.value = ''; // Reset form
            const defaultReason = document.querySelector('input[name="reportReason"][value="spam"]');
            if (defaultReason) defaultReason.checked = true; // Reset radio
            document.querySelectorAll('.report-reason-row.selected').forEach(r => r.classList.remove('selected')); // B highlight
            reportingUser = null; // Reset ngi b bo co
            selectedEvidence = []; // Reset bng chng
            if (evidencePreview) evidencePreview.style.display = 'none'; // n preview bng chng
            submitReportBtn.disabled = false; submitReportBtn.textContent = 'Gi bo co'; // Reset nt
        }
    }

    // Cc hm lin quan n chn bng chng bo co
    function enterMessageSelectionMode() { /* ... Ging code trc ... */ }
    function exitMessageSelectionMode(saveChanges = false) { /* ... Ging code trc ... */ }
    function updateSelectionCount() { /* ... Ging code trc ... */ }

    /**
     * Gi bo co li ln Firestore.
     */
    async function submitBugReport() {
        if (!bugDescription || !bugSteps || !submitBugReportBtn || !reportBugModal) return;
        const description = bugDescription.value.trim();
        const steps = bugSteps.value.trim();
        if (!description) return showToast("Vui lng m t li.", "error");

        submitBugReportBtn.disabled = true; submitBugReportBtn.textContent = "ang gi...";
        try {
            await addDoc(collection(db, "bug_reports"), {
                userId: currentUser?.uid || "unknown",
                email: currentUser?.email || "unknown",
                description: description,
                stepsToReproduce: steps || null,
                timestamp: serverTimestamp(),
                userAgent: navigator.userAgent,
                appVersion: "1.0" // Cp nht version app ca cu
            });
            showToast(" gi bo co li! Cm n bn.", "success");
            reportBugModal.style.display = 'none';
            bugDescription.value = ''; bugSteps.value = '';
        } catch (error) { console.error("Li gi bo co li:", error); showToast("Gi bo co tht bi: " + error.message, "error"); }
        finally { submitBugReportBtn.disabled = false; submitBugReportBtn.textContent = "Gi bo co"; }
    }

    /**
     * Ti v hin th danh sch bn b cho tab "Bn b".
     * Ly danh sch UID t currentUserData, ly chi tit tng ngi,
     * render ln list v gn s kin filter cho  tm kim.
     */
    function attachFriendsViewListeners() {
        const friendsNavItems = document.querySelectorAll('.friends-nav-item');
        const friendsPages = document.querySelectorAll('.friends-content-page');
        const addFriendBtnPage = document.getElementById('friends-view-add-btn');

        friendsNavItems.forEach(item => {
            item.onclick = () => {
                const pageId = item.dataset.friendsPage;
                if (!pageId) return;

                friendsPages.forEach(page => {
                    page.style.display = (page.id === `friends-page-${pageId}`) ? 'flex' : 'none';
                    page.classList.toggle('active', page.id === `friends-page-${pageId}`);
                });
                friendsNavItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                // Ti/Render d liu cho trang
                if (pageId === 'list') {
                    renderFriendsListPage(friends);
                    // Gn li s kin tm kim nu cn
                    const friendsListSearch = document.getElementById('friends-list-search');
                    if (friendsListSearch) {
                        friendsListSearch.oninput = (e) => {
                            renderFriendsListPage(friends, e.target.value);
                        };
                    }
                } else if (pageId === 'requests') {
                    loadFriendRequestsPage();
                } else if (pageId === 'groups') {
                    // === THAY I  Y ===
                    renderGroupsListPage(); // Gi hm render danh sch nhm
                    // =======================
                }
            }
        });
    }

    // === HM MI: RENDER TRANG DANH SCH BN B (Alphabetical) ===
    function renderFriendsListPage(friendsData, filter = '') {
        const listContainer = document.getElementById('friends-list-alphabetical');
        const countTitle = document.getElementById('friends-count-title');
        if (!listContainer || !countTitle) return;

        countTitle.textContent = `Bn b (${friendsData.length})`; // Cp nht tng s bn

        const searchTerm = filter.toLowerCase();
        let filteredFriends = friendsData;
        if (searchTerm) {
            filteredFriends = friendsData.filter(f => (f.displayName || f.email || '').toLowerCase().includes(searchTerm));
        }

        if (filteredFriends.length === 0) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Khng tm thy bn b no.</p>';
            return;
        }

        // Sp xp theo tn A-Z
        filteredFriends.sort((a, b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));

        // Nhm theo ch ci
        const groupedFriends = filteredFriends.reduce((acc, friend) => {
            const name = friend.displayName || friend.email || '';
            let firstLetter = name[0] ? name[0].toUpperCase() : '#';
            if (!/[A-Z]/.test(firstLetter)) firstLetter = '#'; // Nhm s/k t l vo #

            if (!acc[firstLetter]) acc[firstLetter] = [];
            acc[firstLetter].push(friend);
            return acc;
        }, {});

        // Render HTML
        listContainer.innerHTML = ''; // Xa sch
        Object.keys(groupedFriends).sort().forEach(letter => { // Sp xp ch ci
            // Thm di phn cch ch ci
            const divider = document.createElement('div');
            divider.className = 'letter-divider';
            divider.textContent = letter;
            listContainer.appendChild(divider);

            // Render tng bn b trong nhm ch ci 
            groupedFriends[letter].forEach(u => {
                const item = document.createElement('div');
                item.className = 'friend-list-item';
                item.onclick = () => {
                    const chatNavButton = document.querySelector('.nav-button[data-view="chat"]');
                    if (chatNavButton) chatNavButton.click(); // Chuyn v tab chat
                    startDirectChat(u); // M chat
                };

                const avatarSrc = u.avatarUrl || `https://placehold.co/40x40?text=${(u.displayName || '?')[0].toUpperCase()}`;
                const verifiedTick = createVerifiedTickHTML(u.isVerified);
                const friendName = u.displayName || u.email || 'Ngi dng';

                item.innerHTML = `
                    <div class="friend-list-left">
                        <img class="friend-list-avatar" src="${avatarSrc}" alt="Avatar">
                        <span class="friend-list-name">${escapeHtml(friendName)}${verifiedTick}</span>
                    </div>
                    <div class="friend-list-actions">
                        <button class="friend-action-btn" title="Ty chn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                    </div>
                `;
                // TODO: Gn s kin cho nt 3 chm
                listContainer.appendChild(item);
            });
        });
    }

    // === HM MI: RENDER TRANG LI MI KT BN ===
    function renderFriendRequestsPage(requestsData) {
        const listContainer = document.getElementById('friends-requests-list-page');
        if (!listContainer) return;

        if (requestsData.length === 0) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Khng c li mi kt bn no.</p>';
            return;
        }

        listContainer.innerHTML = ''; // Xa placeholder
        requestsData.forEach(req => {
            const item = document.createElement('div');
            item.className = 'friend-req-item'; // Dng li style c
            item.innerHTML = `
                <div class="friend-list-left"> <img class="friend-list-avatar" src="${req.from_avatar || 'https://placehold.co/40x40?text=?'}" alt="Avatar">
                    <div class="friend-list-name" style="font-size: 15px;">${escapeHtml(req.from_displayName || req.from_email)}</div>
                </div>
                <div class="friend-req-buttons">
                    <button class="friend-req-btn reject-btn" data-req-id="${req.id}">T chi</button>
                    <button class="friend-req-btn accept-btn" data-req-id="${req.id}" data-from-uid="${req.from_uid}">Chp nhn</button>
                </div>
            `;
            listContainer.appendChild(item);
        });

        // Gn s kin cho cc nt mi (dng event delegation)
        listContainer.onclick = (e) => {
            const target = e.target;
            if (target.classList.contains('accept-btn')) {
                target.disabled = true;
                handleAcceptFriend(target.dataset.reqId, target.dataset.fromUid);
            } else if (target.classList.contains('reject-btn')) {
                target.disabled = true;
                handleRejectFriend(target.dataset.reqId);
            }
        };
    }

    // === HM MI: TI DATA CHO TAB BN B ===
    async function loadFriendsPageData() {
        if (!currentUserData) return;

        // Load danh sch bn b (ging hm c, ch render)
        const friendUIDs = currentUserData.friends || [];
        // 'friends' (bin global)  c load trong onAuthStateChanged/loadAndSortChats
        renderFriendsListPage(friends); // Render list mc nh

        // Gn s kin filter cho  search
        const friendsListSearch = document.getElementById('friends-list-search');
        if (friendsListSearch) {
            friendsListSearch.oninput = (e) => {
                renderFriendsListPage(friends, e.target.value);
            };
        }
    }

    /**
     * Render ni dung changelog vo modal t mng changelogData.
     */
    function renderChangelog() {
        if (!changelogContent || !changelogData) return;
        changelogContent.innerHTML = '';

        changelogData.forEach((entry, index) => {
            const entryBox = document.createElement('div');
            entryBox.className = 'changelog-entry-box';

            // 1. To phn Header ( bm vo)
            const header = document.createElement('div');
            header.className = 'changelog-header clickable';
            header.innerHTML = `
      <div class="changelog-header-left">
        <h3>Phin bn ${entry.version}</h3>
        <span>${escapeHtml(entry.subtitle || entry.date)}</span>
      </div>
      <svg class="changelog-chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    `;

            // 2. To phn Ni dung (b n)
            const detailsContent = document.createElement('div');
            detailsContent.className = 'changelog-details-content';
            detailsContent.style.display = 'none';

            if (Array.isArray(entry.details)) {
                entry.details.forEach(line => {
                    const p = document.createElement('p');
                    p.textContent = line;
                    detailsContent.appendChild(p);
                });
            } else if (entry.details) {
                const p = document.createElement('p');
                p.textContent = entry.details;
                detailsContent.appendChild(p);
            }

            // 3. Gn s kin Click
            header.onclick = () => {
                const isOpen = detailsContent.style.display === 'block';
                detailsContent.style.display = isOpen ? 'none' : 'block';
                header.classList.toggle('open', !isOpen);
            };

            // 4. B vo box chnh
            entryBox.appendChild(header);
            entryBox.appendChild(detailsContent);
            changelogContent.appendChild(entryBox);
        });
    }

    /**
     * X l hin th popup thng bo (nu dng Remote Config).
     * Ly d liu title, message, image t Remote Config v hin th modal.
     */
    function handleAnnouncementPopup() {
        // Ch chy nu c Remote Config v cc element popup
        if (typeof getRemoteConfig === 'undefined' || !announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
            console.warn("Remote Config or Announcement elements not available.");
            return;
        }

        try {
            const show = getBoolean(remoteConfig, "show_announcement"); // Key config: show_announcement (Boolean)
            if (show) {
                const title = getValue(remoteConfig, "announcement_title").asString() || "Thng bo"; // Key: announcement_title (String)
                const message = getValue(remoteConfig, "announcement_message").asString(); // Key: announcement_message (String)
                const imageUrl = getValue(remoteConfig, "announcement_image_url").asString(); // Key: announcement_image_url (String)

                if (!message) { // Khng hin nu khng c ni dung
                    console.warn("Announcement message is empty.");
                    return;
                }

                announcementTitle.textContent = title;
                announcementText.textContent = message; //  x l xung dng bng white-space: pre-wrap

                if (imageUrl) {
                    announcementImage.src = imageUrl;
                    announcementImage.style.display = 'block'; // Hin nh
                } else {
                    announcementImage.style.display = 'none'; // n nh nu khng c URL
                }

                announcementOverlay.classList.add('show'); // Hin popup vi hiu ng
            } else {
                announcementOverlay.classList.remove('show'); // m bo n nu config l false
            }
        } catch (error) {
            console.error("Error handling announcement popup:", error);
        }
    }

    /**
     * Hin th popup bo tr (nu dng Remote Config).
     * S dng li modal announcement nhng n nt ng.
     */
    function showMaintenancePopup() {
        if (!announcementOverlay || !announcementTitle || !announcementText || !announcementImage || !closeAnnouncementBtn) {
            console.warn("Announcement elements not available for maintenance message. Using alert fallback.");
            alert("ng dng ang bo tr. Vui lng quay li sau."); // Fallback
            return;
        }

        try {
            // Ly thng bo bo tr t Remote Config hoc hardcode
            const maintenanceMsg = getValue(remoteConfig, "maintenance_message")?.asString() || "ng dng ang c bo tr. Vui lng kim tra li sau t pht."; // Key: maintenance_message (String)
            const maintenanceTitle = "Thng bo bo tr";

            announcementTitle.textContent = maintenanceTitle;
            announcementText.textContent = maintenanceMsg;
            announcementImage.style.display = 'none'; // Lun n nh khi bo tr
            closeAnnouncementBtn.style.display = 'none'; // n nt ng
            announcementOverlay.onclick = null; // V hiu ha ng khi click ra ngoi

            announcementOverlay.classList.add('show'); // Hin popup
        } catch (error) {
            console.error("Error showing maintenance popup:", error);
            alert("ng dng ang bo tr. Vui lng quay li sau."); // Fallback
        }
    }

    // === HM MI: RENDER TRANG DANH SCH NHM ( SA CLICK) ===
    async function renderGroupsListPage() {
        const listContainer = document.getElementById('friends-groups-list');
        const pageContainer = document.getElementById('friends-page-groups');
        if (!listContainer || !pageContainer) {
            console.error("Missing elements for groups list page!");
            return;
        }

        if (pageContainer.classList.contains('active')) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">ang ti danh sch nhm...</p>';
        }

        if (!currentUser) {
            listContainer.innerHTML = '<p class="friends-list-placeholder">Li: Cha ng nhp.</p>';
            return;
        }

        try {
            const groupsQuery = query(collection(db, 'groups'), where('member_uids', 'array-contains', currentUser.uid));
            const groupSnap = await getDocs(groupsQuery);

            if (groupSnap.empty) {
                listContainer.innerHTML = '<p class="friends-list-placeholder">Bn cha tham gia nhm no.</p>';
                return;
            }

            listContainer.innerHTML = ''; // Xa loading

            const groupsData = groupSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            groupsData.sort((a, b) => (a.groupName || '').localeCompare(b.groupName || ''));

            groupsData.forEach(g => {
                const item = document.createElement('div');
                item.className = 'friend-list-item';
                item.style.cursor = 'pointer';

                // Chng ta lu thng tin nhm vo thng HTML
                item.dataset.groupId = g.id;
                item.dataset.groupName = g.groupName;

                const memberCount = g.member_uids ? g.member_uids.length : 0;
                const avatarSrc = g.avatarUrl || `https://placehold.co/40x40/1e293b/fff?text=${(g.groupName || '?')[0].toUpperCase()}`;
                const groupDisplayName = g.groupName || 'Nhm khng tn';

                item.innerHTML = `
                <div class="friend-list-left">
                    <img class="friend-list-avatar" src="${avatarSrc}" alt="Group Avatar">
                    <div>
                        <span class="friend-list-name">${escapeHtml(groupDisplayName)}</span>
                        <div class="result-sub" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${memberCount} thnh vin</div>
                    </div>
                </div>
                <div class="friend-list-actions">
                     </div>
            `;
                listContainer.appendChild(item);
            });

            listContainer.onclick = (e) => {
                // Tm xem phn t cha gn nht c class 'friend-list-item' l g
                const clickedItem = e.target.closest('.friend-list-item');

                // Nu khng bm vo item no (bm vo khong trng) th thi
                if (!clickedItem) return;

                // Ly data t dataset chng ta  lu
                const groupId = clickedItem.dataset.groupId;
                const groupName = clickedItem.dataset.groupName;

                if (groupId && groupName) {
                    // Dng log mi  kim tra
                    console.log("Clicked group item (event delegation):", groupId, groupName);

                    const chatNavButton = document.querySelector('.nav-button[data-view="chat"]');
                    if (chatNavButton) chatNavButton.click();

                    startGroupChat(groupId, groupName);
                } else {
                    console.warn("Clicked item missing data:", clickedItem);
                }
            };
        } catch (error) {
            console.error("Li khi ti danh sch nhm:", error);
            listContainer.innerHTML = '<p class="friends-list-placeholder" style="color: red;">Li ti danh sch nhm!</p>';
        }
    }

    function attachEventListeners() {
        handleMentionInput(); // Kch hot gi  mention

        navButtons.forEach(button => {
            button.onclick = (e) => {
                const targetViewId = button.dataset.view;
                if (!targetViewId) return;

                // Cp nht nt active
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Hin th view tng ng
                appViews.forEach(view => {
                    view.style.display = (view.dataset.view === targetViewId) ? 'block' : 'none';
                    view.classList.toggle('active', view.dataset.view === targetViewId);
                });

                // Logic ring cho tng view
                if (targetViewId === 'friends') {
                    loadFriendsPageData(); // <<< THM DNG NY VO
                    attachFriendsViewListeners(); // <<< THM DNG NY VO
                } else if (targetViewId === 'wall') {
                    // Load iframe Wall nu cha load
                    if (!wallLoaded && currentUser && wallLoader && wallIframe) {
                        wallLoader.style.display = 'flex';
                        wallLoader.innerHTML = '<div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>';
                        wallIframe.src = `wall.html?id=${currentUser.uid}`;
                        wallIframe.onload = () => { if (wallLoader) wallLoader.style.display = 'none'; wallLoaded = true; wallIframe.onload = null; wallIframe.onerror = null; };
                        wallIframe.onerror = () => { if (wallLoader) wallLoader.innerHTML = '<p style="color: red;">Li ti Tng nh!</p>'; wallIframe.onload = null; wallIframe.onerror = null; }
                    } else if (wallLoaded && wallLoader) {
                        wallLoader.style.display = 'none';
                    }
                } else if (targetViewId === 'chat') {
                    // C th thm logic khi quay li tab chat nu cn
                }

                // Lun ng menu settings khi chuyn tab
                if (navSettingsMenu) navSettingsMenu.style.display = 'none';
            };
        });

        // === THM ON NY VO ===
        // Add Member Modal (Fix nt Hy)
        const cancelAddMemberBtn = document.getElementById('cancel-add-member-btn');
        const addMemberModal = document.getElementById('add-member-modal');
        if (cancelAddMemberBtn && addMemberModal) {
            cancelAddMemberBtn.onclick = () => {
                addMemberModal.style.display = 'none';
            };
        }
        // === KT THC ON THM ===

        const downloadBtn = document.getElementById('lightbox-download-btn'); // <<< Ly nt ti
        // <<< THM S KIN CHO NT TI >>>
        if (downloadBtn) {
            downloadBtn.onclick = (e) => {
                e.preventDefault(); // Ngn hnh vi mc nh ca th <a>
                e.stopPropagation(); // Ngn s kin click lan ra overlay
                downloadCurrentImage(); // Gi hm ti nh
            };
        }
        if (navAvatar && navSettingsMenu) {
            navAvatar.onclick = (e) => {
                e.stopPropagation();
                if (addMenu) addMenu.style.display = 'none'; // ng menu kia
                const isCurrentlyVisible = navSettingsMenu.style.display === 'block';
                navSettingsMenu.style.display = isCurrentlyVisible ? 'none' : 'block';
            };
        }
        // Gn s kin cho cc mc trong menu settings
        const profileBtn = document.getElementById('go-to-profile');
        if (profileBtn) profileBtn.onclick = () => { if (currentUser) window.location.href = `profile.html?uid=${currentUser.uid}`; if (navSettingsMenu) navSettingsMenu.style.display = 'none'; };
        if (showChangelogBtn && changelogModal) showChangelogBtn.onclick = () => { renderChangelog(); changelogModal.style.display = 'flex'; if (navSettingsMenu) navSettingsMenu.style.display = 'none'; };
        if (openReportBugModalBtn && reportBugModal) openReportBugModalBtn.onclick = () => { reportBugModal.style.display = 'flex'; if (navSettingsMenu) navSettingsMenu.style.display = 'none'; };
        if (openAboutModalBtn && aboutModal) openAboutModalBtn.onclick = () => { aboutModal.style.display = 'flex'; if (navSettingsMenu) navSettingsMenu.style.display = 'none'; };
        const settingsBtn = document.getElementById('go-to-settings');
        if (settingsBtn) settingsBtn.onclick = () => { window.location.href = 'settings.html'; if (navSettingsMenu) navSettingsMenu.style.display = 'none'; };
        const logoutBtn = document.getElementById('go-login');
        if (logoutBtn) logoutBtn.onclick = async () => { await signOut(auth); window.location.href = 'login.html'; };

        if (addBtn && addMenu) {
            addBtn.onclick = (e) => {
                e.stopPropagation(); // Ngn lan ra document
                if (navSettingsMenu) navSettingsMenu.style.display = 'none'; // ng menu kia
                addMenu.style.display = addMenu.style.display === 'block' ? 'none' : 'block';
            };
        }
        const createGroupMenuBtn = document.getElementById('create-group-from-menu');
        if (createGroupMenuBtn) createGroupMenuBtn.onclick = () => { openCreateGroupModal(); if (addMenu) addMenu.style.display = 'none'; };
        const addFriendMenuBtn = document.getElementById('add-friend-from-menu');
        const addFriendModalElem = document.getElementById('add-friend-modal'); // i tn bin
        if (addFriendMenuBtn && addFriendModalElem) addFriendMenuBtn.onclick = () => { addFriendModalElem.style.display = 'flex'; if (addMenu) addMenu.style.display = 'none'; };

        // Add Friend Modal
        const cancelAddFriendBtn = document.getElementById('cancel-add-friend-btn');
        const confirmAddFriendBtn = document.getElementById('confirm-add-friend-btn');
        if (cancelAddFriendBtn && addFriendModalElem) cancelAddFriendBtn.onclick = () => addFriendModalElem.style.display = 'none';
        if (confirmAddFriendBtn) confirmAddFriendBtn.onclick = addFriendByEmail; // Vn dng logic m profile

        // Friend Request Modal

        // Create Group Modal
        if (closeGroupModalBtn && createGroupModal) closeGroupModalBtn.onclick = () => createGroupModal.style.display = 'none';
        if (confirmCreateGroupBtn) confirmCreateGroupBtn.onclick = confirmCreateGroup;

        // Reactions Modal
        if (closeReactionsModal && reactionsModal) closeReactionsModal.onclick = () => reactionsModal.style.display = 'none';
        if (reactionsModal) reactionsModal.onclick = (e) => { if (e.target === reactionsModal) reactionsModal.style.display = 'none'; };

        // Edit Profile Modal
        const editProfileBtn = document.getElementById('edit-profile-btn'); // Nt m modal (nu c)
        if (editProfileBtn && editProfileModal) editProfileBtn.onclick = () => { /* Logic in form */ editProfileModal.style.display = 'flex'; };
        if (cancelProfileEditBtn && editProfileModal) cancelProfileEditBtn.onclick = () => editProfileModal.style.display = 'none';
        if (saveProfileEditBtn) saveProfileEditBtn.onclick = saveProfileChanges;

        // Custom Confirm Modal ( gn trong showConfirmation)

        // Report User Modal
        if (cancelReportBtn && reportUserModal) cancelReportBtn.onclick = () => { reportUserModal.style.display = 'none'; if (reportDetails) reportDetails.value = ''; /* Reset form */ };
        if (submitReportBtn) submitReportBtn.onclick = submitReport;
        if (attachEvidenceBtn) attachEvidenceBtn.onclick = enterMessageSelectionMode;
        if (cancelSelectionBtn) cancelSelectionBtn.onclick = () => exitMessageSelectionMode(false);
        if (confirmSelectionBtn) confirmSelectionBtn.onclick = () => exitMessageSelectionMode(true);
        // X l radio reasons
        document.querySelectorAll('.report-reason-row').forEach(row => { row.onclick = () => { document.querySelectorAll('.report-reason-row').forEach(r => r.classList.remove('selected')); row.classList.add('selected'); const radio = row.querySelector('input[type="radio"]'); if (radio) radio.checked = true; }; });

        // Edit Group Modal ( gn trong showGroupInfo)
        // Add Member Modal ( gn trong showGroupInfo)

        // Changelog Modal
        // Changelog Modal
        const closeChangelogXBtn = document.getElementById('close-changelog-x-btn');
        if (closeChangelogXBtn && changelogModal) closeChangelogXBtn.onclick = () => changelogModal.style.display = 'none';
        if (changelogModal) changelogModal.onclick = (e) => { if (e.target === changelogModal) changelogModal.style.display = 'none'; };
        // Announcement Modal
        if (closeAnnouncementBtn && announcementOverlay) closeAnnouncementBtn.onclick = () => announcementOverlay.classList.remove('show');
        if (announcementOverlay) announcementOverlay.onclick = (e) => { if (e.target === announcementOverlay && closeAnnouncementBtn && closeAnnouncementBtn.style.display !== 'none') announcementOverlay.classList.remove('show'); };

        // Report Bug Modal
        if (cancelReportBugBtn && reportBugModal) cancelReportBugBtn.onclick = () => { reportBugModal.style.display = 'none'; if (bugDescription) bugDescription.value = ''; if (bugSteps) bugSteps.value = ''; };
        if (submitBugReportBtn) submitBugReportBtn.onclick = submitBugReport;
        if (reportBugModal) reportBugModal.onclick = (e) => { if (e.target === reportBugModal) { reportBugModal.style.display = 'none'; if (bugDescription) bugDescription.value = ''; if (bugSteps) bugSteps.value = ''; } };

        // About Modal
        if (closeAboutModalBtn && aboutModal) closeAboutModalBtn.onclick = () => aboutModal.style.display = 'none';
        if (aboutModal) aboutModal.onclick = (e) => { if (e.target === aboutModal) aboutModal.style.display = 'none'; };

        // Join Group Modal (nu c logic join qua link)
        const cancelJoinBtn = document.getElementById('cancel-join-group-btn');
        const confirmJoinBtn = document.getElementById('confirm-join-group-btn');
        const joinGroupModal = document.getElementById('join-group-modal');
        if (cancelJoinBtn && joinGroupModal) cancelJoinBtn.onclick = () => joinGroupModal.style.display = 'none';
        // if(confirmJoinBtn) confirmJoinBtn.onclick = () => { /* Logic join group */ };

        if (sendBtn) sendBtn.onclick = sendMessage;
        if (cancelReplyBtn) cancelReplyBtn.onclick = cancelReply;
        if (cancelEditBtn) cancelEditBtn.onclick = cancelEdit;
        if (cancelPreviewBtn) cancelPreviewBtn.onclick = cancelImagePreview;
        if (closeInfoBtn && chatInfoPanel) closeInfoBtn.onclick = () => chatInfoPanel.classList.remove('open');
        if (toastCloseBtn && toast) toastCloseBtn.onclick = () => toast.style.display = 'none';
        if (lightboxCloseBtn && imageLightbox) lightboxCloseBtn.onclick = () => imageLightbox.style.display = 'none';
        if (imageLightbox) {
            imageLightbox.onclick = (e) => {
                // Ch ng khi click trc tip vo element overlay (nn m)
                // KHNG ng khi click vo nh (img), nt (button), hoc thumbnail list
                if (e.target === imageLightbox) { // <<< KIM TRA TARGET L OVERLAY
                    closeLightbox();
                }
            };
        }

        if (messageInput) {
            messageInput.addEventListener('paste', handlePasteImage);
            messageInput.addEventListener('input', handleTextInput);
            messageInput.addEventListener('keypress', handleEnterSend);
        }
        if (imageInput) imageInput.onchange = handleImageSelection;

        if (messagesContainer) {
            messagesContainer.addEventListener('contextmenu', showMessageContextMenu);
            messagesContainer.addEventListener('mouseover', handleMouseOverMessage);
        }
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // ng cc menu khi click ra ngoi
        document.addEventListener('click', (e) => {
            if (navSettingsMenu && !navSettingsMenu.contains(e.target) && e.target !== navAvatar) navSettingsMenu.style.display = 'none';
            if (addMenu && !addMenu.contains(e.target) && e.target !== addBtn) addMenu.style.display = 'none';
            if (messageContextMenu && !messageContextMenu.contains(e.target)) messageContextMenu.style.display = 'none';
            // ng dropdown tm kim nu click ra ngoi
            if (globalSearch && searchDropdown && e.target !== globalSearch && !searchDropdown.contains(e.target)) searchDropdown.style.display = 'none';
        });
    }

    function handlePasteImage(event) {
        const items = (event.clipboardData || window.clipboardData).items; let imageFile = null;
        for (let i = 0; i < items.length; i++) { if (items[i].kind === 'file' && items[i].type.startsWith('image/')) { imageFile = items[i].getAsFile(); break; } }
        if (imageFile && imagePreview && imagePreviewContainer && messageInput && chatInputContainer) {
            event.preventDefault(); selectedImageFile = imageFile; const reader = new FileReader();
            reader.onload = (ev) => { if (ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Thm ch thch...'; chatInputContainer.classList.add('has-text'); };
            reader.readAsDataURL(imageFile);
        }
    }
    function handleTextInput() {
        if (!messageInput || !chatInputContainer) return;
        const hasText = messageInput.value.trim().length > 0;
        chatInputContainer.classList.toggle('has-text', hasText || selectedImageFile != null);
        if (!currentChatId || !currentUser) return; const tRef = ref(rtdb, `/typing/${currentChatId}/${currentUser.uid}`);
        set(tRef, true); clearTimeout(typingTimer); typingTimer = setTimeout(() => set(tRef, false), 2000);
    }
    function handleEnterSend(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
    function handleImageSelection(e) {
        const f = e.target.files?.[0]; if (!f || !imagePreview || !imagePreviewContainer || !messageInput || !chatInputContainer) return; selectedImageFile = f; const reader = new FileReader();
        reader.onload = (ev) => { if (ev.target?.result) imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; messageInput.placeholder = 'Thm ch thch...'; chatInputContainer.classList.add('has-text'); };
        reader.readAsDataURL(f);
    }
    /**
     * Hin th thng tin chi tit ca nhm chat trong panel bn phi.
     *  FIX LI "roleClass is not defined".
     * @param {string} groupId ID ca nhm cn hin th thng tin.
     */
    async function showGroupInfo(groupId) {
        // Kim tra cc element panel chnh
        if (!friendInfoContent || !groupInfoContent || !chatInfoPanel) {
            console.error("Missing main info panel content elements!");
            return;
        }
        friendInfoContent.style.display = 'none'; // n panel bn b
        groupInfoContent.style.display = 'block'; // Hin panel nhm

        const groupRef = doc(db, "groups", groupId); // Tham chiu n document nhm

        // Dng onSnapshot  lng nghe thay i d liu nhm theo thi gian thc
        onSnapshot(groupRef, async (groupDoc) => {

            const groupAvatarPanel = groupInfoContent.querySelector('#group-avatar');
            const groupNameDisplayPanel = groupInfoContent.querySelector('#group-name-display');
            const groupMembersListPanel = groupInfoContent.querySelector('#group-members-list');
            const groupSentImagesGridPanel = groupInfoContent.querySelector('#group-sent-images-grid');
            const addMemberBtnPanel = groupInfoContent.querySelector('#add-group-member-btn');
            const disbandGroupBtnPanel = groupInfoContent.querySelector('#disband-group-btn');
            const leaveGroupBtnPanel = groupInfoContent.querySelector('#leave-group-btn');
            const toggleMuteBtnGroupPanel = groupInfoContent.querySelector('#toggle-mute-btn-group');
            const muteIconOnGroupPanel = groupInfoContent.querySelector('#mute-icon-on-group');
            const muteIconOffGroupPanel = groupInfoContent.querySelector('#mute-icon-off-group');
            const muteBtnTextGroupPanel = groupInfoContent.querySelector('#mute-btn-text-group');

            // Kim tra cc element quan trng
            if (!groupAvatarPanel || !groupNameDisplayPanel || !groupMembersListPanel || !groupSentImagesGridPanel || !addMemberBtnPanel || !disbandGroupBtnPanel || !leaveGroupBtnPanel || !toggleMuteBtnGroupPanel) {
                console.error("Missing elements inside group info panel!");
                groupInfoContent.innerHTML = '<p style="color:red; padding: 10px;">Li ti giao din thng tin nhm.</p>';
                return;
            }

            if (!groupDoc.exists()) {
                groupNameDisplayPanel.textContent = "Nhm khng tn ti";
                groupAvatarPanel.src = 'https://placehold.co/95x95';
                groupMembersListPanel.innerHTML = '';
                groupSentImagesGridPanel.innerHTML = '';
                addMemberBtnPanel.style.display = 'none';
                disbandGroupBtnPanel.style.display = 'none';
                toggleMuteBtnGroupPanel.style.display = 'none';
                leaveGroupBtnPanel.style.display = 'none';
                // V hiu ha kh nng edit
                groupAvatarPanel.classList.remove('editable-group-info');
                groupNameDisplayPanel.classList.remove('editable-group-info');
                groupAvatarPanel.onclick = null;
                groupNameDisplayPanel.onclick = null;
                return; // Dng hm
            }

            const groupData = groupDoc.data();
            const groupName = groupData.groupName || 'Nhm khng tn';
            const roles = groupData.roles || {};
            const myRole = roles[currentUser.uid]; // Vai tr ca user hin ti
            const groupAvatarUrl = groupData.avatarUrl;
            const memberUids = groupData.member_uids || [];

            groupNameDisplayPanel.textContent = groupName;
            groupAvatarPanel.src = groupAvatarUrl || `https://placehold.co/95x95/1e293b/fff?text=${escapeHtml(groupName[0])}`;

            if (toggleMuteBtnGroupPanel && muteIconOnGroupPanel && muteIconOffGroupPanel && muteBtnTextGroupPanel) {
                const chatIdForMute = groupId;
                const isMutedGroup = currentUserData.mutedChats?.[chatIdForMute] === true;
                muteIconOnGroupPanel.style.display = isMutedGroup ? 'none' : 'inline-block';
                muteIconOffGroupPanel.style.display = isMutedGroup ? 'inline-block' : 'none';
                muteBtnTextGroupPanel.textContent = isMutedGroup ? "Bt thng bo" : "Tt thng bo";
                toggleMuteBtnGroupPanel.title = isMutedGroup ? "Bt thng bo" : "Tt thng bo";

                // Gn li onclick  m bo dng d liu mute mi nht
                toggleMuteBtnGroupPanel.onclick = async () => {
                    const currentlyMuted = currentUserData.mutedChats?.[chatIdForMute] === true;
                    const newMutedStatus = !currentlyMuted;
                    toggleMuteBtnGroupPanel.disabled = true;
                    try {
                        const userRef = doc(db, 'users', currentUser.uid);
                        const fieldName = `mutedChats.${chatIdForMute}`;
                        if (newMutedStatus) {
                            await updateDoc(userRef, { [fieldName]: true });
                            if (!currentUserData.mutedChats) currentUserData.mutedChats = {};
                            currentUserData.mutedChats[chatIdForMute] = true;
                            showToast(" tt thng bo cho nhm ny.", "info");
                        } else {
                            await updateDoc(userRef, { [fieldName]: deleteField() });
                            if (currentUserData.mutedChats) delete currentUserData.mutedChats[chatIdForMute];
                            showToast(" bt thng bo nhm.", "success");
                        }
                        // Cp nht UI ngay lp tc
                        muteIconOnGroupPanel.style.display = newMutedStatus ? 'none' : 'inline-block';
                        muteIconOffGroupPanel.style.display = newMutedStatus ? 'inline-block' : 'none';
                        muteBtnTextGroupPanel.textContent = newMutedStatus ? "Bt thng bo" : "Tt thng bo";
                        toggleMuteBtnGroupPanel.title = newMutedStatus ? "Bt thng bo" : "Tt thng bo";
                    } catch (err) { console.error("Li mute group:", err); showToast("Li!", "error"); }
                    finally { toggleMuteBtnGroupPanel.disabled = false; }
                };
                toggleMuteBtnGroupPanel.style.display = 'block'; // m bo nt hin
            }

            if (myRole === 'admin') {
                disbandGroupBtnPanel.style.display = 'block';
                disbandGroupBtnPanel.onclick = () => disbandGroup(groupId, groupName);
            } else {
                disbandGroupBtnPanel.style.display = 'none';
                disbandGroupBtnPanel.onclick = null;
            }

            if (myRole === 'admin' || myRole === 'moderator') {
                // A. CHO PHP SA TN/AVATAR
                groupAvatarPanel.classList.add('editable-group-info');
                groupNameDisplayPanel.classList.add('editable-group-info');
                groupAvatarPanel.title = "Nhn  i thng tin nhm";
                groupNameDisplayPanel.title = "Nhn  i thng tin nhm";

                const openEditModal = () => {
                    if (!editGroupModal || !editGroupNameInput || !editGroupAvatarInput || !editGroupAvatarPreview || !saveEditGroupBtn || !cancelEditGroupBtn || !groupAvatarUploadInput || !editGroupAvatarLoading) return;
                    editGroupNameInput.value = groupName;
                    editGroupAvatarInput.value = groupAvatarUrl || '';
                    editGroupAvatarPreview.src = groupAvatarUrl || `https://placehold.co/95x95/1e293b/fff?text=${escapeHtml(groupName[0])}`;
                    editGroupAvatarLoading.style.display = 'none';
                    editGroupModal.style.display = 'flex';
                    editGroupModal.classList.add('show');
                };
                groupAvatarPanel.onclick = openEditModal;
                groupNameDisplayPanel.onclick = openEditModal;

                // Gn s kin cho cc nt modal sa nhm (ch gn 1 ln)
                if (!saveEditGroupBtn.dataset.listenerAttached) {
                    editGroupAvatarPreview.onclick = () => { if (groupAvatarUploadInput) groupAvatarUploadInput.click(); };
                    groupAvatarUploadInput.onchange = async () => {
                        const file = groupAvatarUploadInput.files[0]; if (!file || !editGroupAvatarLoading || !editGroupAvatarPreview || !editGroupAvatarInput) return;
                        editGroupAvatarLoading.style.display = 'block'; editGroupAvatarPreview.style.opacity = '0.5';
                        try { const newUrl = await uploadImage(file); editGroupAvatarInput.value = newUrl; editGroupAvatarPreview.src = newUrl; showToast("Ti nh thnh cng!", "success"); }
                        catch (err) { console.error("Li upload:", err); showToast("Li upload!", "error"); }
                        finally { editGroupAvatarLoading.style.display = 'none'; editGroupAvatarPreview.style.opacity = '1'; groupAvatarUploadInput.value = ''; }
                    };
                    saveEditGroupBtn.onclick = async () => {
                        const newName = editGroupNameInput.value.trim(); const newAvatar = editGroupAvatarInput.value.trim();
                        if (!newName) return showToast("Tn nhm trng!", "error");
                        saveEditGroupBtn.disabled = true; saveEditGroupBtn.textContent = 'ang lu...';
                        try {
                            const updates = { groupName: newName, avatarUrl: newAvatar || deleteField() };
                            await updateDoc(groupRef, updates); showToast("Cp nht thnh cng!", "success"); if (editGroupModal) editGroupModal.style.display = 'none'; // <<< THM DNG NY editGroupModal.classList.remove('show');
                        } catch (err) { console.error("Li lu:", err); showToast("Li!", "error"); }
                        finally { saveEditGroupBtn.disabled = false; saveEditGroupBtn.textContent = 'Lu thay i'; }
                    };
                    cancelEditGroupBtn.onclick = () => {
                        if (editGroupModal) {
                            editGroupModal.style.display = 'none'; // <<< THM DNG NY
                            editGroupModal.classList.remove('show');
                        }
                        if (groupAvatarUploadInput) groupAvatarUploadInput.value = '';
                    };
                    saveEditGroupBtn.dataset.listenerAttached = 'true';
                }

                // B. LOGIC THM THNH VIN
                addMemberBtnPanel.style.display = 'block';
                addMemberBtnPanel.onclick = async () => {
                    if (!addMemberModal || !addMemberGroupName || !addMemberFriendList || !confirmAddMemberBtn || !cancelAddMemberBtn) return;
                    const latestGroupDoc = await getDoc(groupRef); if (!latestGroupDoc.exists()) return;
                    const latestGroupData = latestGroupDoc.data(); const latestMemberUids = latestGroupData.member_uids || [];
                    addMemberGroupName.textContent = `Nhm: ${latestGroupData.groupName}`;
                    addMemberFriendList.innerHTML = 'ang ti bn b...'; addMemberModal.style.display = 'flex'; addMemberModal.classList.add('show');
                    const meDoc = await getDoc(doc(db, 'users', currentUser.uid)); const friendUids = meDoc.data()?.friends || [];
                    const friendsToAdd = friendUids.filter(uid => !latestMemberUids.includes(uid));
                    addMemberFriendList.innerHTML = '';
                    if (friendsToAdd.length === 0) { addMemberFriendList.innerHTML = '<p style="color: var(--text-2); text-align: center;">Tt c bn b   trong nhm.</p>'; confirmAddMemberBtn.disabled = true; return; }
                    else { confirmAddMemberBtn.disabled = false; }
                    for (const friendUid of friendsToAdd) {
                        const friendDoc = await getDoc(doc(db, 'users', friendUid));
                        if (friendDoc.exists()) {
                            const friendData = friendDoc.data(); const displayName = friendData.displayName || friendData.email;
                            const avatarUrl = friendData.avatarUrl || `https://placehold.co/32x32?text=${displayName[0]}`;
                            const div = document.createElement('div');
                            div.innerHTML = `<label style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s;"><input type="checkbox" class="add-member-checkbox" value="${friendUid}" style="width: 18px; height: 18px; flex-shrink: 0;"><img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%;"><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(displayName)}</span></label>`;
                            const label = div.querySelector('label');
                            label.onmouseover = () => label.style.backgroundColor = 'var(--glass)';
                            label.onmouseout = () => label.style.backgroundColor = 'transparent';
                            addMemberFriendList.appendChild(div);
                        }
                    }
                };
                // Gn s kin nt trong modal thm thnh vin (ch gn 1 ln)
                if (!confirmAddMemberBtn.dataset.listenerAttached) {
                    cancelAddMemberBtn.onclick = () => {
                        if (addMemberModal) {
                            addMemberModal.style.display = 'none'; // <<< SA LI
                            addMemberModal.classList.remove('show');
                        }
                    };
                    confirmAddMemberBtn.onclick = async () => {
                        const selectedCheckboxes = addMemberFriendList.querySelectorAll('.add-member-checkbox:checked');
                        const uidsToAdd = Array.from(selectedCheckboxes).map(cb => cb.value);
                        if (uidsToAdd.length === 0) return showToast("Vui lng chn bn!", "error");
                        confirmAddMemberBtn.disabled = true; confirmAddMemberBtn.textContent = "ang thm...";
                        try {
                            const updates = { member_uids: arrayUnion(...uidsToAdd) };
                            uidsToAdd.forEach(uid => { updates[`roles.${uid}`] = 'member'; });
                            await updateDoc(groupRef, updates); showToast(" thm!", "success"); if (addMemberModal) addMemberModal.style.display = 'none'; // <<< SA LI addMemberModal.classList.remove('show');
                        } catch (err) { console.error("Li thm:", err); showToast("Li!", "error"); }
                        finally { confirmAddMemberBtn.disabled = false; confirmAddMemberBtn.textContent = "Thm vo nhm"; }
                    };
                    confirmAddMemberBtn.dataset.listenerAttached = 'true';
                }

            } else { // Nu l MEMBER thng
                addMemberBtnPanel.style.display = 'none';
                groupAvatarPanel.classList.remove('editable-group-info');
                groupNameDisplayPanel.classList.remove('editable-group-info');
                groupAvatarPanel.onclick = null;
                groupNameDisplayPanel.onclick = null;
            }

            groupMembersListPanel.innerHTML = '';
            const memberDetailPromises = memberUids.map(uid => getDoc(doc(db, "users", uid)));
            const memberDocs = await Promise.all(memberDetailPromises);

            // <<< KHAI BO BIN B THIU NM  Y >>>
            const roleLabels = { admin: 'Trng nhm', moderator: 'Ph nhm', member: 'Thnh vin' };
            const roleClass = { admin: 'role-admin', moderator: 'role-moderator', member: 'role-member' };
            // <<< FIX XONG >>>

            memberDocs.forEach((userDoc, index) => {
                const uid = memberUids[index];
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const memberRole = roles[uid] || 'member';
                    let actionButtons = '';

                    // Logic to nt Kick/Promote/Demote
                    if (myRole === 'admin' && uid !== currentUser.uid) {
                        actionButtons += `<button data-action="kick" data-uid="${uid}" class="member-action-btn">Kick</button>`;
                        if (memberRole === 'member') actionButtons += `<button data-action="promote-mod" data-uid="${uid}" class="member-action-btn">B Nhim Ph</button>`;
                        else if (memberRole === 'moderator') actionButtons += `<button data-action="demote-member" data-uid="${uid}" class="member-action-btn">Ging xung Member</button>`;
                    } else if (myRole === 'moderator' && memberRole === 'member' && uid !== currentUser.uid) { // Mod c th kick member (nhng khng phi chnh mnh)
                        actionButtons += `<button data-action="kick" data-uid="${uid}" class="member-action-btn">Kick</button>`;
                    }

                    const li = document.createElement('li'); li.className = 'member-item';
                    li.innerHTML = `<div class="member-info"><span class="member-name">${escapeHtml(userData.displayName || userData.email)}</span><span class="member-role ${roleClass[memberRole]}">${roleLabels[memberRole]}</span></div><div class="member-actions">${actionButtons}</div>`;
                    groupMembersListPanel.appendChild(li);
                } else {
                    // Render placeholder nu user khng tn ti
                    const li = document.createElement('li');
                    li.className = 'member-item';
                    li.innerHTML = `<div class="member-info"><span class="member-name" style="color:var(--text-2); font-style:italic;">Thnh vin khng tn ti</span></div>`;
                    groupMembersListPanel.appendChild(li);
                }
            });

            // Gn li s kin cho nt Ri nhm
            if (leaveGroupBtnPanel) {
                leaveGroupBtnPanel.style.display = 'block'; // m bo nt ri nhm lun hin
                leaveGroupBtnPanel.onclick = () => leaveGroup(groupId, groupName);
            }

        }, (error) => { // X l li cho onSnapshot
            console.error(`Error listening to group ${groupId}:`, error);
            if (groupInfoContent) groupInfoContent.innerHTML = '<p style="color:red; padding: 10px;">Li ti thng tin nhm!</p>';
        }); // <-- KT THC ONSNAPSHOT

        // Gn s kin click cho cc nt action trong danh sch thnh vin (dng event delegation)
        // Gn s kin click cho cc nt action trong danh sch thnh vin (dng event delegation)
        if (groupMembersList && !groupMembersList.dataset.listenerAttached) { // Ch gn 1 ln
            groupMembersList.onclick = async (e) => { // <<< 1. THM async VO Y
                const targetButton = e.target.closest('.member-action-btn');
                if (targetButton && targetButton.dataset.action && targetButton.dataset.uid) {
                    const action = targetButton.dataset.action;
                    const targetUid = targetButton.dataset.uid;
                    const targetName = targetButton.closest('.member-item')?.querySelector('.member-name')?.textContent || 'thnh vin ny';

                    // <<< 2. SA LI CCH GI HM CONFIRM
                    if (action === 'kick') {
                        const confirmed = await showConfirmation(`Bn c chc mun kick ${escapeHtml(targetName)} khi nhm?`);
                        if (confirmed) {
                            kickMember(groupId, targetUid);
                        }
                    }
                    else if (action === 'promote-mod') {
                        const confirmed = await showConfirmation(`B nhim ${escapeHtml(targetName)} lm ph nhm?`);
                        if (confirmed) {
                            changeRole(groupId, targetUid, 'moderator');
                        }
                    }
                    else if (action === 'demote-member') {
                        const confirmed = await showConfirmation(`Ging ${escapeHtml(targetName)} xung lm thnh vin?`);
                        if (confirmed) {
                            changeRole(groupId, targetUid, 'member');
                        }
                    }
                    // <<< KT THC SA
                }
            };
            groupMembersList.dataset.listenerAttached = 'true'; // nh du  gn
        }

        // Load nh  gi 1 ln khi m panel
        if (groupSentImagesGrid) {
            groupSentImagesGrid.innerHTML = ''; // Xa nh c
            const groupMsgsRef = ref(rtdb, `/messages/${groupId}`);
            const imagesQuery = rtdbQuery(groupMsgsRef, orderByChild('timestamp'), limitToLast(9));
            get(imagesQuery).then(snap => {
                groupSentImagesGrid.innerHTML = '';
                if (!snap.exists()) { groupSentImagesGrid.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Cha c nh no.</p>'; return; }
                const imageMsgs = [];
                snap.forEach(child => { const msg = child.val(); if (msg.imageUrl) imageMsgs.push(msg.imageUrl); });
                if (imageMsgs.length === 0) { groupSentImagesGrid.innerHTML = '<p style="font-size: 13px; color: var(--text-2); text-align: left;">Cha c nh no.</p>'; }
                else { imageMsgs.reverse().forEach(url => { const img = document.createElement('img'); img.src = url; img.alt = "nh nhm"; img.onclick = () => openLightbox(url, null); groupSentImagesGrid.appendChild(img); }); }
            }).catch(err => { console.error("Error fetching group images:", err); groupSentImagesGrid.innerHTML = '<p style="color:red;">Li ti nh</p>'; });
        }
    }

    function handleMouseOverMessage(e) {
        const msgWrapper = e.target.closest('.msg-wrapper'); if (!msgWrapper?.dataset.key) return;
        let picker = msgWrapper.querySelector('.reaction-picker');
        const contentWrapper = msgWrapper.querySelector('.msg-content-wrapper'); // Gn vo y
        if (!picker && contentWrapper) { picker = createReactionPicker(msgWrapper.dataset.key); contentWrapper.appendChild(picker); }
        // else if (!picker && !contentWrapper) { // Fallback nu cu trc HTML khc
        //      picker = createReactionPicker(msgWrapper.dataset.key);
        //      msgWrapper.appendChild(picker);
        // }
        // Logic hin/n picker  c x l bng CSS :hover
    }
    function handleVisibilityChange() { if (!document.hidden) { unreadCount = 0; document.title = originalTitle; } }

    initTheme(); // Gi initTheme ngay khi script load
    // onAuthStateChanged s t chy v gi initializeAppLogic sau khi user hp l

</script>
</body>

</html>