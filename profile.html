<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë§ H·ªì s∆° c√° nh√¢n</title>
    <link rel="shortcut icon" href="assets/favicon.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0084ff;
            --primary-grad: linear-gradient(135deg, #0084ff, #00c6ff);
            --bg: #f8fafc;
            --surface: rgba(255, 255, 255, 0.85);
            --text: #0f172a;
            --text-light: #64748b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        .bg-cover {
            position: fixed;
            inset: 0;
            z-index: -2;
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.9);
            transform: scale(1.2);
        }

        .cover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 280px;
            background-size: cover;
            background-position: center;
            z-index: -1;
            clip-path: ellipse(100% 100% at 50% 0%);
        }

        .container {
            max-width: 500px;
            margin: 140px auto 40px;
            padding: 0 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-card {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            width: 100%;
        }

        .avt-box {
            width: 110px;
            height: 110px;
            margin: -95px auto 15px;
            position: relative;
        }

        .avt-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            object-fit: cover;
            background: white;
        }

        .btn-top {
            position: absolute;
            top: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            color: var(--text-light);
            transition: 0.2s;
            z-index: 10;
        }

        .btn-top:hover {
            transform: scale(1.1);
            color: var(--primary);
        }

        .btn-settings {
            right: 20px;
        }

        .btn-notifications {
            right: 70px;
        }

        .notif-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            background: var(--danger);
            border: 2px solid white;
            border-radius: 50%;
            display: none;
        }

        .user-name {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .user-handle {
            color: var(--primary);
            font-weight: 700;
            font-size: 14px;
            margin-top: 4px;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            padding: 15px 0;
            border-top: 1px solid rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-val {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
        }

        .section-box {
            text-align: left;
            margin-top: 25px;
        }

        .sec-title {
            font-size: 13px;
            font-weight: 800;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bio-box {
            padding: 15px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.6;
            color: #475569;
        }

        .topic-grid {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .topic-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 18px;
            background: white;
            text-decoration: none;
            color: inherit;
            transition: 0.2s;
            border: 1px solid #f1f5f9;
        }

        .topic-mini:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .tm-img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
        }

        .tm-info {
            flex: 1;
        }

        .tm-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .tm-meta {
            font-size: 11px;
            color: var(--text-light);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .box {
            background: white;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 28px;
            padding: 24px;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: 0.3s;
        }

        .modal.active .box {
            transform: translateY(0);
        }

        .close-x {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inp-group {
            margin-bottom: 15px;
        }

        .inp-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .inp {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
            background: #f8fafc;
        }

        .inp:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 132, 255, 0.1);
        }

        .btn-main {
            width: 100%;
            padding: 14px;
            background: var(--primary-grad);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 132, 255, 0.3);
        }

        .request-item {
            padding: 12px;
            border: 1px solid #f1f5f9;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .req-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-req {
            flex: 1;
            padding: 8px;
            border-radius: 10px;
            border: none;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-approve {
            background: var(--primary-light);
            color: var(--primary);
        }

        .btn-reject {
            background: #fee2e2;
            color: var(--danger);
        }

        .toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: 0.3s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div class="bg-cover" id="bgBlur"></div>
    <div class="cover-overlay" id="bgCover"></div>

    <style>
        .sk-pulse {
            background: #e2e8f0;
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .p-sk-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 24px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .sk-avt {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            margin-top: -80px;
            border: 5px solid white;
        }

        .sk-line {
            height: 20px;
            width: 60%;
            border-radius: 6px;
        }

        .sk-line.sm {
            height: 14px;
            width: 40%;
        }

        .sk-stats {
            display: flex;
            gap: 30px;
            margin: 10px 0;
        }

        .sk-stat {
            width: 60px;
            height: 40px;
            border-radius: 8px;
        }

        .tick {
            color: #3b82f6;
            margin-left: 6px;
            font-size: 18px;
            vertical-align: middle;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #64748b;
        }

        .upload-btn:hover {
            border-color: var(--primary);
            background: #f0f9ff;
            color: var(--primary);
        }

        .upload-btn i {
            font-size: 24px;
        }

        .upload-btn span {
            font-size: 12px;
            font-weight: 600;
        }
    </style>
    <div id="profileSkeleton" class="container">
        <div class="p-sk-card">
            <div class="sk-pulse sk-avt"></div>
            <div class="sk-pulse sk-line" style="width:50%; height:28px;"></div>
            <div class="sk-pulse sk-line sm"></div>
            <div class="sk-pulse sk-stats">
                <div class="sk-pulse sk-stat"></div>
            </div>
            <div style="width:100%; text-align:left; margin-top:20px;">
                <div class="sk-pulse sk-line" style="width:30%; margin-bottom:10px;"></div>
                <div class="sk-pulse sk-line" style="width:100%; height:80px; border-radius:15px;"></div>
            </div>
            <div style="width:100%; text-align:left; margin-top:20px;">
                <div class="sk-pulse sk-line" style="width:30%; margin-bottom:10px;"></div>
                <div class="sk-pulse sk-line" style="width:100%; height:60px; border-radius:18px; margin-bottom:10px;">
                </div>
                <div class="sk-pulse sk-line" style="width:100%; height:60px; border-radius:18px;"></div>
            </div>
        </div>
    </div>
    <div id="profileContent" class="container" style="display:none;">
        <div class="profile-card">
            <button class="btn-top" style="left:20px; right:auto;" onclick="history.back()">
                <i class='bx bx-arrow-back'></i>
            </button>
            <button id="btnNotif" class="btn-top btn-notifications"
                onclick="document.getElementById('modalNotif').classList.add('active')">
                <i class='bx bxs-bell'></i>
                <div id="notifBadge" class="notif-badge"></div>
            </button>
            <button id="btnSettings" class="btn-top btn-settings" style="display:none;">
                <i class='bx bxs-cog'></i>
            </button>

            <div class="avt-box">
                <img id="avt" src="https://via.placeholder.com/120" class="avt-img">
            </div>

            <h1 class="user-name" id="dName"></h1>
            <div class="user-handle" id="dUser"></div>

            <div class="stats-row">
                <div class="stat-item"><span class="stat-val" id="topicCount">0</span><span
                        class="stat-label">Topic</span></div>
            </div>

            <div class="section-box">
                <span class="sec-title"><i class='bx bxs-quote-left'></i> Ti·ªÉu s·ª≠</span>
                <div class="bio-box" id="dBio"></div>
            </div>

            <div class="section-box">
                <span class="sec-title"><i class='bx bxs-rocket'></i> Topic ƒë√£ t·∫°o</span>
                <div id="topicList" class="topic-grid"></div>
            </div>
        </div>
    </div>
    <div id="modalNotif" class="modal">
        <div class="box">
            <button class="close-x" onclick="this.closest('.modal').classList.remove('active')"><i
                    class='bx bx-x'></i></button>
            <h3 style="margin-bottom:20px; font-size:18px; font-weight:800;"> Th√¥ng b√°o</h3>
            <div id="reqList" style="max-height:400px; overflow-y:auto;">
                <p style="text-align:center; color:#64748b; font-size:14px; padding:20px;">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p>
            </div>
        </div>
    </div>
    <div id="modalConfirm" class="modal" style="z-index: 2500;">
        <div class="box" style="text-align:center; max-width:320px;">
            <div style="font-size:48px; margin-bottom:10px;"></div>
            <h3 style="margin-bottom:10px; font-size:18px;">B·∫°n ch·∫Øc ch·ª©?</h3>
            <p style="color:#64748b; margin-bottom:20px;" id="confirmMsg">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
            <div style="display:flex; gap:10px;">
                <button id="btnConfirmYes" class="btn-main" style="background:var(--danger);">ƒêƒÉng xu·∫•t</button>
                <button onclick="document.getElementById('modalConfirm').classList.remove('active')" class="btn-main"
                    style="background:#f1f5f9; color:#475569;">H·ªßy</button>
            </div>
        </div>
    </div>
    <div id="modalSettings" class="modal">
        <div class="box">
            <button class="close-x" onclick="this.closest('.modal').classList.remove('active')"><i
                    class='bx bx-x'></i></button>
            <h3 style="margin-bottom:24px; font-size:20px; font-weight:800; text-align:center;">C√†i ƒë·∫∑t h·ªì s∆° </h3>

            <div class="settings-grid">
                <label class="upload-btn">
                    <i class='bx bxs-camera'></i>
                    <span>ƒê·ªïi Avatar</span>
                    <input type="file" id="fAvtFile" hidden accept="image/*">
                </label>
                <label class="upload-btn">
                    <i class='bx bxs-image'></i>
                    <span>ƒê·ªïi ·∫¢nh b√¨a</span>
                    <input type="file" id="fCoverFile" hidden accept="image/*">
                </label>
            </div>

            <div class="inp-group">
                <label class="inp-label">Username <span style="color:red; margin-left:4px;">*</span></label>
                <div style="position:relative;">
                    <i class='bx bx-at' style="position:absolute; left:14px; top:12px; color:#94a3b8;"></i>
                    <input type="text" id="inpUser" class="inp" placeholder="username" style="padding-left:36px;">
                </div>
            </div>

            <div class="inp-group">
                <label class="inp-label">T√™n hi·ªÉn th·ªã <span style="color:red; margin-left:4px;">*</span></label>
                <input type="text" id="inpName" class="inp" placeholder="T√™n c·ªßa b·∫°n">
            </div>

            <div class="inp-group">
                <label class="inp-label">Ti·ªÉu s·ª≠</label>
                <textarea id="inpBio" class="inp" rows="3" style="resize:none"
                    placeholder="H√£y n√≥i g√¨ ƒë√≥ v·ªÅ b·∫°n..."></textarea>
            </div>

            <button id="btnVerifyRequest" onclick="document.getElementById('modalVerify').classList.add('active')"
                style="width:100%; padding:12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:14px; color:#0284c7; font-weight:700; cursor:pointer; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <i class='bx bxs-check-circle'></i> ƒêƒÉng k√Ω t√≠ch xanh
            </button>

            <button id="btnSave" class="btn-main">L∆∞u thay ƒë·ªïi</button>

            <div id="googleLinkSection"
                style="display:none; margin-top:16px; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden;">
                <button onclick="toggleGuestSection()"
                    style="width:100%; padding:14px 16px; background:#fafafa; border:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:14px;">
                    <span> T·∫°o t√†i kho·∫£n t·ª´ t∆∞ c√°ch kh√°ch</span>
                    <span id="guestSectionArrow" style="transition:.2s; font-size:12px;">&#9660;</span>
                </button>
                <div id="guestSectionBody" style="display:none; padding:16px; border-top:1px solid #f1f5f9;">
                    <div style="font-size:12px; color:#64748b; margin-bottom:12px;">B·∫°n ƒëang d√πng t∆∞ c√°ch kh√°ch. ƒê·∫∑t
                        email & m·∫≠t kh·∫©u ƒë·ªÉ l∆∞u t√†i kho·∫£n vƒ©nh vi·ªÖn!</div>
                    <div class="inp-group">
                        <label class="inp-label">Gmail m·ªõi (t√πy ch·ªçn)</label>
                        <input type="email" id="linkEmail" class="inp" placeholder="email@gmail.com">
                    </div>
                    <div class="inp-group">
                        <label class="inp-label">M·∫≠t kh·∫©u m·ªõi <span style="color:red">*</span></label>
                        <input type="password" id="linkPass" class="inp" placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
                    </div>
                    <div class="inp-group">
                        <label class="inp-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u <span style="color:red">*</span></label>
                        <input type="password" id="linkPassConfirm" class="inp" placeholder="Nh·∫≠p l·∫°i">
                    </div>
                    <button onclick="saveLinkEmailPass()"
                        style="width:100%; padding:12px; background:#2563eb; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; font-size:14px;">L∆∞u
                        t√†i kho·∫£n</button>
                </div>
            </div>

            <button id="btnLogout"
                style="width:100%; padding:12px; background:rgba(239, 68, 68, 0.1); border-radius:14px; border:none; color:var(--danger); font-weight:700; cursor:pointer; margin-top:12px; transition:0.2s;">
                <i class='bx bx-log-out'></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>
    <div id="modalAnonLogout" class="modal" style="z-index:9999;">
        <div class="box" style="text-align:center; max-width:340px;">
            <div style="font-size:48px; margin-bottom:10px;">Ô∏è</div>
            <h3 style="margin-bottom:10px; font-size:18px; font-weight:800;">Ch∆∞a l∆∞u t√†i kho·∫£n!</h3>
            <p style="color:#64748b; margin-bottom:20px; font-size:14px; line-height:1.6;">B·∫°n ƒëang d√πng <b>t∆∞ c√°ch
                    kh√°ch</b>. N·∫øu ƒëƒÉng xu·∫•t b√¢y gi·ªù, <b style="color:#ef4444;">t√†i kho·∫£n v√† d·ªØ li·ªáu s·∫Ω m·∫•t vƒ©nh
                    vi·ªÖn!</b><br><br>H√£y t·∫°o t√†i kho·∫£n tr∆∞·ªõc ƒë·ªÉ gi·ªØ l·∫°i m·ªçi th·ª©.</p>
            <button onclick="openGuestSectionAndClose()" class="btn-main" style="margin-bottom:10px;">L∆∞u t√†i kho·∫£n
                ngay</button>
            <button onclick="forceLogout()" class="btn-main" style="background:rgba(239,68,68,0.1); color:#ef4444;">V·∫´n
                ƒëƒÉng xu·∫•t (m·∫•t d·ªØ li·ªáu)</button>
        </div>
    </div>

    <div id="modalVerify" class="modal">
        <div class="box" style="text-align:center;">
            <div style="font-size:48px; margin-bottom:10px;"></div>
            <h3 style="margin-bottom:10px; font-size:18px;">ƒêƒÉng k√Ω Verified</h3>
            <div style="text-align:left; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:4px; display:block;">T√™n ƒë·∫ßy
                    ƒë·ªß (Gi·ªØ t√™n)</label>
                <input type="text" id="reqName" class="inp" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A"
                    style="width:100%; border:1px solid #e2e8f0; padding:10px; border-radius:10px; margin-bottom:10px;">

                <label style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:4px; display:block;">L√Ω do
                    c·∫•p tick xanh</label>
                <textarea id="reqReason" class="inp" placeholder="V√¨ sao b·∫°n x·ª©ng ƒë√°ng?" rows="3"
                    style="width:100%; border:1px solid #e2e8f0; padding:10px; border-radius:10px;"></textarea>
            </div>
            <button id="btnReqVerify" class="btn-main" onclick="reqVerify()">G·ª≠i ƒë∆°n ƒëƒÉng k√Ω</button>
            <button id="btnCloseVerify" onclick="document.getElementById('modalVerify').classList.remove('active')"
                class="btn-main" style="background:#f1f5f9; color:#475569; margin-top:10px;">ƒê√≥ng</button>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, EmailAuthProvider, linkWithCredential, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs, onSnapshot, updateDoc, arrayUnion, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyBPEMno1uZFg4uVXZjz-PbBR37gH6-3t5Y", authDomain: "confe-web.firebaseapp.com", projectId: "confe-web", storageBucket: "confe-web.firebasestorage.app", messagingSenderId: "677778119372", appId: "1:677778119372:web:ee3f1132871332743b0069" };
        const IMG_KEY = "e6c2724ff8344c073410da4876c3d35f";
        const app = initializeApp(cfg); const db = getFirestore(app); const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        let targetUid = urlParams.get('uid') || urlParams.get('id');
        let currentUser = null, userData = null;

        window.showToast = (m) => {
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = m;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
        }

        onAuthStateChanged(auth, async (u) => {
            currentUser = u;
            if (!targetUid && u) targetUid = u.uid;
            if (targetUid) {
                loadProfile(targetUid);
                if (u && u.uid === targetUid) listenToRequests(u.email);

                // Show link section only for anonymous users
                if (u && u.uid === targetUid && u.isAnonymous) {
                    document.getElementById('googleLinkSection').style.display = 'block';
                }
            } else { location.href = 'login.html'; }
        });

        window.saveLinkEmailPass = async () => {
            const emailVal = document.getElementById('linkEmail').value.trim();
            const passVal = document.getElementById('linkPass').value;
            const passConfirm = document.getElementById('linkPassConfirm').value;
            if (!passVal) return showToast('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!');
            if (passVal !== passConfirm) return showToast('M·∫≠t kh·∫©u kh√¥ng kh·ªõp!');
            if (passVal.length < 6) return showToast('M·∫≠t kh·∫©u √≠t nh·∫•t 6 k√Ω t·ª±!');
            try {
                const u = auth.currentUser;
                const emailToUse = emailVal || u.email;
                const credential = EmailAuthProvider.credential(emailToUse, passVal);
                await linkWithCredential(u, credential);
                // Update email if different
                if (emailVal && emailVal !== u.email) {
                    await updateEmail(u, emailVal);
                    await updateDoc(doc(db, 'users', u.uid), { email: emailVal });
                }
                showToast('Li√™n k·∫øt th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p b·∫±ng email & m·∫≠t kh·∫©u.');
                document.getElementById('googleLinkSection').style.display = 'none';
            } catch (err) {
                if (err.code === 'auth/provider-already-linked') showToast('ƒê√£ li√™n k·∫øt r·ªìi!');
                else showToast('L·ªói: ' + err.message);
            }
        }

        let isSetupRequired = false;

        window.closeSettings = () => {
            if (isSetupRequired) return showToast("Vui l√≤ng ho√†n t·∫•t h·ªì s∆° tr∆∞·ªõc!", "Ô∏è");
            document.getElementById('modalSettings').classList.remove('active');
        }

        async function loadProfile(uid) {
            const snap = await getDoc(doc(db, "users", uid));
            if (snap.exists()) {
                userData = snap.data(); renderUI(userData, uid);

                // CHECK SETUP
                if (currentUser && currentUser.uid === uid && (userData.displayName === "C∆∞ d√¢n m·ªõi" || userData.displayName === "Ng∆∞·ªùi d√πng m·ªõi")) {
                    isSetupRequired = true;
                    document.getElementById('modalSettings').classList.add('active');
                    // Fill data if exists
                    document.getElementById('inpName').value = (userData.displayName === "C∆∞ d√¢n m·ªõi" || userData.displayName === "Ng∆∞·ªùi d√πng m·ªõi") ? "" : (userData.displayName || "");
                    document.getElementById('inpUser').value = userData.username || "";
                }

                if (userData.email) loadTopics(userData.email);
            } else if (currentUser && currentUser.uid === uid) {
                // New user without doc (should not happen if registration works, but fallback)
                userData = { displayName: "C∆∞ d√¢n m·ªõi", bio: "", photoURL: "", coverURL: "", email: currentUser.email, username: "", is_setup: false };
                renderUI(userData, uid);
                isSetupRequired = true;
                document.getElementById('btnSettings').click();

            }
        }

        // ... existing renderUI ...

        // LISTENER/HANDLERS
        document.getElementById('btnSave').onclick = async function () {
            try {
                this.textContent = "ƒêang l∆∞u..."; this.disabled = true;

                // DATA CHECK
                if (!userData) throw new Error("D·ªØ li·ªáu ch∆∞a t·∫£i xong. Vui l√≤ng th·ª≠ l·∫°i.");

                // VALIDATION
                const inpName = document.getElementById('inpName').value.trim();
                const inpUser = document.getElementById('inpUser').value.trim();
                const inpBio = document.getElementById('inpBio').value;

                if (!inpName) throw new Error("T√™n hi·ªÉn th·ªã kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
                if (!inpUser) throw new Error("Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");

                // COOLDOWN CHECK
                const now = Date.now();
                const ONE_DAY = 86400000;

                // USERNAME (30 DAYS)
                if (userData.username && inpUser !== userData.username) {
                    const lastChange = userData.lastUserChange?.toMillis() || 0;
                    if (now - lastChange < 30 * ONE_DAY) {
                        const daysLeft = Math.ceil((30 * ONE_DAY - (now - lastChange)) / ONE_DAY);
                        throw new Error(`B·∫°n ch·ªâ ƒë∆∞·ª£c ƒë·ªïi Username sau ${daysLeft} ng√†y n·ªØa!`);
                    }
                }

                // DISPLAY NAME (7 DAYS)
                if (userData.displayName && inpName !== userData.displayName) {
                    const lastChange = userData.lastNameChange?.toMillis() || 0;
                    if (now - lastChange < 7 * ONE_DAY) {
                        const daysLeft = Math.ceil((7 * ONE_DAY - (now - lastChange)) / ONE_DAY);
                        throw new Error(`B·∫°n ch·ªâ ƒë∆∞·ª£c ƒë·ªïi T√™n sau ${daysLeft} ng√†y n·ªØa!`);
                    }
                }

                let nAvt = userData?.photoURL || "", nCov = userData?.coverURL || "";
                if (document.getElementById('fAvtFile').files[0]) nAvt = await upload(document.getElementById('fAvtFile').files[0]);
                if (document.getElementById('fCoverFile').files[0]) nCov = await upload(document.getElementById('fCoverFile').files[0]);

                const updateData = {
                    displayName: inpName,
                    username: inpUser,
                    bio: inpBio,
                    photoURL: nAvt, coverURL: nCov, lastUpdated: serverTimestamp(),
                    is_setup: true
                };

                if (inpUser !== userData.username) updateData.lastUserChange = serverTimestamp();
                if (inpName !== userData.displayName) updateData.lastNameChange = serverTimestamp();

                console.log("Updating user:", updateData);
                await updateDoc(doc(db, "users", currentUser.uid), updateData);

                document.getElementById('btnSave').textContent = "L∆∞u thay ƒë·ªïi";
                document.getElementById('btnSave').disabled = false;

                isSetupRequired = false;
                window.showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                setTimeout(() => window.top.location.reload(), 500);

            } catch (e) {
                console.error(e);
                let msg = e.message;
                if (msg.includes("requires an index")) msg = "H·ªá th·ªëng ƒëang t·∫°o index, th·ª≠ l·∫°i sau.";
                window.showToast("L·ªói: " + msg, "");
                document.getElementById('btnSave').textContent = "L∆∞u thay ƒë·ªïi";
                document.getElementById('btnSave').disabled = false;
            }
        }

        // GLOBAL FILE INPUT TOAST
        document.body.addEventListener('change', (e) => {
            if (e.target.type === 'file' && e.target.files[0]) {
                const f = e.target.files[0];
                window.showToast(` ƒê√£ ch·ªçn: ${f.name.length > 20 ? f.name.slice(0, 15) + "..." : f.name}`);
            }
        });

        document.getElementById('btnLogout').onclick = () => {
            if (auth.currentUser?.isAnonymous) {
                document.getElementById('modalAnonLogout').classList.add('active');
            } else {
                document.getElementById('modalConfirm').classList.add('active');
            }
        }

        document.getElementById('btnConfirmYes').onclick = () => {
            signOut(auth).then(() => window.top.location.href = 'index.html');
        }

        window.toggleGuestSection = () => {
            const body = document.getElementById('guestSectionBody');
            const arrow = document.getElementById('guestSectionArrow');
            const open = body.style.display === 'block';
            body.style.display = open ? 'none' : 'block';
            arrow.style.transform = open ? '' : 'rotate(180deg)';
        }

        window.openGuestSectionAndClose = () => {
            document.getElementById('modalAnonLogout').classList.remove('active');
            document.getElementById('modalSettings').classList.add('active');
            // Auto-open the accordion
            setTimeout(() => {
                const body = document.getElementById('guestSectionBody');
                const arrow = document.getElementById('guestSectionArrow');
                if (body.style.display !== 'block') {
                    body.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                }
            }, 200);
        }

        window.forceLogout = () => {
            document.getElementById('modalAnonLogout').classList.remove('active');
            signOut(auth).then(() => window.top.location.href = 'index.html');
        }
        function renderUI(data, uid) {
            document.getElementById('profileSkeleton').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            document.getElementById('dName').innerHTML = (data.displayName || "C∆∞ d√¢n Hub") + (data.isVerified ? ' <i class="bx bxs-check-circle tick"></i>' : '');
            document.getElementById('dUser').textContent = "@" + (data.username || (data.email ? data.email.split('@')[0] : uid.slice(0, 8)));
            document.getElementById('dBio').textContent = data.bio || "Ng∆∞·ªùi d√πng n√†y ch∆∞a vi·∫øt g√¨.";
            document.getElementById('avt').src = data.photoURL || `https://ui-avatars.com/api/?name=${data.displayName || 'U'}&background=random`;
            const bgUrl = data.coverURL || "https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=1000";
            document.getElementById('bgBlur').style.backgroundImage = `url('${bgUrl}')`;
            document.getElementById('bgCover').style.backgroundImage = `url('${bgUrl}')`;

            if (currentUser && currentUser.uid === uid) {
                const btn = document.getElementById('btnSettings');
                btn.style.display = 'flex';
                btn.onclick = () => {
                    document.getElementById('inpName').value = data.displayName || "";
                    document.getElementById('inpBio').value = data.bio || "";
                    document.getElementById('inpUser').value = data.username || "";

                    // Hide verification button if already verified
                    const verifyBtn = document.getElementById('btnVerifyRequest');
                    if (data.isVerified) {
                        verifyBtn.style.display = 'none';
                    } else {
                        verifyBtn.style.display = 'flex';
                    }

                    document.getElementById('modalSettings').classList.add('active');
                };
            }

            // Calc Online Days (Mock)
            if (currentUser && currentUser.uid === uid) {
                // Determine days based on account age for now? Or just mock 30 for testing?
                // Let's check creationTime -> but that's auth metadata.
                // We'll use a random number or check `userData.createdAt`.
                // For demo/testing: If created > 1 day, assume 30 days.
                const created = (userData.createdAt && typeof userData.createdAt.toDate === 'function') ? userData.createdAt.toDate().getTime() : Date.now();
                const days = Math.floor((Date.now() - created) / (86400000)) + 1; // +1 to count today
                // Mock 30 if > 0 for now as requested "if enough 30 days show button"
                const daysMock = (days > 0) ? 30 : days;

                // Hide verification button in modal if already verified (initial load)
                const verifyBtn = document.getElementById('btnVerifyRequest');
                if (verifyBtn && !userData.isVerified) {
                    verifyBtn.style.display = 'flex';
                } else if (verifyBtn) {
                    verifyBtn.style.display = 'none';
                }
            }

            // Hide Notif if visitor, but show action buttons
            if (currentUser && currentUser.uid !== uid) {
                document.getElementById('btnNotif').style.display = 'none';

                // Show Friend Actions
                const actionContainer = document.getElementById('actionContainer');
                if (actionContainer) {
                    actionContainer.style.display = 'flex';
                    const addFriendBtn = document.getElementById('addFriendBtn');
                    const messageBtn = document.getElementById('messageBtn');

                    messageBtn.onclick = () => { window.location.href = `chatv2.html?chat=${uid}`; };

                    addFriendBtn.textContent = 'ƒêang t·∫£i...';
                    addFriendBtn.disabled = true;

                    // Fetch my friends array
                    getDoc(doc(db, 'users', currentUser.uid)).then(meSnap => {
                        const myFriends = meSnap.data()?.friends || [];
                        if (myFriends.includes(uid)) {
                            addFriendBtn.textContent = 'B·∫°n b√®';
                            addFriendBtn.style.background = '#e2e8f0';
                            addFriendBtn.style.color = '#475569';
                            addFriendBtn.disabled = true;
                        } else {
                            const qSent = query(collection(db, 'friend_requests'), where('from_uid', '==', currentUser.uid), where('to_uid', '==', uid), where('status', '==', 'pending'));
                            const qReceived = query(collection(db, 'friend_requests'), where('from_uid', '==', uid), where('to_uid', '==', currentUser.uid), where('status', '==', 'pending'));

                            Promise.all([getDocs(qSent), getDocs(qReceived)]).then(([sentSnap, receivedSnap]) => {
                                if (!sentSnap.empty) {
                                    addFriendBtn.textContent = 'ƒê√£ g·ª≠i l·ªùi m·ªùi';
                                    addFriendBtn.style.background = '#e2e8f0';
                                    addFriendBtn.style.color = '#475569';
                                    addFriendBtn.disabled = true;
                                } else if (!receivedSnap.empty) {
                                    addFriendBtn.textContent = 'Ch·∫•p nh·∫≠n';
                                    addFriendBtn.disabled = false;
                                    addFriendBtn.onclick = async () => {
                                        addFriendBtn.disabled = true; addFriendBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                                        try {
                                            const reqId = receivedSnap.docs[0].id;
                                            await updateDoc(doc(db, 'friend_requests', reqId), { status: 'accepted' });
                                            await updateDoc(doc(db, 'users', currentUser.uid), { friends: arrayUnion(uid) });
                                            await updateDoc(doc(db, 'users', uid), { friends: arrayUnion(currentUser.uid) });

                                            addFriendBtn.textContent = 'B·∫°n b√®';
                                            addFriendBtn.style.background = '#e2e8f0';
                                            addFriendBtn.style.color = '#475569';
                                            window.showToast('ƒê√£ k·∫øt b·∫°n!', 'success');
                                        } catch (e) {
                                            window.showToast("L·ªói: " + e.message, "error");
                                            addFriendBtn.disabled = false; addFriendBtn.textContent = 'Ch·∫•p nh·∫≠n';
                                        }
                                    };
                                } else {
                                    addFriendBtn.textContent = 'K·∫øt b·∫°n';
                                    addFriendBtn.disabled = false;
                                    addFriendBtn.onclick = async () => {
                                        addFriendBtn.disabled = true; addFriendBtn.textContent = 'ƒêang g·ª≠i...';
                                        try {
                                            await addDoc(collection(db, 'friend_requests'), {
                                                from_uid: currentUser.uid,
                                                to_uid: uid,
                                                status: 'pending',
                                                timestamp: serverTimestamp()
                                            });
                                            addFriendBtn.textContent = 'ƒê√£ g·ª≠i l·ªùi m·ªùi';
                                            addFriendBtn.style.background = '#e2e8f0';
                                            addFriendBtn.style.color = '#475569';
                                            window.showToast('ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
                                        } catch (e) {
                                            window.showToast("L·ªói: " + e.message, "error");
                                            addFriendBtn.disabled = false; addFriendBtn.textContent = 'K·∫øt b·∫°n';
                                        }
                                    };
                                }
                            });
                        }
                    });
                }
            } else {
                document.getElementById('btnNotif').style.display = 'flex';
                if (document.getElementById('actionContainer')) document.getElementById('actionContainer').style.display = 'none';
            }
        }

        async function loadTopics(email) {
            const list = document.getElementById('topicList');
            try {
                const q = query(collection(db, "topics"), where("owner", "==", email));
                const snap = await getDocs(q);
                const isOwner = currentUser && currentUser.email === email;
                document.getElementById('topicCount').textContent = snap.size;
                if (snap.empty) { list.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:12px;">${isOwner ? 'B·∫°n' : 'Ng∆∞·ªùi d√πng n√†y'} ch∆∞a t·∫°o topic n√†o.</p>`; return; }
                list.innerHTML = "";
                snap.forEach(d => {
                    const t = d.data();
                    // Hide content if topic is private AND viewer is not the owner
                    const isPrivate = !isOwner && t.protectResource && (t.securityMode === 'otp' || t.securityMode === 'whitelist');
                    const displayTitle = isPrivate ? 'üîí Topic ri√™ng t∆∞' : (t.title || 'Kh√¥ng t√™n');
                    const displayBanner = isPrivate ? 'https://placehold.co/50/e2e8f0/64748b?text=?' : (t.banner || 'https://via.placeholder.com/50');
                    list.innerHTML += `
                        <a href="detail.html?tid=${d.id}" class="topic-mini">
                            <img src="${displayBanner}" class="tm-img" style="${isPrivate ? 'filter:blur(4px);' : ''}">
                            <div class="tm-info">
                                <div class="tm-title">${displayTitle}</div>
                                <div class="tm-meta">${isPrivate ? 'üîê N·ªôi dung ƒë∆∞·ª£c b·∫£o v·ªá' : `üî• ${t.heat || 0} l∆∞·ª£t nhi·ªát ‚Ä¢ ${t.category || 'Chung'}`}</div>
                            </div>
                            <i class='bx bx-chevron-right' style="color:#cbd5e1"></i>
                        </a>`;
                });
            } catch { list.innerHTML = "<p>L·ªói t·∫£i danh s√°ch.</p>"; }
        }

        function listenToRequests(email) {
            const q = query(collection(db, "requests"), where("ownerEmail", "==", email), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('reqList');
                const badge = document.getElementById('notifBadge');
                if (snap.empty) {
                    list.innerHTML = `<p style="text-align:center; color:#64748b; font-size:14px; padding:20px;">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p>`;
                    badge.style.display = 'none';
                    return;
                }
                badge.style.display = 'block';
                list.innerHTML = "";
                snap.forEach(d => {
                    const r = d.data();
                    const item = document.createElement('div');
                    item.className = 'request-item';
                    item.innerHTML = `
                        <div style="font-weight:700; font-size:14px;">${r.tTitle}</div>
                        <div style="font-size:13px; color:#64748b; margin:4px 0;"> <b>${r.userName}</b> xin tham gia</div>
                        <div class="req-actions">
                            <button class="btn-req btn-approve">Duy·ªát</button>
                            <button class="btn-req btn-reject">T·ª´ ch·ªëi</button>
                        </div>`;
                    item.querySelector('.btn-approve').onclick = () => handleReq(d.id, r.tid, r.userName, r.deviceId, true);
                    item.querySelector('.btn-reject').onclick = () => handleReq(d.id, r.tid, r.userName, r.deviceId, false);
                    list.appendChild(item);
                });
            });
        }

        async function handleReq(rid, tid, name, devId, isApprove) {
            try {
                if (isApprove) {
                    await updateDoc(doc(db, "topics", tid), { whitelist: arrayUnion({ name, deviceId: devId }) });
                    await updateDoc(doc(db, "requests", rid), { status: 'approved' });
                } else {
                    await updateDoc(doc(db, "requests", rid), { status: 'rejected' });
                }
                window.showToast(isApprove ? "ƒê√£ duy·ªát!" : "ƒê√£ t·ª´ ch·ªëi.");
            } catch (e) { window.showToast("L·ªói x·ª≠ l√Ω."); }
        }

        async function upload(f) { const d = new FormData(); d.append("image", f); try { return (await (await fetch(`https://api.imgbb.com/1/upload?key=${IMG_KEY}`, { method: "POST", body: d })).json()).data.url; } catch { return ""; } }

        // Removed Duplicate Handler


        window.reqVerify = async () => {
            if (auth.currentUser?.isAnonymous) {
                window.showToast('T∆∞ c√°ch kh√°ch kh√¥ng th·ªÉ ƒëƒÉng k√Ω tick xanh! H√£y t·∫°o t√†i kho·∫£n tr∆∞·ªõc.', 'Ô∏è');
                document.getElementById('modalVerify').classList.remove('active');
                return;
            }
            const name = document.getElementById('reqName').value.trim();
            const reason = document.getElementById('reqReason').value.trim();
            if (!name || !reason) return window.showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!", "Ô∏è");

            document.getElementById('btnReqVerify').textContent = "ƒêang g·ª≠i...";
            try {
                await addDoc(collection(db, "requests"), {
                    type: 'verify',
                    uid: currentUser.uid,
                    realName: name,
                    reason: reason,
                    currentDisplayName: userData.displayName,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                window.showToast("ƒê√£ g·ª≠i ƒë∆°n ƒëƒÉng k√Ω!");
                document.getElementById('modalVerify').classList.remove('active');
            } catch (e) { window.showToast("L·ªói g·ª≠i request."); }
            document.getElementById('btnReqVerify').textContent = "G·ª≠i ƒë∆°n ƒëƒÉng k√Ω";
        }

    </script>
</body>

</html>